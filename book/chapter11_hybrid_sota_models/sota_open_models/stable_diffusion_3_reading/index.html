<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../stable_diffusion_xl/">
      
      
        <link rel="next" href="../stable_diffusion_3_5_reading/">
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>SD3 Scaling Rectified Flow Transformers for High-Resolution Image Synthesis - Generative AI: From Start to Surrender</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sd3-scaling-rectified-flow-transformers-for-high-resolution-image-synthesis" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Generative AI: From Start to Surrender" class="md-header__button md-logo" aria-label="Generative AI: From Start to Surrender" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Generative AI: From Start to Surrender
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SD3 Scaling Rectified Flow Transformers for High-Resolution Image Synthesis
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo" aria-label="Switch to system preference" type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter1_Introduction/1.1terminology/" class="md-tabs__link">
          
  
  
    
  
  Introduction

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter2_generation_theory/mle/" class="md-tabs__link">
          
  
  
    
  
  Generation Theory

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter3_energy_based_model/introduction/" class="md-tabs__link">
          
  
  
    
  
  Energy Based Models

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter6_VAE/vae_introduction/" class="md-tabs__link">
          
  
  
    
  
  VAE

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter5_GAN/3.1from_gan_to_stylegan/paper/" class="md-tabs__link">
          
  
  
    
  
  GANs

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter7_diffusion/ddpm/" class="md-tabs__link">
          
  
  
    
  
  Diffusion Models

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter9_flow_matching/introduction/" class="md-tabs__link">
          
  
  
    
  
  Flow Matching

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../hybrid_methods/" class="md-tabs__link">
          
  
  
    
  
  Hybrid SOTA Models

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter12_applications/diffusion_anomaly_detection/" class="md-tabs__link">
          
  
  
    
  
  Application

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Generative AI: From Start to Surrender" class="md-nav__button md-logo" aria-label="Generative AI: From Start to Surrender" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    Generative AI: From Start to Surrender
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Introduction
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.1terminology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terms
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.2fourier_transform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fourier Transform
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.3signal_processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Signal Processing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.4statistics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Statistics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Generation Theory
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Generation Theory
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter2_generation_theory/mle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Maximal Likelihood
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter2_generation_theory/manifold_hypothesis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Manifold Hypothesis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter2_generation_theory/generative_model_category/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Generative Model Category
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4">
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Energy Based Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Energy Based Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/score_function/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Score Functions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/sampling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sampling Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/cd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contrastive Divergence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/score_matching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Score Matching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5">
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    VAE
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    VAE
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter6_VAE/vae_introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter6_VAE/vq_vae/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VA-VAE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6">
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    GANs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    GANs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.1from_gan_to_stylegan/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    From GAN to StyleGAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_2">
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN Variants
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    StyleGAN Variants
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.3stylegan/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.4stylegan2/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.5stylegan3/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.6styleganT/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN-T
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.7R3Gan/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    R3GAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/vq_gan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VQ-GAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7">
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diffusion Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1">
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Discrete Diffusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Discrete Diffusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/ddpm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DDPM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/ldm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LDM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/ldm_handson/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LDM Handson
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/diffusion_model_varients/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Model Varients
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/general_diffusion_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    General Diffusion Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_2">
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    SDE Diffusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    SDE Diffusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/introduction_sde/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE Fundamentals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/from_ddpm_2_sde/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE for DDPM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/score_based_sde/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Score Based SDE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/probability_flow_ode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Probability Flow ODE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/sde_diffusion_speedup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE Diffusion Speedup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/sde_diffusion_unified_representation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scaling and Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_3">
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Network
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diffusion Network
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/DiT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DiT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_4">
        
          
          <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Solver
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diffusion Solver
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/diffusion_solver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DPM Solver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_5">
        
          
          <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Conditional Diffusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Conditional Diffusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/controlnet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ControlNet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/sde_diffusion_guidance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE Diffusion Guidance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8">
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Flow Matching
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Flow Matching
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/probability_with_velocity_field/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Probability Path and Velocity Fields
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/flow_matching_theory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flow Matching Theorem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/affine_conditional_flows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Affine Conditional Flow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/optimal_transport_flow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Optimal Transport Flow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/comparison_with_flow_ode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comparison with Diffusion Flow ODE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Hybrid SOTA Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Hybrid SOTA Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hybrid_methods/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sota_closed_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Closed Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3" checked>
        
          
          <label class="md-nav__link" for="__nav_9_3" id="__nav_9_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Open Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Open Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dalle_series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dalle Series
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_9_3_2" id="__nav_9_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion Series
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Stable Diffusion Series
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stable_diffusion_series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stable_diffusion_xl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion XL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion 3
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion 3
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-abstract" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Abstract
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-preliminary" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Preliminary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-network-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Network Structure
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Network Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-vae" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 VAE
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-observations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Observations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-patchify" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Patchify
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-timeembedding" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 TimeEmbedding
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-mm-dit" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 MM-DiT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-sd3-inference-methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5 SD3 Inference Methods
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-references" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. References
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stable_diffusion_3_5_reading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion 3.5
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9_3_3">
        
          
          <label class="md-nav__link" for="__nav_9_3_3" id="__nav_9_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Flux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Flux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flux1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flux.1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flux.1_kontext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flux.1 Kontext
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../qwen_image/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Qwen-Image
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trends_future/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Future Trends
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10">
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Application
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Application
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_1">
        
          
          <label class="md-nav__link" for="__nav_10_1" id="__nav_10_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Anomaly Detection
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Anomaly Detection
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/diffusion_anomaly_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Anomaly Detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_2">
        
          
          <label class="md-nav__link" for="__nav_10_2" id="__nav_10_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Deepfake Detection
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Deepfake Detection
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection_structured/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/FOCAL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FOCAL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/PSCC-Net/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PSCC-Net
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/DeCLIP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DeCLIP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/FakeLocator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FakeLocator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/Weakly-supervised-Deepfake-Localization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Weakly-supervised Deepfake Localization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/FSBI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FSBI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/DE-FAKE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DE-FAKE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/DADF/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DADF
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/SIDA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SIDA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/UnivCLIP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UnivCLIP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/Multi-Attention-Based-Approach/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Attention-Based-Approach
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/Mastering-Deepfake-Detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mastering-Deepfake-Detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/Leveraging-Frequency-Analysis-for-Deep-Fake-Image-Recognition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Leveraging-Frequency-Analysis-for-Deep-Fake-Image-Recognition
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/An-Analysis-of-Recent-Advances-in-Deepfake-Image-Detection-in-an-Evolving-Threat-Landscape/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    An-Analysis-of-Recent-Advances-in-Deepfake-Image-Detection-in-an-Evolving-Threat-Landscape
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="sd3-scaling-rectified-flow-transformers-for-high-resolution-image-synthesis">[SD3] Scaling Rectified Flow Transformers for High-Resolution Image Synthesis<a class="headerlink" href="#sd3-scaling-rectified-flow-transformers-for-high-resolution-image-synthesis" title="Permanent link"></a></h1>
<blockquote>
<p><a href="https://arxiv.org/pdf/2403.03206">Paper: Scaling Rectified Flow Transformers for High-Resolution Image Synthesis
</a></p>
</blockquote>
<p>Before reading this paper, we suggest reader to undertand the flow matching chapter first.</p>
<h2 id="1-abstract">1. Abstract<a class="headerlink" href="#1-abstract" title="Permanent link"></a></h2>
<ul>
<li>Establish the practic for the rectified flow</li>
</ul>
<h2 id="2-introduction">2. Introduction<a class="headerlink" href="#2-introduction" title="Permanent link"></a></h2>
<ul>
<li>
<p>The forward path from data to noise is important in efficient training</p>
</li>
<li>
<p>Fails to remove all noise from the data (? now understand what this meaning)</p>
</li>
<li>affect sampling efficiency</li>
<li>curved paths required more integration steps</li>
<li>straight path has less error accumulations</li>
<li>No large size experiments for class conditional rectified flow models</li>
<li>
<p>Introduce <strong>re-weighting of the noise scales</strong> in rectified flow models</p>
</li>
<li>
<p>Text representation fussion</p>
</li>
<li>claim that text representation fed into model directly is not <strong>ideal</strong></li>
<li>Introduce <strong>new architecture</strong> for information flow between text and image</li>
</ul>
<h2 id="3-preliminary">3. Preliminary<a class="headerlink" href="#3-preliminary" title="Permanent link"></a></h2>
<ul>
<li>Refer <a href="../../../chapter7_diffusion/DiT/">Diffusion Transformer</a> for the details of DiT model</li>
</ul>
<blockquote>
<p>This section revisted the flow matching scheme</p>
</blockquote>
<h2 id="4-network-structure">4. Network Structure<a class="headerlink" href="#4-network-structure" title="Permanent link"></a></h2>
<h3 id="41-vae">4.1 VAE<a class="headerlink" href="#41-vae" title="Permanent link"></a></h3>
<p>In the previous stable diffusion models, the VAE transform the original image of shape</p>
<div class="arithmatex">\[ [H,W,3] \longrightarrow [\frac{H}{8},\frac{W}{8},d], \quad d=4\]</div>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-80.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-80.png"></a>
Increase <span class="arithmatex">\(d\)</span> can improve the performance as described in the above table.</p>
<p>Let consider the details of the SDVAE carefully</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:5"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio"><input id="__tabbed_1_2" name="__tabbed_1" type="radio"><input id="__tabbed_1_3" name="__tabbed_1" type="radio"><input id="__tabbed_1_4" name="__tabbed_1" type="radio"><input id="__tabbed_1_5" name="__tabbed_1" type="radio"><div class="tabbed-labels"><label for="__tabbed_1_1">SDVAE</label><label for="__tabbed_1_2">VAEEncoder</label><label for="__tabbed_1_3">VAEDecoder</label><label for="__tabbed_1_4">AttnBlock</label><label for="__tabbed_1_5">resnet block</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">SDVAE</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SDVAE</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="k">def</span><span class="w"> </span><span class="o">**</span><span class="n">init</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.**</span><span class="n">init</span><span class="o">**</span><span class="p">()</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">VAEEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">VAEDecoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="s2">"cuda"</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latent</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">latent</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="s2">"cuda"</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">logvar</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">logvar</span><span class="p">,</span> <span class="o">-</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">logvar</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="k">return</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">std</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p>encoder predicted the mean and log variance.   And then saples by reparametrization.
The encoder outputs a hidden representation, which is then split into a <strong>mean</strong> (<span class="arithmatex">\(\mu\)</span>) and <strong>log-variance</strong> (<span class="arithmatex">\(\log \sigma^2\)</span>):</p>
<div class="arithmatex">\[
h = \text{Encoder}(x)
\]</div>
<div class="arithmatex">\[
\mu, \log\sigma^2 = \text{split}(h)
\]</div>
<p>The <strong>log-variance</strong> is clamped to prevent extreme values:</p>
<div class="arithmatex">\[
\log \sigma^2 = \text{clamp}(\log \sigma^2, -30, 20)
\]</div>
<p>The standard deviation is computed as:</p>
<div class="arithmatex">\[
\sigma = \exp\left(\frac{1}{2} \log \sigma^2\right)
\]</div>
<p>Using the <strong>reparameterization trick</strong>, the latent variable <span class="arithmatex">\( z \)</span> is sampled as:</p>
<div class="arithmatex">\[
z = \mu + \sigma \cdot \epsilon, \quad \text{where } \epsilon \sim \mathcal{N}(0, I)
\]</div>
<h4 id="decoding-step"><strong>Decoding Step:</strong><a class="headerlink" href="#decoding-step" title="Permanent link"></a></h4>
<p>The decoder takes the latent variable <span class="arithmatex">\( z \)</span> and reconstructs the image:</p>
<div class="arithmatex">\[
\hat{x} = \text{Decoder}(z)
\]</div>
<p>where <span class="arithmatex">\(\hat{x}\)</span> is the reconstructed image.</p>
<p>These equations describe how the VAE transforms input images into a latent space representation and reconstructs them using the decoder.</p>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span>
<span class="normal"><a href="#__codelineno-1-32">32</a></span>
<span class="normal"><a href="#__codelineno-1-33">33</a></span>
<span class="normal"><a href="#__codelineno-1-34">34</a></span>
<span class="normal"><a href="#__codelineno-1-35">35</a></span>
<span class="normal"><a href="#__codelineno-1-36">36</a></span>
<span class="normal"><a href="#__codelineno-1-37">37</a></span>
<span class="normal"><a href="#__codelineno-1-38">38</a></span>
<span class="normal"><a href="#__codelineno-1-39">39</a></span>
<span class="normal"><a href="#__codelineno-1-40">40</a></span>
<span class="normal"><a href="#__codelineno-1-41">41</a></span>
<span class="normal"><a href="#__codelineno-1-42">42</a></span>
<span class="normal"><a href="#__codelineno-1-43">43</a></span>
<span class="normal"><a href="#__codelineno-1-44">44</a></span>
<span class="normal"><a href="#__codelineno-1-45">45</a></span>
<span class="normal"><a href="#__codelineno-1-46">46</a></span>
<span class="normal"><a href="#__codelineno-1-47">47</a></span>
<span class="normal"><a href="#__codelineno-1-48">48</a></span>
<span class="normal"><a href="#__codelineno-1-49">49</a></span>
<span class="normal"><a href="#__codelineno-1-50">50</a></span>
<span class="normal"><a href="#__codelineno-1-51">51</a></span>
<span class="normal"><a href="#__codelineno-1-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">VAEEncoder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">ch_mult</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">num_res_blocks</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">z_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_mult</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_res_blocks</span> <span class="o">=</span> <span class="n">num_res_blocks</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="c1"># downsampling</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>        <span class="n">in_ch_mult</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ch_mult</span><span class="p">)</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">in_ch_mult</span> <span class="o">=</span> <span class="n">in_ch_mult</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">down</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="k">for</span> <span class="n">i_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span><span class="p">):</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>            <span class="n">block</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>            <span class="n">attn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>            <span class="n">block_in</span> <span class="o">=</span> <span class="n">ch</span><span class="o">*</span><span class="n">in_ch_mult</span><span class="p">[</span><span class="n">i_level</span><span class="p">]</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>            <span class="n">block_out</span> <span class="o">=</span> <span class="n">ch</span><span class="o">*</span><span class="n">ch_mult</span><span class="p">[</span><span class="n">i_level</span><span class="p">]</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>            <span class="k">for</span> <span class="n">i_block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_res_blocks</span><span class="p">):</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>                <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ResnetBlock</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">block_in</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="n">block_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>                <span class="n">block_in</span> <span class="o">=</span> <span class="n">block_out</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a>            <span class="n">down</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a>            <span class="n">down</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a>            <span class="n">down</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">attn</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a>            <span class="k">if</span> <span class="n">i_level</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a>                <span class="n">down</span><span class="o">.</span><span class="n">downsample</span> <span class="o">=</span> <span class="n">Downsample</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">down</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">down</span><span class="p">)</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a>        <span class="c1"># middle</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">block_1</span> <span class="o">=</span> <span class="n">ResnetBlock</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">block_in</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">attn_1</span> <span class="o">=</span> <span class="n">AttnBlock</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">block_2</span> <span class="o">=</span> <span class="n">ResnetBlock</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">block_in</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a>        <span class="c1"># end</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm_out</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">z_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">swish</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a>        <span class="c1"># downsampling</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a>        <span class="n">hs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_in</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a>        <span class="k">for</span> <span class="n">i_level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span><span class="p">):</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a>            <span class="k">for</span> <span class="n">i_block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_res_blocks</span><span class="p">):</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a>                <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down</span><span class="p">[</span><span class="n">i_level</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">i_block</span><span class="p">](</span><span class="n">hs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a>                <span class="n">hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a>            <span class="k">if</span> <span class="n">i_level</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a>                <span class="n">hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">down</span><span class="p">[</span><span class="n">i_level</span><span class="p">]</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">hs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a>        <span class="c1"># middle</span>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">hs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-1-45" name="__codelineno-1-45"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">block_1</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-46" name="__codelineno-1-46"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">attn_1</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-47" name="__codelineno-1-47"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">block_2</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-48" name="__codelineno-1-48"></a>        <span class="c1"># end</span>
<a id="__codelineno-1-49" name="__codelineno-1-49"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_out</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-50" name="__codelineno-1-50"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swish</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-51" name="__codelineno-1-51"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_out</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-1-52" name="__codelineno-1-52"></a>        <span class="k">return</span> <span class="n">h</span>
</code></pre></div></td></tr></tbody></table></div>
<p>The code is same as that in the LDM, see more details in <a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../chapter7_diffusion/ldm_handson/" data-desc-position="bottom"><img alt="Latent Diffusion Model" src="../../../chapter7_diffusion/ldm_handson/"></a></p>
<p>Here is an updated table summarizing the <strong>VAEEncoder</strong> feature map shapes, including the <strong>network components</strong> (e.g., ResNet blocks, self-attention layers, convolutions, etc.) at each stage.</p>
<table>
<thead>
<tr>
<th><strong>Stage</strong></th>
<th><strong>Resolution (H  W)</strong></th>
<th><strong>Channels</strong></th>
<th><strong>Downsampling Applied?</strong></th>
<th><strong>Network Components</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Input Image</strong></td>
<td><span class="arithmatex">\( H \times W \)</span></td>
<td>3</td>
<td>No</td>
<td>Raw image input</td>
</tr>
<tr>
<td><strong>Conv In</strong></td>
<td><span class="arithmatex">\( H \times W \)</span></td>
<td>128</td>
<td>No</td>
<td><span class="arithmatex">\(3 \times 3\)</span> Conv layer</td>
</tr>
<tr>
<td><strong>Downsampling Level 1</strong></td>
<td><span class="arithmatex">\( H \times W \)</span>  <span class="arithmatex">\( \frac{H}{2} \times \frac{W}{2} \)</span></td>
<td>128  256</td>
<td> Yes</td>
<td>2  ResNet Blocks + <span class="arithmatex">\(3 \times 3\)</span> Downsampling</td>
</tr>
<tr>
<td><strong>Downsampling Level 2</strong></td>
<td><span class="arithmatex">\( \frac{H}{2} \times \frac{W}{2} \)</span>  <span class="arithmatex">\( \frac{H}{4} \times \frac{W}{4} \)</span></td>
<td>256  512</td>
<td> Yes</td>
<td>2  ResNet Blocks + <span class="arithmatex">\(3 \times 3\)</span> Downsampling</td>
</tr>
<tr>
<td><strong>Downsampling Level 3</strong></td>
<td><span class="arithmatex">\( \frac{H}{4} \times \frac{W}{4} \)</span>  <span class="arithmatex">\( \frac{H}{8} \times \frac{W}{8} \)</span></td>
<td>512  512</td>
<td> Yes</td>
<td>2  ResNet Blocks + <span class="arithmatex">\(3 \times 3\)</span> Downsampling</td>
</tr>
<tr>
<td><strong>Middle (Bottleneck)</strong></td>
<td><span class="arithmatex">\( \frac{H}{8} \times \frac{W}{8} \)</span></td>
<td>512</td>
<td> No</td>
<td>1  ResNet Block + 1  Self-Attention Block + 1  ResNet Block</td>
</tr>
<tr>
<td><strong>Final Output</strong></td>
<td><span class="arithmatex">\( \frac{H}{8} \times \frac{W}{8} \)</span></td>
<td>32 (2  z_channels)</td>
<td> No</td>
<td>Normalization + Swish + <span class="arithmatex">\(3 \times 3\)</span> Conv layer (outputs mean &amp; log-variance)</td>
</tr>
</tbody>
</table>
<h3 id="key-observations"><strong>Key Observations</strong><a class="headerlink" href="#key-observations" title="Permanent link"></a></h3>
<ul>
<li><strong>ResNet Blocks</strong> are used at every resolution level to refine features.</li>
<li><strong>Self-Attention is applied only in the middle (bottleneck)</strong> to capture global dependencies.</li>
<li><strong>Downsampling occurs at levels 1, 2, and 3</strong>, reducing spatial dimensions by half each time.</li>
<li>The <strong>final layer outputs mean &amp; log-variance</strong> of the latent distribution for sampling.</li>
</ul>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">VAEDecoder</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span>
<span class="normal"><a href="#__codelineno-2-28">28</a></span>
<span class="normal"><a href="#__codelineno-2-29">29</a></span>
<span class="normal"><a href="#__codelineno-2-30">30</a></span>
<span class="normal"><a href="#__codelineno-2-31">31</a></span>
<span class="normal"><a href="#__codelineno-2-32">32</a></span>
<span class="normal"><a href="#__codelineno-2-33">33</a></span>
<span class="normal"><a href="#__codelineno-2-34">34</a></span>
<span class="normal"><a href="#__codelineno-2-35">35</a></span>
<span class="normal"><a href="#__codelineno-2-36">36</a></span>
<span class="normal"><a href="#__codelineno-2-37">37</a></span>
<span class="normal"><a href="#__codelineno-2-38">38</a></span>
<span class="normal"><a href="#__codelineno-2-39">39</a></span>
<span class="normal"><a href="#__codelineno-2-40">40</a></span>
<span class="normal"><a href="#__codelineno-2-41">41</a></span>
<span class="normal"><a href="#__codelineno-2-42">42</a></span>
<span class="normal"><a href="#__codelineno-2-43">43</a></span>
<span class="normal"><a href="#__codelineno-2-44">44</a></span>
<span class="normal"><a href="#__codelineno-2-45">45</a></span>
<span class="normal"><a href="#__codelineno-2-46">46</a></span>
<span class="normal"><a href="#__codelineno-2-47">47</a></span>
<span class="normal"><a href="#__codelineno-2-48">48</a></span>
<span class="normal"><a href="#__codelineno-2-49">49</a></span>
<span class="normal"><a href="#__codelineno-2-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">VAEDecoder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">out_ch</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ch_mult</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">num_res_blocks</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">z_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_mult</span><span class="p">)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_res_blocks</span> <span class="o">=</span> <span class="n">num_res_blocks</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>        <span class="n">block_in</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">*</span> <span class="n">ch_mult</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>        <span class="n">curr_res</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>        <span class="c1"># z to block_in</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">z_channels</span><span class="p">,</span> <span class="n">block_in</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>        <span class="c1"># middle</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">block_1</span> <span class="o">=</span> <span class="n">ResnetBlock</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">block_in</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">attn_1</span> <span class="o">=</span> <span class="n">AttnBlock</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">block_2</span> <span class="o">=</span> <span class="n">ResnetBlock</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">block_in</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>        <span class="c1"># upsampling</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">up</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>        <span class="k">for</span> <span class="n">i_level</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span><span class="p">)):</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>            <span class="n">block</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">()</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>            <span class="n">block_out</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">*</span> <span class="n">ch_mult</span><span class="p">[</span><span class="n">i_level</span><span class="p">]</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>            <span class="k">for</span> <span class="n">i_block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_res_blocks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a>                <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ResnetBlock</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="n">block_in</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="n">block_out</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a>                <span class="n">block_in</span> <span class="o">=</span> <span class="n">block_out</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a>            <span class="n">up</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a>            <span class="n">up</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>            <span class="k">if</span> <span class="n">i_level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a>                <span class="n">up</span><span class="o">.</span><span class="n">upsample</span> <span class="o">=</span> <span class="n">Upsample</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a>                <span class="n">curr_res</span> <span class="o">=</span> <span class="n">curr_res</span> <span class="o">*</span> <span class="mi">2</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">up</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">up</span><span class="p">)</span> <span class="c1"># prepend to get consistent order</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a>        <span class="c1"># end</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm_out</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">block_in</span><span class="p">,</span> <span class="n">out_ch</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">swish</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<a id="__codelineno-2-34" name="__codelineno-2-34"></a>        <span class="c1"># z to block_in</span>
<a id="__codelineno-2-35" name="__codelineno-2-35"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_in</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<a id="__codelineno-2-36" name="__codelineno-2-36"></a>        <span class="c1"># middle</span>
<a id="__codelineno-2-37" name="__codelineno-2-37"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">block_1</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-2-38" name="__codelineno-2-38"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">attn_1</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-2-39" name="__codelineno-2-39"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="o">.</span><span class="n">block_2</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-2-40" name="__codelineno-2-40"></a>        <span class="c1"># upsampling</span>
<a id="__codelineno-2-41" name="__codelineno-2-41"></a>        <span class="k">for</span> <span class="n">i_level</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_resolutions</span><span class="p">)):</span>
<a id="__codelineno-2-42" name="__codelineno-2-42"></a>            <span class="k">for</span> <span class="n">i_block</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_res_blocks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-2-43" name="__codelineno-2-43"></a>                <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up</span><span class="p">[</span><span class="n">i_level</span><span class="p">]</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">i_block</span><span class="p">](</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-2-44" name="__codelineno-2-44"></a>            <span class="k">if</span> <span class="n">i_level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-45" name="__codelineno-2-45"></a>                <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up</span><span class="p">[</span><span class="n">i_level</span><span class="p">]</span><span class="o">.</span><span class="n">upsample</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-2-46" name="__codelineno-2-46"></a>        <span class="c1"># end</span>
<a id="__codelineno-2-47" name="__codelineno-2-47"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_out</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-2-48" name="__codelineno-2-48"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swish</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-2-49" name="__codelineno-2-49"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_out</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-2-50" name="__codelineno-2-50"></a>        <span class="k">return</span> <span class="n">hidden</span>
</code></pre></div></td></tr></tbody></table></div>
<table>
<thead>
<tr>
<th><strong>Stage</strong></th>
<th><strong>Resolution (H  W)</strong></th>
<th><strong>Channels</strong></th>
<th><strong>Upsampling Applied?</strong></th>
<th><strong>Network Components</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Latent Input</strong></td>
<td><span class="arithmatex">\( \frac{H}{8} \times \frac{W}{8} \)</span></td>
<td>16</td>
<td>No</td>
<td>Raw latent space representation <span class="arithmatex">\( z \)</span></td>
</tr>
<tr>
<td><strong>Conv In</strong></td>
<td><span class="arithmatex">\( \frac{H}{8} \times \frac{W}{8} \)</span></td>
<td>512</td>
<td>No</td>
<td><span class="arithmatex">\(3 \times 3\)</span> Conv layer</td>
</tr>
<tr>
<td><strong>Middle (Bottleneck)</strong></td>
<td><span class="arithmatex">\( \frac{H}{8} \times \frac{W}{8} \)</span></td>
<td>512</td>
<td>No</td>
<td>1  ResNet Block + 1  Self-Attention Block + 1  ResNet Block</td>
</tr>
<tr>
<td><strong>Upsampling Level 1</strong></td>
<td><span class="arithmatex">\( \frac{H}{8} \times \frac{W}{8} \)</span>  <span class="arithmatex">\( \frac{H}{4} \times \frac{W}{4} \)</span></td>
<td>512  512</td>
<td> Yes</td>
<td>3  ResNet Blocks + Upsample (<span class="arithmatex">\(2 \times\)</span>)</td>
</tr>
<tr>
<td><strong>Upsampling Level 2</strong></td>
<td><span class="arithmatex">\( \frac{H}{4} \times \frac{W}{4} \)</span>  <span class="arithmatex">\( \frac{H}{2} \times \frac{W}{2} \)</span></td>
<td>512  256</td>
<td> Yes</td>
<td>3  ResNet Blocks + Upsample (<span class="arithmatex">\(2 \times\)</span>)</td>
</tr>
<tr>
<td><strong>Upsampling Level 3</strong></td>
<td><span class="arithmatex">\( \frac{H}{2} \times \frac{W}{2} \)</span>  <span class="arithmatex">\( H \times W \)</span></td>
<td>256  128</td>
<td> Yes</td>
<td>3  ResNet Blocks + Upsample (<span class="arithmatex">\(2 \times\)</span>)</td>
</tr>
<tr>
<td><strong>Upsampling Level 4</strong></td>
<td><span class="arithmatex">\( H \times W \)</span></td>
<td>128  128</td>
<td> No</td>
<td>3  ResNet Blocks (Final stage, no upsampling)</td>
</tr>
<tr>
<td><strong>Final Processing</strong></td>
<td><span class="arithmatex">\( H \times W \)</span></td>
<td>3</td>
<td> No</td>
<td>Normalize  Swish Activation  <span class="arithmatex">\(3 \times 3\)</span> Conv layer</td>
</tr>
</tbody>
</table>
<p>The VAEDecoder reconstructs an image from a latent space representation by progressively upsampling and refining features through ResNet blocks, self-attention, and convolutional layers.</p>
</div>
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">AttnBlock</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AttnBlock</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">proj_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>    <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>    <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">"b c h w -&gt; b 1 (h w) c"</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>    <span class="n">hidden</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">scaled_dot_product_attention</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>  <span class="c1"># scale is dim ** -0.5 per default</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>    <span class="n">hidden</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="s2">"b 1 (h w) c -&gt; b c h w"</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>    <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_out</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">hidden</span>
</code></pre></div></td></tr></tbody></table></div>
which is a standard self attention block.<p></p>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">ResnetBlock</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">Normalize</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">num_groups</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">GroupNorm</span><span class="p">(</span><span class="n">num_groups</span><span class="o">=</span><span class="n">num_groups</span><span class="p">,</span> <span class="n">num_channels</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResnetBlock</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="k">def</span><span class="w"> </span><span class="o">**</span><span class="n">init</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.**</span><span class="n">init</span><span class="o">**</span><span class="p">()</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">=</span> <span class="n">in_channels</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>        <span class="n">out_channels</span> <span class="o">=</span> <span class="n">in_channels</span> <span class="k">if</span> <span class="n">out_channels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out_channels</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span> <span class="o">=</span> <span class="n">out_channels</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">out_channels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">out_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">:</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nin_shortcut</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nin_shortcut</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">swish</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="n">x</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swish</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swish</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">:</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nin_shortcut</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">hidden</span>
</code></pre></div></td></tr></tbody></table></div>
<div class="arithmatex">\[
F(X) = \text{Conv2} \left( \text{Swish} \left( \text{Norm2} \left( \text{Conv1} \left( \text{Swish} \left( \text{Norm1}(X) \right) \right) \right) \right) \right)
\]</div>
<p>The <strong>final output</strong>  is:</p>
<div class="arithmatex">\[   Y = X + F(X) \]</div>
</div>
</div>
</div>
<h3 id="42-patchify">4.2 Patchify<a class="headerlink" href="#42-patchify" title="Permanent link"></a></h3>
<div class="tabbed-set tabbed-alternate" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio"><div class="tabbed-labels"><label for="__tabbed_2_1">PatchEmbed</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Patchify</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span>
<span class="normal"><a href="#__codelineno-5-32">32</a></span>
<span class="normal"><a href="#__codelineno-5-33">33</a></span>
<span class="normal"><a href="#__codelineno-5-34">34</a></span>
<span class="normal"><a href="#__codelineno-5-35">35</a></span>
<span class="normal"><a href="#__codelineno-5-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PatchEmbed</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="sd">""" 2D Image to Patch Embedding"""</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>            <span class="n">img_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>            <span class="n">patch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>            <span class="n">in_chans</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>            <span class="n">embed_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>            <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>            <span class="n">bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>            <span class="n">strict_img_size</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>            <span class="n">dynamic_img_pad</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>            <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>            <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>    <span class="p">):</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patch_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">)</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>        <span class="k">if</span> <span class="n">img_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">s</span> <span class="o">//</span> <span class="n">p</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_size</span><span class="p">)])</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_patches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_patches</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>        <span class="c1"># flatten spatial dim and transpose to channels last, kept for bwd compat</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span> <span class="o">=</span> <span class="n">flatten</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">strict_img_size</span> <span class="o">=</span> <span class="n">strict_img_size</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_img_pad</span> <span class="o">=</span> <span class="n">dynamic_img_pad</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_chans</span><span class="p">,</span> <span class="n">embed_dim</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a>        <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">:</span>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># NCHW -&gt; NLC</span>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a>        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div>
</div>
</div>
</div>
<p>Use the convolution to do the patchify that convert the original image from [B,C,H,W] to <span class="arithmatex">\([B,N,C]\)</span>, where <span class="arithmatex">\(N=\frac{H}{\text{patch size}}\times\frac{W}{\text{patch size}}=\frac{H\times W}{4}\)</span>. The convolutional kernel size is <span class="arithmatex">\(patch_size\times patch_size\)</span>.</p>
<h3 id="43-timeembedding">4.3 TimeEmbedding<a class="headerlink" href="#43-timeembedding" title="Permanent link"></a></h3>
<div class="tabbed-set tabbed-alternate" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio"><div class="tabbed-labels"><label for="__tabbed_3_1">TimestepEmbedder</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TimestepEmbedder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="sd">"""Embeds scalar timesteps into vector representations."""</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">frequency_embedding_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">frequency_embedding_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">(),</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>        <span class="p">)</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">frequency_embedding_size</span> <span class="o">=</span> <span class="n">frequency_embedding_size</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">timestep_embedding</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">max_period</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="sd">        Create sinusoidal timestep embeddings.</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="sd">        :param t: a 1-D Tensor of N indices, one per batch element.</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="sd">                        These may be fractional.</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="sd">        :param dim: the dimension of the output.</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="sd">        :param max_period: controls the minimum frequency of the embeddings.</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="sd">        :return: an (N, D) Tensor of positional embeddings.</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="sd">        """</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>        <span class="n">half</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>        <span class="n">freqs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>            <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">max_period</span><span class="p">)</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>            <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">half</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a>            <span class="o">/</span> <span class="n">half</span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a>        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a>        <span class="n">args</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="n">freqs</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a>        <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">args</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">embedding</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">embedding</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">])],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a>        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_floating_point</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a>        <span class="k">return</span> <span class="n">embedding</span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a>        <span class="n">t_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep_embedding</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_embedding_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a>        <span class="n">t_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">t_freq</span><span class="p">)</span>
<a id="__codelineno-6-40" name="__codelineno-6-40"></a>        <span class="k">return</span> <span class="n">t_emb</span>
</code></pre></div></td></tr></tbody></table></div>
</div>
</div>
</div>
<p>The <strong>timestep embedding</strong> function generates a vector representation of time <span class="arithmatex">\( t \)</span> using <strong>sinusoidal embeddings</strong>. The formula can be rewritten as a single vector equation.</p>
<p><strong>Embedding as a Vector</strong>
For a given timestep <span class="arithmatex">\( t \)</span>, the embedding vector <strong><span class="arithmatex">\( E_t \)</span></strong> is computed as:</p>
<div class="arithmatex">\[
E_t = \left[ \cos\left(t \cdot f_1\right), \sin\left(t \cdot f_1\right), \cos\left(t \cdot f_2\right), \sin\left(t \cdot f_2\right), \dots, \cos\left(t \cdot f_{\frac{D}{2}}\right), \sin\left(t \cdot f_{\frac{D}{2}}\right) \right]
\]</div>
<p>where:</p>
<ul>
<li><span class="arithmatex">\( f_i = e^{-\frac{\log(\text{max\_period})}{D/2} \cdot i} \)</span> are the frequency components.</li>
<li><span class="arithmatex">\( D \)</span> is the embedding dimension.</li>
<li>The final embedding vector <strong><span class="arithmatex">\( E_t \)</span></strong> has shape <strong><span class="arithmatex">\( (D,) \)</span></strong>.</li>
</ul>
<p>If <span class="arithmatex">\( D \)</span> is <strong>odd</strong>, an extra zero is appended:</p>
<div class="arithmatex">\[
E_t = \left[ E_t, 0 \right]
\]</div>
<p>This vector representation ensures <strong>smooth temporal encoding</strong> and is widely used in <strong>diffusion models, transformers, and time-aware architectures</strong>. </p>
<h3 id="44-mm-dit">4.4 MM-DiT<a class="headerlink" href="#44-mm-dit" title="Permanent link"></a></h3>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-81.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-81.png"></a></p>
<p>The overall structure of the MM-DiT network</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="https://pica.zhimg.com/v2-5852fb562c033510fef96f7772e41278_r.jpg" data-desc-position="bottom"><img alt="" src="https://pica.zhimg.com/v2-5852fb562c033510fef96f7772e41278_r.jpg"></a></p>
<p>In each MM-DiT Block, the text context and image context are fed into the attention by concatenation</p>
<h4 id="441-dit-block">4.4.1 DiT Block<a class="headerlink" href="#441-dit-block" title="Permanent link"></a></h4>
<div class="tabbed-set tabbed-alternate" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio"><div class="tabbed-labels"><label for="__tabbed_4_1">DismantledBlock</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span>
<span class="normal"><a href="#__codelineno-7-45">45</a></span>
<span class="normal"><a href="#__codelineno-7-46">46</a></span>
<span class="normal"><a href="#__codelineno-7-47">47</a></span>
<span class="normal"><a href="#__codelineno-7-48">48</a></span>
<span class="normal"><a href="#__codelineno-7-49">49</a></span>
<span class="normal"><a href="#__codelineno-7-50">50</a></span>
<span class="normal"><a href="#__codelineno-7-51">51</a></span>
<span class="normal"><a href="#__codelineno-7-52">52</a></span>
<span class="normal"><a href="#__codelineno-7-53">53</a></span>
<span class="normal"><a href="#__codelineno-7-54">54</a></span>
<span class="normal"><a href="#__codelineno-7-55">55</a></span>
<span class="normal"><a href="#__codelineno-7-56">56</a></span>
<span class="normal"><a href="#__codelineno-7-57">57</a></span>
<span class="normal"><a href="#__codelineno-7-58">58</a></span>
<span class="normal"><a href="#__codelineno-7-59">59</a></span>
<span class="normal"><a href="#__codelineno-7-60">60</a></span>
<span class="normal"><a href="#__codelineno-7-61">61</a></span>
<span class="normal"><a href="#__codelineno-7-62">62</a></span>
<span class="normal"><a href="#__codelineno-7-63">63</a></span>
<span class="normal"><a href="#__codelineno-7-64">64</a></span>
<span class="normal"><a href="#__codelineno-7-65">65</a></span>
<span class="normal"><a href="#__codelineno-7-66">66</a></span>
<span class="normal"><a href="#__codelineno-7-67">67</a></span>
<span class="normal"><a href="#__codelineno-7-68">68</a></span>
<span class="normal"><a href="#__codelineno-7-69">69</a></span>
<span class="normal"><a href="#__codelineno-7-70">70</a></span>
<span class="normal"><a href="#__codelineno-7-71">71</a></span>
<span class="normal"><a href="#__codelineno-7-72">72</a></span>
<span class="normal"><a href="#__codelineno-7-73">73</a></span>
<span class="normal"><a href="#__codelineno-7-74">74</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1"># code</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DismantledBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="sd">"""A DiT block with gated adaptive layer norm (adaLN) conditioning."""</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>    <span class="n">ATTENTION_MODES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"xformers"</span><span class="p">,</span> <span class="s2">"torch"</span><span class="p">,</span> <span class="s2">"torch-hb"</span><span class="p">,</span> <span class="s2">"math"</span><span class="p">,</span> <span class="s2">"debug"</span><span class="p">)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="n">mlp_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.0</span><span class="p">,</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>        <span class="n">attn_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"xformers"</span><span class="p">,</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>        <span class="n">qkv_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>        <span class="n">pre_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>        <span class="n">rmsnorm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>        <span class="n">scale_mod_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>        <span class="n">swiglu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>        <span class="n">qk_norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>        <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a>        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a>        <span class="o">**</span><span class="n">block_kwargs</span><span class="p">,</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>    <span class="p">):</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a>        <span class="k">assert</span> <span class="n">attn_mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATTENTION_MODES</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">rmsnorm</span><span class="p">:</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span> <span class="o">=</span> <span class="n">RMSNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">SelfAttention</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span> <span class="n">qkv_bias</span><span class="o">=</span><span class="n">qkv_bias</span><span class="p">,</span> <span class="n">attn_mode</span><span class="o">=</span><span class="n">attn_mode</span><span class="p">,</span> <span class="n">pre_only</span><span class="o">=</span><span class="n">pre_only</span><span class="p">,</span> <span class="n">qk_norm</span><span class="o">=</span><span class="n">qk_norm</span><span class="p">,</span> <span class="n">rmsnorm</span><span class="o">=</span><span class="n">rmsnorm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rmsnorm</span><span class="p">:</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span> <span class="o">=</span> <span class="n">RMSNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a>        <span class="n">mlp_hidden_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="n">mlp_ratio</span><span class="p">)</span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">swiglu</span><span class="p">:</span>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">Mlp</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_features</span><span class="o">=</span><span class="n">mlp_hidden_dim</span><span class="p">,</span> <span class="n">act_layer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">GELU</span><span class="p">(</span><span class="n">approximate</span><span class="o">=</span><span class="s2">"tanh"</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">SwiGLUFeedForward</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">mlp_hidden_dim</span><span class="p">,</span> <span class="n">multiple_of</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scale_mod_only</span> <span class="o">=</span> <span class="n">scale_mod_only</span>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">scale_mod_only</span><span class="p">:</span>
<a id="__codelineno-7-41" name="__codelineno-7-41"></a>            <span class="n">n_mods</span> <span class="o">=</span> <span class="mi">6</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_only</span> <span class="k">else</span> <span class="mi">2</span>
<a id="__codelineno-7-42" name="__codelineno-7-42"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-43" name="__codelineno-7-43"></a>            <span class="n">n_mods</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_only</span> <span class="k">else</span> <span class="mi">1</span>
<a id="__codelineno-7-44" name="__codelineno-7-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">n_mods</span> <span class="o">*</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-7-45" name="__codelineno-7-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span> <span class="o">=</span> <span class="n">pre_only</span>
<a id="__codelineno-7-46" name="__codelineno-7-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pre_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-7-47" name="__codelineno-7-47"></a>        <span class="k">assert</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">"pre_attention called with None input"</span>
<a id="__codelineno-7-48" name="__codelineno-7-48"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-7-49" name="__codelineno-7-49"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_mod_only</span><span class="p">:</span>
<a id="__codelineno-7-50" name="__codelineno-7-50"></a>                <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-51" name="__codelineno-7-51"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-52" name="__codelineno-7-52"></a>                <span class="n">shift_msa</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-53" name="__codelineno-7-53"></a>                <span class="n">shift_mlp</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-54" name="__codelineno-7-54"></a>                <span class="n">scale_msa</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-55" name="__codelineno-7-55"></a>            <span class="n">qkv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span><span class="p">))</span>
<a id="__codelineno-7-56" name="__codelineno-7-56"></a>            <span class="k">return</span> <span class="n">qkv</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span><span class="p">)</span>
<a id="__codelineno-7-57" name="__codelineno-7-57"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-58" name="__codelineno-7-58"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_mod_only</span><span class="p">:</span>
<a id="__codelineno-7-59" name="__codelineno-7-59"></a>                <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-60" name="__codelineno-7-60"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-61" name="__codelineno-7-61"></a>                <span class="n">shift_msa</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-62" name="__codelineno-7-62"></a>                <span class="n">scale_msa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<a id="__codelineno-7-63" name="__codelineno-7-63"></a>            <span class="n">qkv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span><span class="p">))</span>
<a id="__codelineno-7-64" name="__codelineno-7-64"></a>            <span class="k">return</span> <span class="n">qkv</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-7-65" name="__codelineno-7-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span><span class="p">):</span>
<a id="__codelineno-7-66" name="__codelineno-7-66"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span>
<a id="__codelineno-7-67" name="__codelineno-7-67"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">gate_msa</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">attn</span><span class="p">)</span>
<a id="__codelineno-7-68" name="__codelineno-7-68"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">gate_mlp</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">))</span>
<a id="__codelineno-7-69" name="__codelineno-7-69"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-7-70" name="__codelineno-7-70"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-7-71" name="__codelineno-7-71"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span>
<a id="__codelineno-7-72" name="__codelineno-7-72"></a>        <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">intermediates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-7-73" name="__codelineno-7-73"></a>        <span class="n">attn</span> <span class="o">=</span> <span class="n">attention</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
<a id="__codelineno-7-74" name="__codelineno-7-74"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">attn</span><span class="p">,</span> <span class="o">*</span><span class="n">intermediates</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
</div>
</div>
</div>
<p>It got three main blocks</p>
<ul>
<li>pre_attention</li>
<li>attention</li>
<li>post_attention</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio"><div class="tabbed-labels"><label for="__tabbed_5_1">SelfAttention</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span>
<span class="normal"><a href="#__codelineno-8-45">45</a></span>
<span class="normal"><a href="#__codelineno-8-46">46</a></span>
<span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span>
<span class="normal"><a href="#__codelineno-8-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SelfAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="n">ATTENTION_MODES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"xformers"</span><span class="p">,</span> <span class="s2">"torch"</span><span class="p">,</span> <span class="s2">"torch-hb"</span><span class="p">,</span> <span class="s2">"math"</span><span class="p">,</span> <span class="s2">"debug"</span><span class="p">)</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>    <span class="k">def</span><span class="w"> </span><span class="o">**</span><span class="n">init</span><span class="o">**</span><span class="p">(</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>        <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>        <span class="n">qkv_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>        <span class="n">qk_scale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>        <span class="n">attn_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"xformers"</span><span class="p">,</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>        <span class="n">pre_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>        <span class="n">qk_norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>        <span class="n">rmsnorm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>        <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>    <span class="p">):</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.**</span><span class="n">init</span><span class="o">**</span><span class="p">()</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">=</span> <span class="n">num_heads</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">//</span> <span class="n">num_heads</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">qkv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">qkv_bias</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a>        <span class="k">assert</span> <span class="n">attn_mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATTENTION_MODES</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attn_mode</span> <span class="o">=</span> <span class="n">attn_mode</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span> <span class="o">=</span> <span class="n">pre_only</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a>        <span class="k">if</span> <span class="n">qk_norm</span> <span class="o">==</span> <span class="s2">"rms"</span><span class="p">:</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_q</span> <span class="o">=</span> <span class="n">RMSNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_k</span> <span class="o">=</span> <span class="n">RMSNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a>        <span class="k">elif</span> <span class="n">qk_norm</span> <span class="o">==</span> <span class="s2">"ln"</span><span class="p">:</span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a>        <span class="k">elif</span> <span class="n">qk_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">qk_norm</span><span class="p">)</span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pre_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a>        <span class="n">B</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a>        <span class="n">qkv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qkv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a>        <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">split_qkv</span><span class="p">(</span><span class="n">qkv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">)</span>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a>        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_q</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a>        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_k</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span>
<a id="__codelineno-8-45" name="__codelineno-8-45"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-8-46" name="__codelineno-8-46"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-8-47" name="__codelineno-8-47"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-8-48" name="__codelineno-8-48"></a>        <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-8-49" name="__codelineno-8-49"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">attention</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
<a id="__codelineno-8-50" name="__codelineno-8-50"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-8-51" name="__codelineno-8-51"></a>        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div>
</div>
</div>
</div>
<p>It is a normal self attention network but with different layernorm layers. Also, it cobines the linear projections of Q,K, and V together into a single linear projection.</p>
<h5 id="4411-rmsnorm">4.4.1.1 RMSNorm<a class="headerlink" href="#4411-rmsnorm" title="Permanent link"></a></h5>
<p>Given an input feature vector <span class="arithmatex">\(x\)</span> with <strong>dimension</strong>  <span class="arithmatex">\(d\)</span>, RMSNorm is defined as:</p>
<div class="arithmatex">\[
\text{RMSNorm}(x) = \frac{x}{\text{RMS}(x)} \cdot \gamma
\]</div>
<p>where:</p>
<ul>
<li><strong>RMS (Root Mean Square) is calculated as:</strong></li>
</ul>
<div class="arithmatex">\[
\text{RMS}(x) = \sqrt{\frac{1}{d} \sum_{i=1}^{d} x_i^2 + \epsilon}
\]</div>
<ul>
<li>
<p><span class="arithmatex">\(\epsilon\)</span> is a small constant to prevent division by zero.</p>
</li>
<li>
<p><span class="arithmatex">\(\gamma\)</span> is a <strong>learnable scaling parameter</strong>  (similar to LayerNorm).
If a <strong>bias term</strong>  <span class="arithmatex">\(\beta\)</span> is added, the formula becomes:</p>
</li>
</ul>
<div class="arithmatex">\[
\text{RMSNorm}(x) = \frac{x}{\text{RMS}(x)} \cdot \gamma + \beta
\]</div>
<h4 id="442-mm-dit">4.4.2 MM-Dit<a class="headerlink" href="#442-mm-dit" title="Permanent link"></a></h4>
<div class="tabbed-set tabbed-alternate" data-tabs="6:6"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio"><input id="__tabbed_6_2" name="__tabbed_6" type="radio"><input id="__tabbed_6_3" name="__tabbed_6" type="radio"><input id="__tabbed_6_4" name="__tabbed_6" type="radio"><input id="__tabbed_6_5" name="__tabbed_6" type="radio"><input id="__tabbed_6_6" name="__tabbed_6" type="radio"><div class="tabbed-labels"><label for="__tabbed_6_1">cropped_pos_embed</label><label for="__tabbed_6_2">forward_core_with_concat</label><label for="__tabbed_6_3">Final Layer</label><label for="__tabbed_6_4">block_mixing</label><label for="__tabbed_6_5">DismantledBlock</label><label for="__tabbed_6_6">SelfAttention</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">cropped_pos_embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hw</span><span class="p">):</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed_max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_embedder</span><span class="o">.</span><span class="n">patch_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">hw</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>    <span class="c1"># patched size</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">//</span> <span class="n">p</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">//</span> <span class="n">p</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>    <span class="k">assert</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed_max_size</span><span class="p">,</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed_max_size</span><span class="p">)</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>    <span class="k">assert</span> <span class="n">w</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed_max_size</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed_max_size</span><span class="p">)</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>    <span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_embed_max_size</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>    <span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_embed_max_size</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>    <span class="n">spatial_pos_embed</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_embed</span><span class="p">,</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>        <span class="s2">"1 (h w) c -&gt; 1 h w c"</span><span class="p">,</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>        <span class="n">h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_embed_max_size</span><span class="p">,</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>        <span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_embed_max_size</span><span class="p">,</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>    <span class="p">)</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a>    <span class="n">spatial_pos_embed</span> <span class="o">=</span> <span class="n">spatial_pos_embed</span><span class="p">[:,</span> <span class="n">top</span> <span class="p">:</span> <span class="n">top</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">left</span> <span class="p">:</span> <span class="n">left</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a>    <span class="n">spatial_pos_embed</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">spatial_pos_embed</span><span class="p">,</span> <span class="s2">"1 h w c -&gt; 1 (h w) c"</span><span class="p">)</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a>    <span class="k">return</span> <span class="n">spatial_pos_embed</span>
</code></pre></div></td></tr></tbody></table></div>
<p>This function <strong>extracts a cropped positional embedding</strong> from a larger precomputed embedding, ensuring spatial alignment in Transformers for varying input sizes.</p>
<p><strong>Key Steps:</strong>
1. <strong>Compute Patched Size</strong>  Converts input dimensions to patch-based resolution.
2. <strong>Validate Size</strong>  Ensures it does not exceed the stored max embedding size.
3. <strong>Center Crop</strong>  Extracts the relevant portion of the positional embedding.
4. <strong>Format Adjustment</strong>  Reshapes from <strong>(1, H<em>W, C)  (1, H, W, C)  (1, h</em>w, C)</strong>.</p>
<p><strong>Purpose:</strong>
- Adapts positional embeddings for different resolutions.
- Maintains spatial awareness in <strong>ViT/DiT</strong> models.
- Enables flexibility without retraining embeddings.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-88.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-88.png"></a></p>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">forward_core_with_concat</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span>
<span class="normal"><a href="#__codelineno-10-6">6</a></span>
<span class="normal"><a href="#__codelineno-10-7">7</a></span>
<span class="normal"><a href="#__codelineno-10-8">8</a></span>
<span class="normal"><a href="#__codelineno-10-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">forward_core_with_concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c_mod</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="s2">"1 ... -&gt; b ..."</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">context</span> <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="c1"># context is B, L', D</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>    <span class="c1"># x is B, L, D</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_blocks</span><span class="p">:</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>        <span class="n">context</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c_mod</span><span class="p">)</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c_mod</span><span class="p">)</span>  <span class="c1"># (N, T, patch_size ** 2 * out_channels)</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div>
<p>It handles the case when context is None, the empty tensor will be created as context.
If register_length&gt;0, it will create 'register_length's tokens appending before the context sequence. Like</p>
<div class="arithmatex">\[[e_{pre_1},e_{pre_2},...,e_{context_1},e_{context_e},...,e_{context_L}]\]</div>
<p>The Final Layer is a simple AdaLn module that is Same in DiT.</p>
<p>The core structure in the function is the  the joint block. Let's device into the joint block further.</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">JointBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>        <span class="n">pre_only</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"pre_only"</span><span class="p">)</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>        <span class="n">qk_norm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"qk_norm"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context_block</span> <span class="o">=</span> <span class="n">DismantledBlock</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">pre_only</span><span class="o">=</span><span class="n">pre_only</span><span class="p">,</span> <span class="n">qk_norm</span><span class="o">=</span><span class="n">qk_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_block</span> <span class="o">=</span> <span class="n">DismantledBlock</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">pre_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qk_norm</span><span class="o">=</span><span class="n">qk_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>        <span class="k">return</span> <span class="n">block_mixing</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">context_block</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context_block</span><span class="p">,</span> <span class="n">x_block</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_block</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p>The joint block is composed of the block mixing, DismantledBlock. Let's check them step by step.</p>
<p>The overall strucrure of the MM-DiT block is</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-90.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-90.png"></a></p>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">FinalLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">total_out_channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm_final</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">patch_size</span> <span class="o">*</span> <span class="n">patch_size</span> <span class="o">*</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">total_out_channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>            <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">total_out_channels</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>        <span class="p">)</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a>        <span class="n">shift</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_final</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a>        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div>
<p>It takes the same idea of adaLN which borrows from the paper DiT (style gan). See more details in <a href="../../../chapter7_diffusion/DiT/">DiT</a>.</p>
</div>
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">block_mixing</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">context_block</span><span class="p">,</span> <span class="n">x_block</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>    <span class="k">assert</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">"block_mixing called with None context"</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>    <span class="n">context_qkv</span><span class="p">,</span> <span class="n">context_intermediates</span> <span class="o">=</span> <span class="n">context_block</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>    <span class="n">x_qkv</span><span class="p">,</span> <span class="n">x_intermediates</span> <span class="o">=</span> <span class="n">x_block</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>    <span class="n">o</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>        <span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">context_qkv</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">x_qkv</span><span class="p">[</span><span class="n">t</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>    <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a>    <span class="n">attn</span> <span class="o">=</span> <span class="n">attention</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">x_block</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>    <span class="n">context_attn</span><span class="p">,</span> <span class="n">x_attn</span> <span class="o">=</span> <span class="p">(</span><span class="n">attn</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">context_qkv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">attn</span><span class="p">[:,</span> <span class="n">context_qkv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:])</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">context_block</span><span class="o">.</span><span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">context_block</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">context_attn</span><span class="p">,</span> <span class="o">*</span><span class="n">context_intermediates</span><span class="p">)</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>        <span class="n">context</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">x_block</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">x_attn</span><span class="p">,</span> <span class="o">*</span><span class="n">x_intermediates</span><span class="p">)</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>    <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div>
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-89.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-89.png"></a><p></p>
<p>As shown above, the block mixing is a attention block, that first process <code>context</code> and <code>x</code> seperately, and concat them together to do self attention, (which can be considered as the cross attention from each other by concating the information in the K,V).</p>
<p>It need further to check what is the context_block, and x_block, which are same attention network structure</p>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span>
<span class="normal"><a href="#__codelineno-14-21">21</a></span>
<span class="normal"><a href="#__codelineno-14-22">22</a></span>
<span class="normal"><a href="#__codelineno-14-23">23</a></span>
<span class="normal"><a href="#__codelineno-14-24">24</a></span>
<span class="normal"><a href="#__codelineno-14-25">25</a></span>
<span class="normal"><a href="#__codelineno-14-26">26</a></span>
<span class="normal"><a href="#__codelineno-14-27">27</a></span>
<span class="normal"><a href="#__codelineno-14-28">28</a></span>
<span class="normal"><a href="#__codelineno-14-29">29</a></span>
<span class="normal"><a href="#__codelineno-14-30">30</a></span>
<span class="normal"><a href="#__codelineno-14-31">31</a></span>
<span class="normal"><a href="#__codelineno-14-32">32</a></span>
<span class="normal"><a href="#__codelineno-14-33">33</a></span>
<span class="normal"><a href="#__codelineno-14-34">34</a></span>
<span class="normal"><a href="#__codelineno-14-35">35</a></span>
<span class="normal"><a href="#__codelineno-14-36">36</a></span>
<span class="normal"><a href="#__codelineno-14-37">37</a></span>
<span class="normal"><a href="#__codelineno-14-38">38</a></span>
<span class="normal"><a href="#__codelineno-14-39">39</a></span>
<span class="normal"><a href="#__codelineno-14-40">40</a></span>
<span class="normal"><a href="#__codelineno-14-41">41</a></span>
<span class="normal"><a href="#__codelineno-14-42">42</a></span>
<span class="normal"><a href="#__codelineno-14-43">43</a></span>
<span class="normal"><a href="#__codelineno-14-44">44</a></span>
<span class="normal"><a href="#__codelineno-14-45">45</a></span>
<span class="normal"><a href="#__codelineno-14-46">46</a></span>
<span class="normal"><a href="#__codelineno-14-47">47</a></span>
<span class="normal"><a href="#__codelineno-14-48">48</a></span>
<span class="normal"><a href="#__codelineno-14-49">49</a></span>
<span class="normal"><a href="#__codelineno-14-50">50</a></span>
<span class="normal"><a href="#__codelineno-14-51">51</a></span>
<span class="normal"><a href="#__codelineno-14-52">52</a></span>
<span class="normal"><a href="#__codelineno-14-53">53</a></span>
<span class="normal"><a href="#__codelineno-14-54">54</a></span>
<span class="normal"><a href="#__codelineno-14-55">55</a></span>
<span class="normal"><a href="#__codelineno-14-56">56</a></span>
<span class="normal"><a href="#__codelineno-14-57">57</a></span>
<span class="normal"><a href="#__codelineno-14-58">58</a></span>
<span class="normal"><a href="#__codelineno-14-59">59</a></span>
<span class="normal"><a href="#__codelineno-14-60">60</a></span>
<span class="normal"><a href="#__codelineno-14-61">61</a></span>
<span class="normal"><a href="#__codelineno-14-62">62</a></span>
<span class="normal"><a href="#__codelineno-14-63">63</a></span>
<span class="normal"><a href="#__codelineno-14-64">64</a></span>
<span class="normal"><a href="#__codelineno-14-65">65</a></span>
<span class="normal"><a href="#__codelineno-14-66">66</a></span>
<span class="normal"><a href="#__codelineno-14-67">67</a></span>
<span class="normal"><a href="#__codelineno-14-68">68</a></span>
<span class="normal"><a href="#__codelineno-14-69">69</a></span>
<span class="normal"><a href="#__codelineno-14-70">70</a></span>
<span class="normal"><a href="#__codelineno-14-71">71</a></span>
<span class="normal"><a href="#__codelineno-14-72">72</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">DismantledBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>    <span class="n">ATTENTION_MODES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"xformers"</span><span class="p">,</span> <span class="s2">"torch"</span><span class="p">,</span> <span class="s2">"torch-hb"</span><span class="p">,</span> <span class="s2">"math"</span><span class="p">,</span> <span class="s2">"debug"</span><span class="p">)</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>        <span class="n">hidden_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>        <span class="n">mlp_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.0</span><span class="p">,</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a>        <span class="n">attn_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"xformers"</span><span class="p">,</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>        <span class="n">qkv_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a>        <span class="n">pre_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a>        <span class="n">rmsnorm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>        <span class="n">scale_mod_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>        <span class="n">swiglu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a>        <span class="n">qk_norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a>        <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a>        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a>        <span class="o">**</span><span class="n">block_kwargs</span><span class="p">,</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a>    <span class="p">):</span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a>        <span class="k">assert</span> <span class="n">attn_mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATTENTION_MODES</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">rmsnorm</span><span class="p">:</span>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-24" name="__codelineno-14-24"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span> <span class="o">=</span> <span class="n">RMSNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
<a id="__codelineno-14-25" name="__codelineno-14-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">SelfAttention</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span> <span class="n">qkv_bias</span><span class="o">=</span><span class="n">qkv_bias</span><span class="p">,</span> <span class="n">attn_mode</span><span class="o">=</span><span class="n">attn_mode</span><span class="p">,</span> <span class="n">pre_only</span><span class="o">=</span><span class="n">pre_only</span><span class="p">,</span> <span class="n">qk_norm</span><span class="o">=</span><span class="n">qk_norm</span><span class="p">,</span> <span class="n">rmsnorm</span><span class="o">=</span><span class="n">rmsnorm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-14-26" name="__codelineno-14-26"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-14-27" name="__codelineno-14-27"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rmsnorm</span><span class="p">:</span>
<a id="__codelineno-14-28" name="__codelineno-14-28"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-14-29" name="__codelineno-14-29"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-30" name="__codelineno-14-30"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">norm2</span> <span class="o">=</span> <span class="n">RMSNorm</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>
<a id="__codelineno-14-31" name="__codelineno-14-31"></a>        <span class="n">mlp_hidden_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hidden_size</span> <span class="o">*</span> <span class="n">mlp_ratio</span><span class="p">)</span>
<a id="__codelineno-14-32" name="__codelineno-14-32"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-14-33" name="__codelineno-14-33"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">swiglu</span><span class="p">:</span>
<a id="__codelineno-14-34" name="__codelineno-14-34"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">Mlp</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_features</span><span class="o">=</span><span class="n">mlp_hidden_dim</span><span class="p">,</span> <span class="n">act_layer</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">GELU</span><span class="p">(</span><span class="n">approximate</span><span class="o">=</span><span class="s2">"tanh"</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-14-35" name="__codelineno-14-35"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-36" name="__codelineno-14-36"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">SwiGLUFeedForward</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">mlp_hidden_dim</span><span class="p">,</span> <span class="n">multiple_of</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<a id="__codelineno-14-37" name="__codelineno-14-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scale_mod_only</span> <span class="o">=</span> <span class="n">scale_mod_only</span>
<a id="__codelineno-14-38" name="__codelineno-14-38"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">scale_mod_only</span><span class="p">:</span>
<a id="__codelineno-14-39" name="__codelineno-14-39"></a>            <span class="n">n_mods</span> <span class="o">=</span> <span class="mi">6</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_only</span> <span class="k">else</span> <span class="mi">2</span>
<a id="__codelineno-14-40" name="__codelineno-14-40"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-41" name="__codelineno-14-41"></a>            <span class="n">n_mods</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_only</span> <span class="k">else</span> <span class="mi">1</span>
<a id="__codelineno-14-42" name="__codelineno-14-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">(),</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">n_mods</span> <span class="o">*</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-14-43" name="__codelineno-14-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span> <span class="o">=</span> <span class="n">pre_only</span>
<a id="__codelineno-14-44" name="__codelineno-14-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pre_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-14-45" name="__codelineno-14-45"></a>        <span class="k">assert</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">"pre_attention called with None input"</span>
<a id="__codelineno-14-46" name="__codelineno-14-46"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-14-47" name="__codelineno-14-47"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_mod_only</span><span class="p">:</span>
<a id="__codelineno-14-48" name="__codelineno-14-48"></a>                <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-14-49" name="__codelineno-14-49"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-50" name="__codelineno-14-50"></a>                <span class="n">shift_msa</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-51" name="__codelineno-14-51"></a>                <span class="n">shift_mlp</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-52" name="__codelineno-14-52"></a>                <span class="n">scale_msa</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-14-53" name="__codelineno-14-53"></a>            <span class="n">qkv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span><span class="p">))</span>
<a id="__codelineno-14-54" name="__codelineno-14-54"></a>            <span class="k">return</span> <span class="n">qkv</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span><span class="p">)</span>
<a id="__codelineno-14-55" name="__codelineno-14-55"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-56" name="__codelineno-14-56"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_mod_only</span><span class="p">:</span>
<a id="__codelineno-14-57" name="__codelineno-14-57"></a>                <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-14-58" name="__codelineno-14-58"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-59" name="__codelineno-14-59"></a>                <span class="n">shift_msa</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-60" name="__codelineno-14-60"></a>                <span class="n">scale_msa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<a id="__codelineno-14-61" name="__codelineno-14-61"></a>            <span class="n">qkv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span><span class="p">))</span>
<a id="__codelineno-14-62" name="__codelineno-14-62"></a>            <span class="k">return</span> <span class="n">qkv</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-14-63" name="__codelineno-14-63"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span><span class="p">):</span>
<a id="__codelineno-14-64" name="__codelineno-14-64"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span>
<a id="__codelineno-14-65" name="__codelineno-14-65"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">gate_msa</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">attn</span><span class="p">)</span>
<a id="__codelineno-14-66" name="__codelineno-14-66"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">gate_mlp</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">))</span>
<a id="__codelineno-14-67" name="__codelineno-14-67"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-14-68" name="__codelineno-14-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-14-69" name="__codelineno-14-69"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span>
<a id="__codelineno-14-70" name="__codelineno-14-70"></a>        <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">intermediates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-14-71" name="__codelineno-14-71"></a>        <span class="n">attn</span> <span class="o">=</span> <span class="n">attention</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
<a id="__codelineno-14-72" name="__codelineno-14-72"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">attn</span><span class="p">,</span> <span class="o">*</span><span class="n">intermediates</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p>Since in the mixing_block, only the pre_attention and the post_attention are called, Let's only look at these two functions only.</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">modulate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>    <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>        <span class="n">shift</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">scale</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">shift</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p>It take the idea of the adaIN from DiT paper. which modulate the shift and scale after the layer norm before and after the attention.
Also inferit from the idea of DiT, it use the gate parameter to control the strength of the residule network after the self attention of <code>context</code> and <code>x</code>, which hope in the initial stage, the increament component in residule block could be 0 to obtain the stability of the training.</p>
</div>
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span>
<span class="normal"><a href="#__codelineno-16-40">40</a></span>
<span class="normal"><a href="#__codelineno-16-41">41</a></span>
<span class="normal"><a href="#__codelineno-16-42">42</a></span>
<span class="normal"><a href="#__codelineno-16-43">43</a></span>
<span class="normal"><a href="#__codelineno-16-44">44</a></span>
<span class="normal"><a href="#__codelineno-16-45">45</a></span>
<span class="normal"><a href="#__codelineno-16-46">46</a></span>
<span class="normal"><a href="#__codelineno-16-47">47</a></span>
<span class="normal"><a href="#__codelineno-16-48">48</a></span>
<span class="normal"><a href="#__codelineno-16-49">49</a></span>
<span class="normal"><a href="#__codelineno-16-50">50</a></span>
<span class="normal"><a href="#__codelineno-16-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SelfAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>    <span class="n">ATTENTION_MODES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"xformers"</span><span class="p">,</span> <span class="s2">"torch"</span><span class="p">,</span> <span class="s2">"torch-hb"</span><span class="p">,</span> <span class="s2">"math"</span><span class="p">,</span> <span class="s2">"debug"</span><span class="p">)</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a>        <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a>        <span class="n">num_heads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a>        <span class="n">qkv_bias</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>        <span class="n">qk_scale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a>        <span class="n">attn_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"xformers"</span><span class="p">,</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>        <span class="n">pre_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a>        <span class="n">qk_norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a>        <span class="n">rmsnorm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a>        <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a>        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a>    <span class="p">):</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">=</span> <span class="n">num_heads</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">//</span> <span class="n">num_heads</span>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">qkv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">qkv_bias</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a>        <span class="k">assert</span> <span class="n">attn_mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATTENTION_MODES</span>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attn_mode</span> <span class="o">=</span> <span class="n">attn_mode</span>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span> <span class="o">=</span> <span class="n">pre_only</span>
<a id="__codelineno-16-25" name="__codelineno-16-25"></a>        <span class="k">if</span> <span class="n">qk_norm</span> <span class="o">==</span> <span class="s2">"rms"</span><span class="p">:</span>
<a id="__codelineno-16-26" name="__codelineno-16-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_q</span> <span class="o">=</span> <span class="n">RMSNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-16-27" name="__codelineno-16-27"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_k</span> <span class="o">=</span> <span class="n">RMSNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-16-28" name="__codelineno-16-28"></a>        <span class="k">elif</span> <span class="n">qk_norm</span> <span class="o">==</span> <span class="s2">"ln"</span><span class="p">:</span>
<a id="__codelineno-16-29" name="__codelineno-16-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-16-30" name="__codelineno-16-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">,</span> <span class="n">elementwise_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-16-31" name="__codelineno-16-31"></a>        <span class="k">elif</span> <span class="n">qk_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-16-32" name="__codelineno-16-32"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_q</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<a id="__codelineno-16-33" name="__codelineno-16-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ln_k</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<a id="__codelineno-16-34" name="__codelineno-16-34"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-35" name="__codelineno-16-35"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">qk_norm</span><span class="p">)</span>
<a id="__codelineno-16-36" name="__codelineno-16-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pre_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-16-37" name="__codelineno-16-37"></a>        <span class="n">B</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-16-38" name="__codelineno-16-38"></a>        <span class="n">qkv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qkv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-16-39" name="__codelineno-16-39"></a>        <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">split_qkv</span><span class="p">(</span><span class="n">qkv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_dim</span><span class="p">)</span>
<a id="__codelineno-16-40" name="__codelineno-16-40"></a>        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_q</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-41" name="__codelineno-16-41"></a>        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_k</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-42" name="__codelineno-16-42"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<a id="__codelineno-16-43" name="__codelineno-16-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-16-44" name="__codelineno-16-44"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span>
<a id="__codelineno-16-45" name="__codelineno-16-45"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-16-46" name="__codelineno-16-46"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-16-47" name="__codelineno-16-47"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-16-48" name="__codelineno-16-48"></a>        <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-16-49" name="__codelineno-16-49"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">attention</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
<a id="__codelineno-16-50" name="__codelineno-16-50"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-16-51" name="__codelineno-16-51"></a>        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div>
In the Joint Block, only the <code>pre_attention</code> and <code>post_attention</code> are called.
The pre_attention did the linear transform and the layer norm of the Q,K,V in the self attention mechanics before sending to the attention function. The layer norm can be chosed from the standard layer normalization, or the RSM_layer normalization or just Identity<p></p>
<p>The post_attention did the linear transform of the output of the attention function. Increase the model capability, nothing special.</p>
</div>
</div>
</div>
<h4 id="443-condition-processing">4.4.3 Condition Processing<a class="headerlink" href="#443-condition-processing" title="Permanent link"></a></h4>
<p>Next, let's consider where the condition is from.</p>
<p>To have better prompt understanding, we used three text embedding models</p>
<ul>
<li><code>clip_g.safetensors</code> (openclip bigG, same as SDXL)</li>
<li><code>clip_l.safetensors</code> (OpenAI CLIP-L, same as SDXL)</li>
<li><code>t5xxl.safetensors</code> (google T5-v1.1-XXL)</li>
</ul>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-91.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-91.png"></a></p>
<div class="admonition note">
<p class="admonition-title">sd3 prompt processing</p>
<p>The prompt processing in Stable Diffusion 3 involves multiple steps and components designed to transform text input into embedding representations suitable for image generation. Here is a summary of the process:</p>
<ol>
<li>
<p><strong>Text Encoding</strong>:</p>
<ul>
<li>The input text is encoded using the CLIP model. There are two versions of the CLIP model: <code>Clip_L</code> and <code>Clip_G</code>, each generating embeddings of different dimensions.</li>
<li><code>Clip_L</code> produces a 77x768 embedding matrix.</li>
<li><code>Clip_G</code> produces a 75x768 embedding matrix.</li>
</ul>
</li>
<li>
<p><strong>Pooling Operation</strong>:</p>
<ul>
<li>Pooling operations are applied to the CLIP embeddings to generate fixed-size vectors.</li>
<li><code>L_pool</code> generates a 768-dimensional pooled vector.</li>
<li><code>G_pool</code> generates a 1280-dimensional pooled vector.</li>
</ul>
</li>
<li>
<p><strong>Embedding Concatenation</strong>:</p>
<ul>
<li>Embeddings from different sources are concatenated to create a richer representation.</li>
<li><code>L_pool</code> and <code>G_pool</code> are concatenated to form a 2048-dimensional pooled embedding vector.</li>
<li>The embedding sequences from <code>Clip_L</code> and <code>Clip_G</code> are concatenated to produce a 154x4096 embedding matrix.</li>
</ul>
</li>
<li>
<p><strong>Padding and Alignment</strong>:</p>
<ul>
<li>Zero padding (zeros padding) may be applied to ensure that the embedding sequences have consistent lengths.</li>
<li>For example, the embedding sequence from <code>G</code> is expanded from 75 to 154 to match the length of other embedding sequences.</li>
</ul>
</li>
<li>
<p><strong>Context Processing</strong>:</p>
<ul>
<li>The final embedding representations are used to provide context for image generation.</li>
<li>These embeddings are fed into the T5 model or other generative models for further processing to generate images.</li>
</ul>
</li>
</ol>
<p>In summary, the prompt processing in Stable Diffusion 3 transforms text input into high-dimensional embedding representations through multiple steps. These representations are then used to generate images. The process involves the collaboration of multiple models, including CLIP and T5, to ensure that the generated images are highly relevant to the input text.</p>
</div>
<p>We have studied the network structure of the MM-DiT. To summary, the MM-DiT's contribution is</p>
<ol>
<li>Use same idea of handling condition <code>c</code> by <mark>adaLN</mark></li>
<li>cross attention for the context (text/sequential information) and latent feature <code>x</code> by the dual path. Handle <code>context</code> and <code>x</code> seperatly but fed into attention by concating</li>
<li>use cropping positional embedding to support different resolution</li>
</ol>
<p>Let draw the overrall structure of the diffusion model</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/network_sd3.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/network_sd3.png"></a></p>
<h3 id="45-sd3-inference-methods">4.5 SD3 Inference Methods<a class="headerlink" href="#45-sd3-inference-methods" title="Permanent link"></a></h3>
<p>Let's consider the stable diffusion 3 inference details</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code>```py3
    def get_empty_latent(self, width, height):
        print("Prep an empty latent...")
        return torch.ones(1, 16, height // 8, width // 8, device="cpu") * 0.0609
    def gen_image(self, prompt=PROMPT, width=WIDTH, height=HEIGHT, steps=STEPS, cfg_scale=CFG_SCALE, seed=SEED, output=OUTPUT, init_image=INIT_IMAGE, denoise=DENOISE):
        latent = self.get_empty_latent(width, height)
        if init_image:
            image_data = Image.open(init_image)
            image_data = image_data.resize((width, height), Image.LANCZOS)
            latent = self.vae_encode(image_data)
            latent = SD3LatentFormat().process_in(latent)
        conditioning = self.get_cond(prompt)
        neg_cond = self.get_cond("")
        sampled_latent = self.do_sampling(latent, seed, conditioning, neg_cond, steps, cfg_scale, denoise if init_image else 1.0)
        image = self.vae_decode(sampled_latent)
        print(f"Will save to {output}")
        image.save(output)
        print("Done")
```
</code></pre></div></td></tr></tbody></table></div>
<p>Instead of sampling from the Gaussian distribution, the SD3 samples with either</p>
<ul>
<li>a fixed initial value <code>0.0609</code>.</li>
<li>given initial image</li>
</ul>
<p>The overall structure is still follow from LDM, that first doing the diffusion steps in latent space and then use VAE decode to recover the RGB image.</p>
<p>For the sampling steps, it includes</p>
<ol>
<li>positive prompt and negative prompt</li>
<li>CFG sampling with Euler steps</li>
</ol>
<h4 id="451-positive-prompt-and-negative-prompt">4.5.1 Positive prompt and negative prompt<a class="headerlink" href="#451-positive-prompt-and-negative-prompt" title="Permanent link"></a></h4>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code>```py3
    def do_sampling(self, latent, seed, conditioning, neg_cond, steps, cfg_scale, denoise=1.0) -&gt; torch.Tensor:
        print("Sampling...")
        latent = latent.half().cuda()
        self.sd3.model = self.sd3.model.cuda()
        noise = self.get_noise(seed, latent).cuda()
        sigmas = self.get_sigmas(self.sd3.model.model_sampling, steps).cuda()
        sigmas = sigmas[int(steps * (1 - denoise)):]
        conditioning = self.fix_cond(conditioning)
        neg_cond = self.fix_cond(neg_cond)
        extra_args = { "cond": conditioning, "uncond": neg_cond, "cond_scale": cfg_scale }
        noise_scaled = self.sd3.model.model_sampling.noise_scaling(sigmas[0], noise, latent, self.max_denoise(sigmas))
        latent = sample_euler(CFGDenoiser(self.sd3.model), noise_scaled, sigmas, extra_args=extra_args)
        latent = SD3LatentFormat().process_out(latent)
        self.sd3.model = self.sd3.model.cpu()
        print("Sampling done")
        return latent
```
</code></pre></div></td></tr></tbody></table></div>
<p>As mentioned in the above, the prompt will be processed into a pooled global embedding and a non-pooled sequential detail embedding. Consider both positive prompt and negative prompt, we will obtain two set of conditions</p>
<ul>
<li>cond</li>
<li>context</li>
<li>y</li>
<li>uncond</li>
<li>context</li>
<li>y</li>
</ul>
<p>In stable diffusion 3,
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-91.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-91.png"></a></p>
<p>But in practice, the negative prompt is empty string, which take the effect of the CFG, classifier free guidance diffusion. That is, the negative is the case the condition is empty.
Have more details in <a href="../../../chapter7_diffusion/sde_diffusion_guidance/">guidance diffusion</a></p>
<p>Next, let's check the detailed sampling steps if we have the condition already.</p>
<h4 id="452-sampling">4.5.2 Sampling<a class="headerlink" href="#452-sampling" title="Permanent link"></a></h4>
<h5 id="4521-cfg-denoiser">4.5.2.1 CFG Denoiser<a class="headerlink" href="#4521-cfg-denoiser" title="Permanent link"></a></h5>
<p>Here is the code of the CFG Denoiser, Have more details in <a href="../../../chapter7_diffusion/sde_diffusion_guidance/">guidance diffusion</a></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code>```py3
class CFGDenoiser(torch.nn.Module):
    """Helper for applying CFG Scaling to diffusion outputs"""
    def __init__(self, model):
        super().__init__()
        self.model = model

    def forward(self, x, timestep, cond, uncond, cond_scale):
        # Run cond and uncond in a batch together
        batched = self.model.apply_model(torch.cat([x, x]), torch.cat([timestep, timestep]), c_crossattn=torch.cat([cond["c_crossattn"], uncond["c_crossattn"]]), y=torch.cat([cond["y"], uncond["y"]]))
        # Then split and apply CFG Scaling
        pos_out, neg_out = batched.chunk(2)
        scaled = neg_out + (pos_out - neg_out) * cond_scale
        return scaled
```
</code></pre></div></td></tr></tbody></table></div>
<h5 id="4522-euler-smaple">4.5.2.2 Euler Smaple<a class="headerlink" href="#4522-euler-smaple" title="Permanent link"></a></h5>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code>```py3
def to_d(x, sigma, denoised):
    """Converts a denoiser output to a Karras ODE derivative."""
    return (x - denoised) / append_dims(sigma, x.ndim)

@torch.no_grad()
@torch.autocast("cuda", dtype=torch.float16)
def sample_euler(model, x, sigmas, extra_args=None):
    """Implements Algorithm 2 (Euler steps) from Karras et al. (2022)."""
    extra_args = {} if extra_args is None else extra_args
    s_in = x.new_ones([x.shape[0]])
    for i in range(len(sigmas) - 1):
        sigma_hat = sigmas[i]
        denoised = model(x, sigma_hat * s_in, **extra_args)
        d = to_d(x, sigma_hat, denoised)
        dt = sigmas[i + 1] - sigma_hat
        # Euler method
        x = x + d * dt
    return x
    ```
</code></pre></div></td></tr></tbody></table></div>
<p>The <strong>Euler method</strong> is a simple <strong>numerical integration technique</strong> used to solve ordinary differential equations (ODEs). The code you provided implements a <strong>modified Euler method</strong> for solving the <strong>Karras ODE</strong> in diffusion models. Below, I will compare this <strong>Euler-based sampler</strong> with the <strong>standard Euler method</strong>, highlighting the differences.</p>
<p><strong>Standard Euler Method</strong></p>
<p>The <strong>explicit (forward) Euler method</strong> is defined as:</p>
<div class="arithmatex">\[
x_{t-1} = x_t + f(x_t, t) \cdot dt
\]</div>
<p>where:</p>
<ul>
<li><span class="arithmatex">\( x_t \)</span> is the current state,</li>
<li><span class="arithmatex">\( f(x_t, t) \)</span> is the derivative (computed from an ODE),</li>
<li><span class="arithmatex">\( dt \)</span> is the step size.</li>
</ul>
<p>This method is used to <strong>approximate the solution of an ODE by taking small discrete steps</strong>.</p>
<p><strong>Equation in Diffusion Models</strong>
Diffusion models can be formulated as an <strong>ODE</strong>:</p>
<div class="arithmatex">\[
\frac{d x}{d t} = f(x, t) = \frac{x - \text{denoised}(x)}{\sigma}
\]</div>
<p>Using the Euler update rule:</p>
<div class="arithmatex">\[
x_{t-1} = x_t + \frac{x_t - \text{denoised}(x_t)}{\sigma} \cdot dt
\]</div>
<p>where:</p>
<ul>
<li><span class="arithmatex">\( \frac{x_t - \text{denoised}(x_t)}{\sigma} \)</span> acts as the ODE derivative.</li>
<li><span class="arithmatex">\( dt \)</span> is the time step, determined by the noise schedule.</li>
</ul>
<p>This is an <strong>explicit Euler step</strong> applied to a diffusion model.</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Standard Euler</th>
<th>Diffusion Euler (Karras ODE)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ODE Formulation</strong></td>
<td>General-purpose ODE</td>
<td>Diffusion-specific ODE</td>
</tr>
<tr>
<td><strong>Derivative Function <span class="arithmatex">\( f(x, t) \)</span></strong></td>
<td>Predefined function</td>
<td>Computed via denoiser</td>
</tr>
<tr>
<td><strong>Step Size <span class="arithmatex">\( dt \)</span></strong></td>
<td>Fixed</td>
<td>Adaptive (determined by noise schedule)</td>
</tr>
<tr>
<td><strong>Dynamical Behavior</strong></td>
<td>General ODE integration</td>
<td>Guides noise removal</td>
</tr>
<tr>
<td><strong>Goal</strong></td>
<td>Solve ODE</td>
<td>Generate images from noise</td>
</tr>
</tbody>
</table>
<ol>
<li>
<p><strong>Standard Euler computes derivatives directly from an ODE function <span class="arithmatex">\( f(x, t) \)</span></strong>.</p>
<ul>
<li>In contrast, <strong>Diffusion Euler estimates the derivative from the denoising model</strong>.</li>
</ul>
</li>
<li>
<p><strong>Standard Euler uses a fixed step size <span class="arithmatex">\( dt \)</span>, whereas Diffusion Euler uses an adaptive step size <span class="arithmatex">\( dt = \sigma_{t+1} - \sigma_t \)</span></strong>.</p>
<ul>
<li>This makes the diffusion process more flexible.</li>
</ul>
</li>
<li>
<p><strong>In diffusion models, the score function (or denoiser) acts as an implicit ODE solver</strong>.</p>
<ul>
<li>The model learns how to remove noise at different levels, effectively solving the reverse SDE (stochastic differential equation) using an ODE approximation.</li>
</ul>
</li>
</ol>
<h2 id="5-references">5. References<a class="headerlink" href="#5-references" title="Permanent link"></a></h2>
<ul>
<li>stable diffusion 3 reading: <a href="https://zhuanlan.zhihu.com/p/684068402?utm_source=chatgpt.com">https://zhuanlan.zhihu.com/p/684068402?utm_source=chatgpt.com</a></li>
<li><a href="https://github.com/Stability-AI/sd3-ref">sd 3 inference code</a></li>
<li><a href="https://github.com/huggingface/diffusers/blob/main/examples/instruct_pix2pix/train_instruct_pix2pix_sdxl.py">Instruct Training script based on SD3</a></li>
<li><a href="https://github.com/haoningwu3639/SimpleSDM-3">Flexible PyTorch implementation of StableDiffusion-3 based on  diffusers</a></li>
<li><a href="https://stabilityai.notion.site/Stable-Diffusion-3-Medium-Fine-tuning-Tutorial-17f90df74bce4c62a295849f0dc8fb7e">Stable Diffusion 3 Fintune Guide</a></li>
</ul>







  
  



  






<script type="application/json" class="js-hypothesis-config">
{
  "openSidebar": false,
  "showHighlights": true,
  "theme": "clean"
}
</script>
<script async src="https://hypothes.is/embed.js"></script>

<!-- Hypothesis  -->
<style>
  /*  */
  .hypothesis-highlight {
    background-color: transparent !important; /*  */
    text-decoration: underline !important;
    text-decoration-color: #4285f4 !important;
    text-decoration-thickness: 2px !important;
    text-decoration-style: wavy !important;
    position: relative !important;
    cursor: pointer !important;
    border-bottom: none !important; /*  */
    box-shadow: none !important; /*  */
  }

  .hypothesis-highlight::after {
    content: "" !important;
    position: absolute !important;
    display: inline-block !important;
    font-size: 14px !important;
    top: -10px !important;
    right: -5px !important;
    opacity: 0.7 !important;
    transition: opacity 0.3s ease !important;
  }

  .hypothesis-highlight:hover {
    background-color: rgba(66, 133, 244, 0.08) !important; /*  */
  }

  .hypothesis-highlight:hover::after {
    opacity: 1 !important;
    transform: scale(1.2) !important;
  }

  /*  Hypothesis  */
  hypothesis-sidebar {
    font-family: var(--md-text-font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif) !important;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1) !important;
  }

  /*  */
  .hypothesis-annotation-card {
    border-radius: 8px !important;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05) !important;
    transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    overflow: hidden !important;
  }

  .hypothesis-annotation-card:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
  }

  /*  Hypothesis  */
  .hypothesis-button {
    border-radius: 4px !important;
    transition: background-color 0.2s ease !important;
  }

  /*  */
  .hypothesis-tag {
    border-radius: 12px !important;
    padding: 2px 8px !important;
    font-size: 12px !important;
    background-color: rgba(0, 0, 0, 0.05) !important;
    color: #606060 !important;
  }

  /*  */
  .hypothesis-toolbar {
    background: linear-gradient(to right, #f5f5f5, #ffffff) !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
  }

  /* header */
  .hypothesis-annotation-header {
    padding: 10px !important;
    background-color: #f9f9f9 !important;
  }

  /*  */
  .hypothesis-annotation-body {
    font-size: 14px !important;
    line-height: 1.6 !important;
    color: #333 !important;
  }

  /*  */
  .hypothesis-user {
    font-weight: 600 !important;
    color: #3f51b5 !important;
  }

  /*  */
  .hypothesis-timestamp {
    font-size: 12px !important;
    color: #757575 !important;
  }

  /*  */
  .hypothesis-input {
    border-radius: 4px !important;
    border: 1px solid #e0e0e0 !important;
    transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
  }

  .hypothesis-input:focus {
    border-color: #4dabf7 !important;
    box-shadow: 0 0 0 2px rgba(77, 171, 247, 0.2) !important;
    outline: none !important;
  }
</style>

<!--  -->
<div class="comments-container utterances-container">
  <div class="comments-header">
    <h2 id="__comments" class="comments-title">
      <span class="comments-icon"></span>
      Comments
      <span class="comments-subtitle">Share your thoughts!</span>
    </h2>
    <div class="comments-divider"></div>
  </div>

  <div class="comments-wrapper">
    <script src="https://utteranc.es/client.js" repo="MAD-SG/generative-ai-start-to-surrender" issue-term="pathname" label="comment" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>
  </div>
</div>

<style>
  .comments-container {
    margin: 2.5rem auto;
    padding: 1.5rem;
    background: var(--md-code-bg-color, rgba(0, 0, 0, 0.05));
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .annotation-container {
    margin-bottom: 1rem;
    background: rgba(255, 255, 240, 0.5);
    border-left: 4px solid #ffeb3b;
  }

  .utterances-container {
    background: rgba(240, 248, 255, 0.5);
    border-left: 4px solid #2196f3;
  }

  .comments-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
  }

  .comments-header {
    margin-bottom: 1.5rem;
  }

  .comments-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0;
    margin-bottom: 0.75rem;
    color: var(--md-primary-fg-color, #2196f3);
    flex-wrap: wrap;
  }

  .annotation-container .comments-title {
    color: #f57c00;
  }

  .comments-icon {
    font-size: 1.4em;
  }

  .comments-subtitle {
    font-size: 0.7em;
    font-weight: 400;
    opacity: 0.8;
    margin-left: 1rem;
  }

  .comments-divider {
    height: 3px;
    background: linear-gradient(90deg,
      var(--md-primary-fg-color, #2196f3) 0%,
      rgba(255, 255, 255, 0) 100%);
    border-radius: 3px;
    margin-bottom: 1rem;
    width: 100%;
  }

  .annotation-container .comments-divider {
    background: linear-gradient(90deg,
      #f57c00 0%,
      rgba(255, 255, 255, 0) 100%);
  }

  .comments-wrapper {
    position: relative;
    min-height: 150px;
    width: 100%;
  }

  .hypothesis-instructions {
    padding: 1rem;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 6px;
    margin-bottom: 1rem;
  }

  .hypothesis-instructions p {
    margin-top: 0;
    font-weight: 500;
  }

  .hypothesis-instructions ol {
    margin-bottom: 0;
    padding-left: 1.5rem;
  }

  .hypothesis-instructions li {
    margin-bottom: 0.5rem;
  }

  .hypothesis-instructions li:last-child {
    margin-bottom: 0;
  }

  /* utterancesiframe */
  .utterances-container .comments-wrapper iframe {
    border-radius: 6px;
    width: 100% !important;
    max-width: 100% !important;
  }

  /*  */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translate3d(0, 20px, 0);
    }
    to {
      opacity: 1;
      transform: translate3d(0, 0, 0);
    }
  }

  .comments-wrapper {
    animation: fadeInUp 0.6s ease forwards;
  }

  /*  -  */
  @media (max-width: 768px) {
    .comments-container {
      padding: 1rem;
      margin: 1.5rem auto;
    }

    .comments-title {
      font-size: 1.3rem;
    }

    .comments-subtitle {
      display: block;
      width: 100%;
      margin-left: 0;
      margin-top: 0.3rem;
    }
  }
</style>
                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../stable_diffusion_xl/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Stable Diffusion XL">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Stable Diffusion XL
              </div>
            </div>
          </a>
        
        
          
          <a href="../stable_diffusion_3_5_reading/" class="md-footer__link md-footer__link--next" aria-label="Next: Stable Diffusion 3.5">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Stable Diffusion 3.5
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://mad-sg.github.io/generative-ai-start-to-surrender/" target="_blank" rel="noopener" title="mad-sg.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://hub.docker.com/r/squidfunk/mkdocs-material/" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/mkdocs-material/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://bsky.app/profile/squidfunk.bsky.social" target="_blank" rel="noopener" title="bsky.app" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M407.8 294.7c-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3M288 227.1c-26.1-50.7-97.1-145.2-163.1-191.8C61.6-9.4 37.5-1.7 21.6 5.5 3.3 13.8 0 41.9 0 58.4S9.1 194 15 213.9c19.5 65.7 89.1 87.9 153.2 80.7 3.3-.5 6.6-.9 10-1.4-3.3.5-6.6 1-10 1.4-93.9 14-177.3 48.2-67.9 169.9C220.6 589.1 265.1 437.8 288 361.1c22.9 76.7 49.2 222.5 185.6 103.4 102.4-103.4 28.1-156-65.8-169.9-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3 64.1 7.1 133.6-15.1 153.2-80.7C566.9 194 576 75 576 58.4s-3.3-44.7-21.6-52.9c-15.8-7.1-40-14.9-103.2 29.8C385.1 81.9 314.1 176.4 288 227.1"></path></svg>
    </a>
  
    
    
      
    
    
    
      
      
    
    <a href="https://fosstodon.org/@squidfunk" target="_blank" rel="noopener me" title="fosstodon.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M433 179.1c0-97.2-63.7-125.7-63.7-125.7-62.5-28.7-228.6-28.4-290.5 0 0 0-63.7 28.5-63.7 125.7 0 115.7-6.6 259.4 105.6 289.1 40.5 10.7 75.3 13 103.3 11.4 50.8-2.8 79.3-18.1 79.3-18.1l-1.7-36.9s-36.3 11.4-77.1 10.1c-40.4-1.4-83-4.4-89.6-54-.6-4.6-.9-9.3-.9-13.9 85.6 20.9 158.7 9.1 178.7 6.7 56.1-6.7 105-41.3 111.2-72.9 9.8-49.8 9-121.5 9-121.5zm-75.1 125.2h-46.6V190.1c0-49.7-64-51.6-64 6.9v62.5H201V197c0-58.5-64-56.6-64-6.9v114.2H90.3c0-122.1-5.2-147.9 18.4-175 25.9-28.9 79.8-30.8 103.8 6.1l11.6 19.5 11.6-19.5c24.1-37.1 78.1-34.8 103.8-6.1 23.7 27.3 18.4 53 18.4 175"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://x.com/squidfunk" target="_blank" rel="noopener" title="x.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M357.2 48h70.6L273.6 224.2 455 464H313L201.7 318.6 74.5 464H3.8l164.9-188.5L-5.2 48h145.6l100.5 132.9zm-24.8 373.8h39.1L119.1 88h-42z"></path></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.tabs", "toc.integrate", "content.code.copy", "content.code.select", "content.code.annotate", "content.tabs.link", "content.footnote.tooltips", "content.tooltips", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.expand", "search.share", "search.suggest"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.26.1/minified.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html><!-- 
<div class="comments-container annotation-container">
  <div class="comments-header">
    <h2 id="__annotations" class="comments-title">
      <span class="comments-icon"></span>
      
      <span class="comments-subtitle">!</span>
    </h2>
    <div class="comments-divider"></div>
  </div>

  <div class="comments-wrapper">
    <div class="hypothesis-instructions">
      <p><strong></strong></p>
      <ol>
        <li> <img src="https://hypothes.is/assets/images/logo.png" alt="Hypothesis" style="height: 16px; vertical-align: middle;"> </li>
        <li></li>
        <li></li>
      </ol>
    </div>
  </div>
</div> --><!--   -->