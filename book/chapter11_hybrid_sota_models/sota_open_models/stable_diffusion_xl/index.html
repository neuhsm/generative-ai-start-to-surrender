<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../stable_diffusion_series/">
      
      
        <link rel="next" href="../stable_diffusion_3_reading/">
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Stable Diffusion XL - Generative AI: From Start to Surrender</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#stable-diffusion-sdxl" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Generative AI: From Start to Surrender" class="md-header__button md-logo" aria-label="Generative AI: From Start to Surrender" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Generative AI: From Start to Surrender
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Stable Diffusion XL
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo" aria-label="Switch to system preference" type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter1_Introduction/1.1terminology/" class="md-tabs__link">
          
  
  
    
  
  Introduction

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter2_generation_theory/mle/" class="md-tabs__link">
          
  
  
    
  
  Generation Theory

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter3_energy_based_model/introduction/" class="md-tabs__link">
          
  
  
    
  
  Energy Based Models

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter6_VAE/vae_introduction/" class="md-tabs__link">
          
  
  
    
  
  VAE

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter5_GAN/3.1from_gan_to_stylegan/paper/" class="md-tabs__link">
          
  
  
    
  
  GANs

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter7_diffusion/ddpm/" class="md-tabs__link">
          
  
  
    
  
  Diffusion Models

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter9_flow_matching/introduction/" class="md-tabs__link">
          
  
  
    
  
  Flow Matching

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../hybrid_methods/" class="md-tabs__link">
          
  
  
    
  
  Hybrid SOTA Models

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter12_applications/diffusion_anomaly_detection/" class="md-tabs__link">
          
  
  
    
  
  Application

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Generative AI: From Start to Surrender" class="md-nav__button md-logo" aria-label="Generative AI: From Start to Surrender" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    Generative AI: From Start to Surrender
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Introduction
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.1terminology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terms
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.2fourier_transform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fourier Transform
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.3signal_processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Signal Processing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.4statistics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Statistics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Generation Theory
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Generation Theory
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter2_generation_theory/mle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Maximal Likelihood
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter2_generation_theory/manifold_hypothesis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Manifold Hypothesis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter2_generation_theory/generative_model_category/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Generative Model Category
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4">
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Energy Based Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Energy Based Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/score_function/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Score Functions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/sampling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sampling Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/cd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contrastive Divergence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/score_matching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Score Matching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5">
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    VAE
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    VAE
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter6_VAE/vae_introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter6_VAE/vq_vae/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VA-VAE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6">
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    GANs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    GANs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.1from_gan_to_stylegan/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    From GAN to StyleGAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_2">
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN Variants
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    StyleGAN Variants
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.3stylegan/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.4stylegan2/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.5stylegan3/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.6styleganT/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN-T
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.7R3Gan/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    R3GAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/vq_gan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VQ-GAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7">
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diffusion Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1">
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Discrete Diffusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Discrete Diffusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/ddpm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DDPM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/ldm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LDM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/ldm_handson/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LDM Handson
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/diffusion_model_varients/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Model Varients
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/general_diffusion_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    General Diffusion Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_2">
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    SDE Diffusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    SDE Diffusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/introduction_sde/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE Fundamentals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/from_ddpm_2_sde/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE for DDPM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/score_based_sde/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Score Based SDE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/probability_flow_ode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Probability Flow ODE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/sde_diffusion_speedup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE Diffusion Speedup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/sde_diffusion_unified_representation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scaling and Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_3">
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Network
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diffusion Network
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/DiT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DiT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_4">
        
          
          <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Solver
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diffusion Solver
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/diffusion_solver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DPM Solver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_5">
        
          
          <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Conditional Diffusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Conditional Diffusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/controlnet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ControlNet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/sde_diffusion_guidance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE Diffusion Guidance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8">
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Flow Matching
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Flow Matching
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/probability_with_velocity_field/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Probability Path and Velocity Fields
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/flow_matching_theory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flow Matching Theorem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/affine_conditional_flows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Affine Conditional Flow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/optimal_transport_flow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Optimal Transport Flow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/comparison_with_flow_ode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comparison with Diffusion Flow ODE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Hybrid SOTA Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Hybrid SOTA Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hybrid_methods/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sota_closed_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Closed Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3" checked>
        
          
          <label class="md-nav__link" for="__nav_9_3" id="__nav_9_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Open Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Open Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dalle_series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dalle Series
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_9_3_2" id="__nav_9_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion Series
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Stable Diffusion Series
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stable_diffusion_series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion XL
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion XL
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Architecture
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-network-stucture" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 Network stucture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-condition-no-image-size" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Condition no image size
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-condition-on-cropping-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Condition on cropping parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-condition-on-aspect-ratio" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.4 Condition on aspect ratio
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-improved-autoencoder" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.5 Improved autoencoder
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-experiment" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Experiment
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Experiment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-final-model-sdxl-training-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Final Model (SDXL) Training Overview:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-stage-1-base-model-pretraining" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Stage 1 â€“ Base Model Pretraining:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-stage-2-continued-training-on-higher-resolution" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 Stage 2 â€“ Continued Training on Higher Resolution:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-stage-3-multi-aspect-training" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4 Stage 3 â€“ Multi-Aspect Training:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-optional-refinement-stage" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.5 Optional Refinement Stage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-limitation" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Limitation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-codes" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Codes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Codes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-diffusoin-engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Diffusoin Engine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-denoise" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 Denoise
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-conditioner" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 Conditioner
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-standarddiffusionloss" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5 StandardDiffusionLoss
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stable_diffusion_3_reading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion 3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stable_diffusion_3_5_reading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion 3.5
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9_3_3">
        
          
          <label class="md-nav__link" for="__nav_9_3_3" id="__nav_9_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Flux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Flux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flux1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flux.1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flux.1_kontext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flux.1 Kontext
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../qwen_image/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Qwen-Image
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trends_future/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Future Trends
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10">
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Application
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Application
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_1">
        
          
          <label class="md-nav__link" for="__nav_10_1" id="__nav_10_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Anomaly Detection
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Anomaly Detection
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/diffusion_anomaly_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Anomaly Detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_2">
        
          
          <label class="md-nav__link" for="__nav_10_2" id="__nav_10_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Deepfake Detection
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Deepfake Detection
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection_structured/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    æ€»è§ˆ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/FOCAL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FOCAL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/PSCC-Net/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PSCC-Net
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/DeCLIP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DeCLIP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/FakeLocator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FakeLocator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/Weakly-supervised-Deepfake-Localization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Weakly-supervised Deepfake Localization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/FSBI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FSBI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/DE-FAKE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DE-FAKE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/DADF/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DADF
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/SIDA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SIDA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/UnivCLIP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UnivCLIP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/Multi-Attention-Based-Approach/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Attention-Based-Approach
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/Mastering-Deepfake-Detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mastering-Deepfake-Detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/Leveraging-Frequency-Analysis-for-Deep-Fake-Image-Recognition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Leveraging-Frequency-Analysis-for-Deep-Fake-Image-Recognition
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/An-Analysis-of-Recent-Advances-in-Deepfake-Image-Detection-in-an-Evolving-Threat-Landscape/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    An-Analysis-of-Recent-Advances-in-Deepfake-Image-Detection-in-an-Evolving-Threat-Landscape
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="stable-diffusion-sdxl">Stable Diffusion SDXL<a class="headerlink" href="#stable-diffusion-sdxl" title="Permanent link">Â¶</a></h1>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/Unknown-2.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/Unknown-2.png"></a></p>
<ul>
<li>repo: <a href="https://github.com/Stability-AI/generative-models">https://github.com/Stability-AI/generative-models</a></li>
<li>paper: /<a href="https://arxiv.org/pdf/2307.01952">https://arxiv.org/pdf/2307.01952</a></li>
<li>date: 2023 July</li>
<li>Main changes</li>
<li>Three times large UNet</li>
<li>Second text encoder</li>
<li>novel conditioning schemes</li>
<li>train on multiple aspect ratios</li>
<li>refinement model to improve the visual fidelity</li>
</ul>
<h2 id="1-architecture">1. Architecture<a class="headerlink" href="#1-architecture" title="Permanent link">Â¶</a></h2>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-58.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-58.png"></a>
Participants were asked to choose their favorite image generation among four models, the results are show above.</p>
<h3 id="11-network-stucture">1.1 Network stucture<a class="headerlink" href="#11-network-stucture" title="Permanent link">Â¶</a></h3>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-59.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-59.png"></a></p>
<ul>
<li>VAE:</li>
<li>VAE is almost the same, but it implemented a meomory Efficient Scross Attention, which used the package <code>xformers</code></li>
</ul>
<h3 id="12-condition-no-image-size">1.2 Condition no image size<a class="headerlink" href="#12-condition-no-image-size" title="Permanent link">Â¶</a></h3>
<p>Previous training discard images under 512 pixels which could discard large portion of data, lead to a loss in performance and generalization</p>
<p>we provide the original (i.e., before any rescaling) height and width of the images as an additional conditioning to the model csize = (h-original,w-original). Each component is independently embedded using a Fourier feature encoding, and these encodings are concatenated into a single vector that we feed into the model by adding it to the timestep embedding</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-60.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-60.png"></a></p>
<h3 id="13-condition-on-cropping-parameters">1.3 Condition on cropping parameters<a class="headerlink" href="#13-condition-on-cropping-parameters" title="Permanent link">Â¶</a></h3>
<p>Random cropping during training coulde leads to incomplete generation like the following. So we put it in the condition and set (<span class="arithmatex">\(c_top,c_left\)</span>) be zeros to obtained the object centered samples. Further, we can tune the two parameters to simulate the amount of cropping during inference.
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-61.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-61.png"></a>
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-62.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-62.png"></a></p>
<ul>
<li>Method
    During dataloading, we uniformly sample crop coordinates ctop and cleft (integers specifying the amount of pixels cropped from the top-left corner along the height and width axes, respectively) and feed them into the model as conditioning parameters via Fourier feature embeddings, similar to the size conditioning described above</li>
</ul>
<h3 id="14-condition-on-aspect-ratio">1.4 Condition on aspect ratio<a class="headerlink" href="#14-condition-on-aspect-ratio" title="Permanent link">Â¶</a></h3>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code>Most text2image models produces saure images.
- Trainig tricks
  - Prepare different bukets of images, each bucket has the same shape, while the total number of pixels is approximaly $1024^2$.
  - During training, single batch comes from same bucket, and change the bucket for different step in the training loop
- Condition tricks
  - similar to the size condition and crop-parameter condition, the target shape $(h_{target},w_{target})$ is embedded into a Fourier space
</code></pre></div></td></tr></tbody></table></div>
<h3 id="15-improved-autoencoder">1.5 Improved autoencoder<a class="headerlink" href="#15-improved-autoencoder" title="Permanent link">Â¶</a></h3>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>1. used ema in training
2. large batchsize 9-&gt; 256
![alt text](../../../images/image-63.png)
</code></pre></div></td></tr></tbody></table></div>
<h2 id="2-experiment">2. Experiment<a class="headerlink" href="#2-experiment" title="Permanent link">Â¶</a></h2>
<h3 id="21-final-model-sdxl-training-overview">2.1 <strong>Final Model (SDXL) Training Overview:</strong><a class="headerlink" href="#21-final-model-sdxl-training-overview" title="Permanent link">Â¶</a></h3>
<ul>
<li>SDXL is trained using a multi-stage procedure.</li>
<li>It uses the autoencoder described in Sec. 2.4.</li>
<li>A discrete-time diffusion schedule with 1000 steps [14, 45] is employed.</li>
</ul>
<h3 id="22-stage-1-base-model-pretraining">2.2 <strong>Stage 1 â€“ Base Model Pretraining:</strong><a class="headerlink" href="#22-stage-1-base-model-pretraining" title="Permanent link">Â¶</a></h3>
<ul>
<li>Pretrain a base model (see Tab. 1) on an internal dataset.</li>
<li>The datasetâ€™s height and width distribution is visualized in Fig. 2.</li>
<li>Training is performed for 600,000 optimization steps.</li>
<li>Images are at a resolution of 256Ã—256 pixels.</li>
<li>A batch size of 2048 is used.</li>
<li>Size- and crop-conditioning is applied as described in Sec. 2.2.</li>
</ul>
<h3 id="23-stage-2-continued-training-on-higher-resolution">2.3 <strong>Stage 2 â€“ Continued Training on Higher Resolution:</strong><a class="headerlink" href="#23-stage-2-continued-training-on-higher-resolution" title="Permanent link">Â¶</a></h3>
<ul>
<li>Continue training on images resized to 512Ã—512 pixels.</li>
<li>Training is performed for an additional 200,000 optimization steps.</li>
</ul>
<h3 id="24-stage-3-multi-aspect-training">2.4 <strong>Stage 3 â€“ Multi-Aspect Training:</strong><a class="headerlink" href="#24-stage-3-multi-aspect-training" title="Permanent link">Â¶</a></h3>
<ul>
<li>Utilize multi-aspect training (Sec. 2.3) combined with an offset-noise level of 0.05 [11, 25].</li>
<li>Train the model on images with different aspect ratios (Sec. 2.3, App. I) covering an approximate area of 1024Ã—1024 pixels.</li>
</ul>
<h3 id="25-optional-refinement-stage">2.5 <strong>Optional Refinement Stage</strong><a class="headerlink" href="#25-optional-refinement-stage" title="Permanent link">Â¶</a></h3>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>![alt text](../../../images/image-64.png)
</code></pre></div></td></tr></tbody></table></div>
<h4 id="251-observed-issue">2.5.1 <strong>Observed Issue:</strong><a class="headerlink" href="#251-observed-issue" title="Permanent link">Â¶</a></h4>
<ul>
<li>The base model sometimes produces samples with low local quality</li>
</ul>
<h4 id="252-solution-to-improve-sample-quality">2.5.2 <strong>Solution to Improve Sample Quality:</strong><a class="headerlink" href="#252-solution-to-improve-sample-quality" title="Permanent link">Â¶</a></h4>
<ul>
<li><strong>Training a Separate Refinement Model:</strong></li>
<li>A separate latent diffusion model (LDM) is trained in the same latent space.</li>
<li>This refinement LDM is specialized on high-quality, high-resolution data.</li>
<li>It employs a noising-denoising process as introduced by SDEdit [28].</li>
<li>The refinement model is specialized on the first 200 discrete noise scales (following [1]).</li>
</ul>
<h4 id="253-inference-process-with-refinement">2.5.3 <strong>Inference Process with Refinement:</strong><a class="headerlink" href="#253-inference-process-with-refinement" title="Permanent link">Â¶</a></h4>
<ul>
<li>Render latents from the base SDXL using the same text input.</li>
<li>Directly diffuse and denoise these latents in the latent space with the refinement model
    <a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../../images/image-65.png" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-65.png"></a></li>
<li><strong>Optional Step:</strong></li>
<li>Although this refinement step is optional, it improves sample qualityâ€”especially for detailed backgrounds and human faces</li>
</ul>
<h2 id="3-limitation">3. Limitation<a class="headerlink" href="#3-limitation" title="Permanent link">Â¶</a></h2>
<ul>
<li>
<p><strong>Difficulty with Intricate Structures:</strong>
  The model sometimes struggles with synthesizing fine details in complex structures (e.g., human hands) due to high variance and the challenge of extracting accurate 3D shape information.</p>
</li>
<li>
<p><strong>Imperfect Photorealism:</strong>
  While the generated images are very realistic, they may lack certain nuances such as subtle lighting effects or fine texture variations.</p>
</li>
<li>
<p><strong>Biases in Training Data:</strong>
  The heavy reliance on large-scale datasets can inadvertently introduce social and racial biases, which may be reflected in the generated outputs.</p>
</li>
<li>
<p><strong>Concept Bleeding:</strong>
  The model can sometimes merge or incorrectly bind attributes between distinct objects (e.g., mixing up the colors of a hat and gloves or an orange sunglass bleeding from an orange sweater).</p>
</li>
<li>
<p><strong>Text Rendering Issues:</strong>
  The model encounters challenges in rendering long, legible text, occasionally producing random characters or inconsistent text output.</p>
</li>
</ul>
<h2 id="4-codes">4. Codes<a class="headerlink" href="#4-codes" title="Permanent link">Â¶</a></h2>
<h3 id="41-diffusoin-engine">4.1 Diffusoin Engine<a class="headerlink" href="#41-diffusoin-engine" title="Permanent link">Â¶</a></h3>
<p>The latent diffusion class is refactored compared with LDM.
There are seperate modules</p>
<ol>
<li>model</li>
<li>denoiser</li>
<li>sampler</li>
<li>conditioner</li>
<li>scheduler</li>
<li>loss_fn</li>
<li>ema</li>
</ol>
<p>Now let's check the training steps compared with stable diffusion v2</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio"><input id="__tabbed_1_2" name="__tabbed_1" type="radio"><input id="__tabbed_1_3" name="__tabbed_1" type="radio"><div class="tabbed-labels"><label for="__tabbed_1_1">encode_first_stage</label><label for="__tabbed_1_2">forward</label><label for="__tabbed_1_3">loss</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode_first_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">en_and_decode_n_samples_a_time</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="n">n_rounds</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_samples</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="n">all_out</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="s2">"cuda"</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_first_stage_autocast</span><span class="p">):</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rounds</span><span class="p">):</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_stage_model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>                    <span class="n">x</span><span class="p">[</span><span class="n">n</span> <span class="o">*</span> <span class="n">n_samples</span> <span class="p">:</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_samples</span><span class="p">]</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>                <span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>                <span class="n">all_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">*</span> <span class="n">z</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="k">return</span> <span class="n">z</span>
</code></pre></div></td></tr></tbody></table></div>
the difference is that the encoding split the batch into sub batches to save memory, which may due to the larger training batchsize<p></p>
</div>
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">forward</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span>
<span class="normal"><a href="#__codelineno-1-5">5</a></span>
<span class="normal"><a href="#__codelineno-1-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shared_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_first_stage</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>        <span class="n">batch</span><span class="p">[</span><span class="s2">"global_step"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>        <span class="n">loss</span><span class="p">,</span> <span class="n">loss_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">loss_dict</span>
</code></pre></div></td></tr></tbody></table></div>
Exactly the same<p></p>
</div>
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">loss config</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="w">    </span><span class="nt">loss_fn_config</span><span class="p">:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.diffusionmodules.loss.StandardDiffusionLoss</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">        </span><span class="nt">loss_weighting_config</span><span class="p">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.diffusionmodules.loss_weighting.EpsWeighting</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">        </span><span class="nt">sigma_sampler_config</span><span class="p">:</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.diffusionmodules.sigma_sampling.DiscreteSampling</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">        </span><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">            </span><span class="nt">num_idx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">            </span><span class="nt">discretization_config</span><span class="p">:</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">            </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.diffusionmodules.discretizer.LegacyDDPMDiscretization</span>
</code></pre></div></td></tr></tbody></table></div>
the loss is defined seperately, we will lookinto the details in following sections<p></p>
</div>
</div>
</div>
<h3 id="42-model">4.2 Model<a class="headerlink" href="#42-model" title="Permanent link">Â¶</a></h3>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>    network_config:
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>    target: sgm.modules.diffusionmodules.openaimodel.UNetModel
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>    params:
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>        use_checkpoint: True
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>        in_channels: 4
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>        out_channels: 4
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>        model_channels: 320
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>        attention_resolutions: [1, 2, 4]
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>        num_res_blocks: 2
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>        channel_mult: [1, 2, 4, 4]
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>        num_head_channels: 64
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>        num_classes: sequential
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>        adm_in_channels: 1792
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>        num_heads: 1
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>        transformer_depth: 1
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>        context_dim: 768
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>        spatial_transformer_attn_type: softmax-xformers
</code></pre></div></td></tr></tbody></table></div>
<p>use the same vae structure compared with stable diffusion v2</p>
<h3 id="43-denoise">4.3 Denoise<a class="headerlink" href="#43-denoise" title="Permanent link">Â¶</a></h3>
<div class="tabbed-set tabbed-alternate" data-tabs="2:4"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio"><input id="__tabbed_2_2" name="__tabbed_2" type="radio"><input id="__tabbed_2_3" name="__tabbed_2" type="radio"><input id="__tabbed_2_4" name="__tabbed_2" type="radio"><div class="tabbed-labels"><label for="__tabbed_2_1">Config</label><label for="__tabbed_2_2">DiscreteDenoiser</label><label for="__tabbed_2_3">discritilization</label><label for="__tabbed_2_4">Scaling</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span>
<span class="normal"><a href="#__codelineno-4-5">5</a></span>
<span class="normal"><a href="#__codelineno-4-6">6</a></span>
<span class="normal"><a href="#__codelineno-4-7">7</a></span>
<span class="normal"><a href="#__codelineno-4-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nt">denoiser_config</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.diffusionmodules.denoiser.DiscreteDenoiser</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="nt">num_idx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="nt">scaling_config</span><span class="p">:</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.diffusionmodules.denoiser_scaling.EpsScaling</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="nt">discretization_config</span><span class="p">:</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.diffusionmodules.discretizer.LegacyDDPMDiscretization</span>
</code></pre></div></td></tr></tbody></table></div>
the module also contains two sub modeuls, denoiser scaling and discretizer<p></p>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">DiscreteDenoiser</span><span class="p">(</span><span class="n">Denoiser</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="n">scaling_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>    <span class="n">num_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>    <span class="n">discretization_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="n">do_append_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>    <span class="n">quantize_c_noise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="n">flip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="p">):</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">scaling_config</span><span class="p">)</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">discretization</span><span class="p">:</span> <span class="n">Discretization</span> <span class="o">=</span> <span class="n">instantiate_from_config</span><span class="p">(</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>        <span class="n">discretization_config</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>    <span class="p">)</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>    <span class="n">sigmas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discretization</span><span class="p">(</span><span class="n">num_idx</span><span class="p">,</span> <span class="n">do_append_zero</span><span class="o">=</span><span class="n">do_append_zero</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="n">flip</span><span class="p">)</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">"sigmas"</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">)</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">quantize_c_noise</span> <span class="o">=</span> <span class="n">quantize_c_noise</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_idx</span> <span class="o">=</span> <span class="n">num_idx</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="k">def</span><span class="w"> </span><span class="nf">sigma_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a>    <span class="n">dists</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a>    <span class="k">return</span> <span class="n">dists</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">sigma</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">idx_to_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmas</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="k">def</span><span class="w"> </span><span class="nf">possibly_quantize_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_sigma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_to_idx</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="k">def</span><span class="w"> </span><span class="nf">possibly_quantize_c_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_noise</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantize_c_noise</span><span class="p">:</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_to_idx</span><span class="p">(</span><span class="n">c_noise</span><span class="p">)</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a>        <span class="k">return</span> <span class="n">c_noise</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li>
<p><strong>Purpose:</strong>
  Quantizes continuous noise scales into a discrete set, facilitating controlled denoising.</p>
</li>
<li>
<p><strong>Key Methods:</strong></p>
<ul>
<li><strong>sigma_to_idx:</strong>
   Maps a continuous Ïƒ to the index of the closest discrete Ïƒ value:</li>
</ul>
<p>$$
   \text{index} = \arg\min_i \left| \sigma - \sigma_i \right|
   $$</p>
<ul>
<li>
<p><strong>idx_to_sigma:</strong>
   Returns the discrete Ïƒ corresponding to a given index.</p>
</li>
<li>
<p><strong>possibly_quantize_sigma:</strong>
   Quantizes a continuous Ïƒ by mapping it to its nearest discrete value.</p>
</li>
<li>
<p><strong>possibly_quantize_c_noise:</strong>
   Optionally quantizes the noise conditioning value (<code>c_noise</code>) based on a flag.</p>
</li>
</ul>
</li>
</ul>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">LegacyDDPMDiscretization</span><span class="p">(</span><span class="n">Discretization</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">def</span><span class="w"> </span><span class="o">**</span><span class="n">init</span><span class="o">**</span><span class="p">(</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>        <span class="n">linear_start</span><span class="o">=</span><span class="mf">0.00085</span><span class="p">,</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>        <span class="n">linear_end</span><span class="o">=</span><span class="mf">0.0120</span><span class="p">,</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>        <span class="n">num_timesteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>    <span class="p">):</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.**</span><span class="n">init</span><span class="o">**</span><span class="p">()</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">=</span> <span class="n">num_timesteps</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>        <span class="n">betas</span> <span class="o">=</span> <span class="n">make_beta_schedule</span><span class="p">(</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>            <span class="s2">"linear"</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">,</span> <span class="n">linear_start</span><span class="o">=</span><span class="n">linear_start</span><span class="p">,</span> <span class="n">linear_end</span><span class="o">=</span><span class="n">linear_end</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>        <span class="p">)</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>        <span class="n">alphas</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">betas</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alphas_cumprod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">to_torch</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_sigmas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">"cpu"</span><span class="p">):</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">:</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>            <span class="n">timesteps</span> <span class="o">=</span> <span class="n">generate_roughly_equally_spaced_steps</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">)</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>            <span class="n">alphas_cumprod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_cumprod</span><span class="p">[</span><span class="n">timesteps</span><span class="p">]</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>        <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">:</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>            <span class="n">alphas_cumprod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_cumprod</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>            <span class="k">raise</span> <span class="ne">ValueError</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>        <span class="n">to_torch</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>        <span class="n">sigmas</span> <span class="o">=</span> <span class="n">to_torch</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="p">)</span> <span class="o">/</span> <span class="n">alphas_cumprod</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">sigmas</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li>
<p><strong>Purpose:</strong>
    Computes discrete noise scales (Ïƒ values) for a DDPM.</p>
</li>
<li>
<p><strong>Process &amp; Formulas:</strong></p>
<ul>
<li><strong>Beta Schedule:</strong>
  Generates a sequence of Î²â‚œ values linearly spaced between <code>linear_start</code> and <code>linear_end</code> for t = 1,â€¦,T.</li>
<li><strong>Alpha Calculation:</strong></li>
</ul>
<p>$$
  \alpha_t = 1 - \beta_t
  $$</p>
<ul>
<li><strong>Cumulative Product:</strong></li>
</ul>
<p>$$
  \bar{\alpha}<em i="1">t = \prod</em> \alpha_i
  $$}^{t</p>
<ul>
<li><strong>Sigma Calculation:</strong></li>
</ul>
<p>$$
  \sigma_t = \sqrt{\frac{1 - \bar{\alpha}_t}{\bar{\alpha}_t}}
  $$</p>
<ul>
<li>The <code>get_sigmas</code> method selects Ïƒ values (optionally a subset) and flips them so that they go from high to low noise levels.</li>
</ul>
</li>
</ul>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span>
<span class="normal"><a href="#__codelineno-7-4">4</a></span>
<span class="normal"><a href="#__codelineno-7-5">5</a></span>
<span class="normal"><a href="#__codelineno-7-6">6</a></span>
<span class="normal"><a href="#__codelineno-7-7">7</a></span>
<span class="normal"><a href="#__codelineno-7-8">8</a></span>
<span class="normal"><a href="#__codelineno-7-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">EpsScaling</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>        <span class="n">c_skip</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">sigma</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>        <span class="n">c_out</span> <span class="o">=</span> <span class="o">-</span><span class="n">sigma</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>        <span class="n">c_in</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>        <span class="n">c_noise</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="k">return</span> <span class="n">c_skip</span><span class="p">,</span> <span class="n">c_out</span><span class="p">,</span> <span class="n">c_in</span><span class="p">,</span> <span class="n">c_noise</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li>
<p><strong>Purpose:</strong>
  Provides scaling factors for different branches in the network based on a given noise scale Ïƒ.</p>
</li>
<li>
<p><strong>Scaling Factors &amp; Formulas:</strong></p>
<ul>
<li><strong>Skip Connection Factor:</strong> <span class="arithmatex">\(c_{\text{skip}} = 1\)</span></li>
<li><strong>Output Factor:</strong> <span class="arithmatex">\(c_{\text{out}} = -\sigma\)</span></li>
<li><strong>Input Factor:</strong> <span class="arithmatex">\(c_{\text{in}} = \frac{1}{\sqrt{\sigma^2 + 1}}\)</span></li>
<li><strong>Noise Factor:</strong> <span class="arithmatex">\(c_{\text{noise}} = \sigma\)</span></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<h3 id="44-conditioner">4.4 Conditioner<a class="headerlink" href="#44-conditioner" title="Permanent link">Â¶</a></h3>
<div class="tabbed-set tabbed-alternate" data-tabs="3:6"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio"><input id="__tabbed_3_2" name="__tabbed_3" type="radio"><input id="__tabbed_3_3" name="__tabbed_3" type="radio"><input id="__tabbed_3_4" name="__tabbed_3" type="radio"><input id="__tabbed_3_5" name="__tabbed_3" type="radio"><input id="__tabbed_3_6" name="__tabbed_3" type="radio"><div class="tabbed-labels"><label for="__tabbed_3_1">config</label><label for="__tabbed_3_2">code</label><label for="__tabbed_3_3">txt embedder 1</label><label for="__tabbed_3_4">txt embedder 2</label><label for="__tabbed_3_5">concat timesstep embedder</label><label for="__tabbed_3_6">Time Embedding</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nt">conditioner_config</span><span class="p">:</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">  </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.GeneralConditioner</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="nt">emb_models</span><span class="p">:</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">is_trainable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">        </span><span class="nt">input_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">txt</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.encoders.modules.FrozenCLIPEmbedder</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">        </span><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">          </span><span class="nt">layer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hidden</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">          </span><span class="nt">layer_idx</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">11</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">is_trainable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">        </span><span class="nt">input_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">txt</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.encoders.modules.FrozenOpenCLIPEmbedder2</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">        </span><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">          </span><span class="nt">arch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ViT-bigG-14</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">          </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">laion2b_s39b_b160k</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">          </span><span class="nt">freeze</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">          </span><span class="nt">layer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">penultimate</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">          </span><span class="nt">always_return_pooled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="w">          </span><span class="nt">legacy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">is_trainable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">        </span><span class="nt">input_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">original_size_as_tuple</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.encoders.modules.ConcatTimestepEmbedderND</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">        </span><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">          </span><span class="nt">outdim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">is_trainable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">        </span><span class="nt">input_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crop_coords_top_left</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.encoders.modules.ConcatTimestepEmbedderND</span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="w">        </span><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="w">          </span><span class="nt">outdim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256</span>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">is_trainable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="w">        </span><span class="nt">input_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">target_size_as_tuple</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sgm.modules.encoders.modules.ConcatTimestepEmbedderND</span>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="w">        </span><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="w">          </span><span class="nt">outdim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256</span>
</code></pre></div></td></tr></tbody></table></div>
</div>
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">  1</a></span>
<span class="normal"><a href="#__codelineno-9-2">  2</a></span>
<span class="normal"><a href="#__codelineno-9-3">  3</a></span>
<span class="normal"><a href="#__codelineno-9-4">  4</a></span>
<span class="normal"><a href="#__codelineno-9-5">  5</a></span>
<span class="normal"><a href="#__codelineno-9-6">  6</a></span>
<span class="normal"><a href="#__codelineno-9-7">  7</a></span>
<span class="normal"><a href="#__codelineno-9-8">  8</a></span>
<span class="normal"><a href="#__codelineno-9-9">  9</a></span>
<span class="normal"><a href="#__codelineno-9-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-9-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-9-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-9-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-9-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-9-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-9-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-9-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-9-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-9-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-9-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-9-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-9-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-9-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-9-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-9-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-9-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-9-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-9-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-9-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-9-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-9-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-9-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-9-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-9-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-9-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-9-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-9-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-9-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-9-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-9-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-9-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-9-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-9-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-9-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-9-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-9-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-9-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-9-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-9-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-9-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-9-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-9-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-9-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-9-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-9-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-9-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-9-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-9-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-9-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-9-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-9-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-9-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-9-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-9-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-9-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-9-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-9-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-9-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-9-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-9-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-9-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-9-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-9-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-9-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-9-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-9-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-9-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-9-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-9-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-9-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-9-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-9-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-9-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-9-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-9-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-9-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-9-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-9-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-9-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-9-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-9-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-9-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-9-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-9-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-9-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-9-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-9-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-9-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-9-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-9-100">100</a></span>
<span class="normal"><a href="#__codelineno-9-101">101</a></span>
<span class="normal"><a href="#__codelineno-9-102">102</a></span>
<span class="normal"><a href="#__codelineno-9-103">103</a></span>
<span class="normal"><a href="#__codelineno-9-104">104</a></span>
<span class="normal"><a href="#__codelineno-9-105">105</a></span>
<span class="normal"><a href="#__codelineno-9-106">106</a></span>
<span class="normal"><a href="#__codelineno-9-107">107</a></span>
<span class="normal"><a href="#__codelineno-9-108">108</a></span>
<span class="normal"><a href="#__codelineno-9-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">GeneralConditioner</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>    <span class="n">OUTPUT_DIM2KEYS</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="s2">"vector"</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">"crossattn"</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s2">"concat"</span><span class="p">}</span> <span class="c1"># , 5: "concat"}</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>    <span class="n">KEY2CATDIM</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"vector"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"crossattn"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"concat"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"cond_view"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"cond_motion"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emb_models</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">ListConfig</span><span class="p">]):</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>        <span class="n">embedders</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">embconfig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">emb_models</span><span class="p">):</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>            <span class="n">embedder</span> <span class="o">=</span> <span class="n">instantiate_from_config</span><span class="p">(</span><span class="n">embconfig</span><span class="p">)</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>                <span class="n">embedder</span><span class="p">,</span> <span class="n">AbstractEmbModel</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>            <span class="p">),</span> <span class="sa">f</span><span class="s2">"embedder model </span><span class="si">{</span><span class="n">embedder</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has to inherit from AbstractEmbModel"</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>            <span class="n">embedder</span><span class="o">.</span><span class="n">is_trainable</span> <span class="o">=</span> <span class="n">embconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"is_trainable"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>            <span class="n">embedder</span><span class="o">.</span><span class="n">ucg_rate</span> <span class="o">=</span> <span class="n">embconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"ucg_rate"</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">embedder</span><span class="o">.</span><span class="n">is_trainable</span><span class="p">:</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>                <span class="n">embedder</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">disabled_train</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">embedder</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>                    <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a>                <span class="n">embedder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a>                <span class="sa">f</span><span class="s2">"Initialized embedder #</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">embedder</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> "</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a>                <span class="sa">f</span><span class="s2">"with </span><span class="si">{</span><span class="n">count_params</span><span class="p">(</span><span class="n">embedder</span><span class="p">,</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2"> params. Trainable: </span><span class="si">{</span><span class="n">embedder</span><span class="o">.</span><span class="n">is_trainable</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a>            <span class="p">)</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a>            <span class="k">if</span> <span class="s2">"input_key"</span> <span class="ow">in</span> <span class="n">embconfig</span><span class="p">:</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>                <span class="n">embedder</span><span class="o">.</span><span class="n">input_key</span> <span class="o">=</span> <span class="n">embconfig</span><span class="p">[</span><span class="s2">"input_key"</span><span class="p">]</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a>            <span class="k">elif</span> <span class="s2">"input_keys"</span> <span class="ow">in</span> <span class="n">embconfig</span><span class="p">:</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a>                <span class="n">embedder</span><span class="o">.</span><span class="n">input_keys</span> <span class="o">=</span> <span class="n">embconfig</span><span class="p">[</span><span class="s2">"input_keys"</span><span class="p">]</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a>                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a>                    <span class="sa">f</span><span class="s2">"need either 'input_key' or 'input_keys' for embedder </span><span class="si">{</span><span class="n">embedder</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a>                <span class="p">)</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a>            <span class="n">embedder</span><span class="o">.</span><span class="n">legacy_ucg_val</span> <span class="o">=</span> <span class="n">embconfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"legacy_ucg_value"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a>            <span class="k">if</span> <span class="n">embedder</span><span class="o">.</span><span class="n">legacy_ucg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a>                <span class="n">embedder</span><span class="o">.</span><span class="n">ucg_prng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()</span>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a>            <span class="n">embedders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">embedder</span><span class="p">)</span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span><span class="n">embedders</span><span class="p">)</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">possibly_get_ucg_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">embedder</span><span class="p">:</span> <span class="n">AbstractEmbModel</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a>        <span class="k">assert</span> <span class="n">embedder</span><span class="o">.</span><span class="n">legacy_ucg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">embedder</span><span class="o">.</span><span class="n">ucg_rate</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a>        <span class="n">val</span> <span class="o">=</span> <span class="n">embedder</span><span class="o">.</span><span class="n">legacy_ucg_val</span>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">embedder</span><span class="o">.</span><span class="n">input_key</span><span class="p">])):</span>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a>            <span class="k">if</span> <span class="n">embedder</span><span class="o">.</span><span class="n">ucg_prng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">]):</span>
<a id="__codelineno-9-42" name="__codelineno-9-42"></a>                <span class="n">batch</span><span class="p">[</span><span class="n">embedder</span><span class="o">.</span><span class="n">input_key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
<a id="__codelineno-9-43" name="__codelineno-9-43"></a>        <span class="k">return</span> <span class="n">batch</span>
<a id="__codelineno-9-44" name="__codelineno-9-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
<a id="__codelineno-9-45" name="__codelineno-9-45"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">force_zero_embeddings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-9-46" name="__codelineno-9-46"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-9-47" name="__codelineno-9-47"></a>        <span class="n">output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-9-48" name="__codelineno-9-48"></a>        <span class="k">if</span> <span class="n">force_zero_embeddings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-49" name="__codelineno-9-49"></a>            <span class="n">force_zero_embeddings</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-50" name="__codelineno-9-50"></a>        <span class="k">for</span> <span class="n">embedder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span><span class="p">:</span>
<a id="__codelineno-9-51" name="__codelineno-9-51"></a>            <span class="n">embedding_context</span> <span class="o">=</span> <span class="n">nullcontext</span> <span class="k">if</span> <span class="n">embedder</span><span class="o">.</span><span class="n">is_trainable</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span>
<a id="__codelineno-9-52" name="__codelineno-9-52"></a>            <span class="k">with</span> <span class="n">embedding_context</span><span class="p">():</span>
<a id="__codelineno-9-53" name="__codelineno-9-53"></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">embedder</span><span class="p">,</span> <span class="s2">"input_key"</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">embedder</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-9-54" name="__codelineno-9-54"></a>                    <span class="k">if</span> <span class="n">embedder</span><span class="o">.</span><span class="n">legacy_ucg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-55" name="__codelineno-9-55"></a>                        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">possibly_get_ucg_val</span><span class="p">(</span><span class="n">embedder</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-9-56" name="__codelineno-9-56"></a>                    <span class="n">emb_out</span> <span class="o">=</span> <span class="n">embedder</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">embedder</span><span class="o">.</span><span class="n">input_key</span><span class="p">])</span>
<a id="__codelineno-9-57" name="__codelineno-9-57"></a>                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">embedder</span><span class="p">,</span> <span class="s2">"input_keys"</span><span class="p">):</span>
<a id="__codelineno-9-58" name="__codelineno-9-58"></a>                    <span class="n">emb_out</span> <span class="o">=</span> <span class="n">embedder</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">embedder</span><span class="o">.</span><span class="n">input_keys</span><span class="p">])</span>
<a id="__codelineno-9-59" name="__codelineno-9-59"></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
<a id="__codelineno-9-60" name="__codelineno-9-60"></a>                <span class="n">emb_out</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
<a id="__codelineno-9-61" name="__codelineno-9-61"></a>            <span class="p">),</span> <span class="sa">f</span><span class="s2">"encoder outputs must be tensors or a sequence, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">emb_out</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<a id="__codelineno-9-62" name="__codelineno-9-62"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emb_out</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
<a id="__codelineno-9-63" name="__codelineno-9-63"></a>                <span class="n">emb_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">emb_out</span><span class="p">]</span>
<a id="__codelineno-9-64" name="__codelineno-9-64"></a>            <span class="k">for</span> <span class="n">emb</span> <span class="ow">in</span> <span class="n">emb_out</span><span class="p">:</span>
<a id="__codelineno-9-65" name="__codelineno-9-65"></a>                <span class="k">if</span> <span class="n">embedder</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"cond_view"</span><span class="p">,</span> <span class="s2">"cond_motion"</span><span class="p">]:</span>
<a id="__codelineno-9-66" name="__codelineno-9-66"></a>                    <span class="n">out_key</span> <span class="o">=</span> <span class="n">embedder</span><span class="o">.</span><span class="n">input_key</span>
<a id="__codelineno-9-67" name="__codelineno-9-67"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-68" name="__codelineno-9-68"></a>                    <span class="n">out_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUTPUT_DIM2KEYS</span><span class="p">[</span><span class="n">emb</span><span class="o">.</span><span class="n">dim</span><span class="p">()]</span>
<a id="__codelineno-9-69" name="__codelineno-9-69"></a>                <span class="k">if</span> <span class="n">embedder</span><span class="o">.</span><span class="n">ucg_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">embedder</span><span class="o">.</span><span class="n">legacy_ucg_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-70" name="__codelineno-9-70"></a>                    <span class="n">emb</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-9-71" name="__codelineno-9-71"></a>                        <span class="n">expand_dims_like</span><span class="p">(</span>
<a id="__codelineno-9-72" name="__codelineno-9-72"></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">bernoulli</span><span class="p">(</span>
<a id="__codelineno-9-73" name="__codelineno-9-73"></a>                                <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">embedder</span><span class="o">.</span><span class="n">ucg_rate</span><span class="p">)</span>
<a id="__codelineno-9-74" name="__codelineno-9-74"></a>                                <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">emb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">emb</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-9-75" name="__codelineno-9-75"></a>                            <span class="p">),</span>
<a id="__codelineno-9-76" name="__codelineno-9-76"></a>                            <span class="n">emb</span><span class="p">,</span>
<a id="__codelineno-9-77" name="__codelineno-9-77"></a>                        <span class="p">)</span>
<a id="__codelineno-9-78" name="__codelineno-9-78"></a>                        <span class="o">*</span> <span class="n">emb</span>
<a id="__codelineno-9-79" name="__codelineno-9-79"></a>                    <span class="p">)</span>
<a id="__codelineno-9-80" name="__codelineno-9-80"></a>                <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-9-81" name="__codelineno-9-81"></a>                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">embedder</span><span class="p">,</span> <span class="s2">"input_key"</span><span class="p">)</span>
<a id="__codelineno-9-82" name="__codelineno-9-82"></a>                    <span class="ow">and</span> <span class="n">embedder</span><span class="o">.</span><span class="n">input_key</span> <span class="ow">in</span> <span class="n">force_zero_embeddings</span>
<a id="__codelineno-9-83" name="__codelineno-9-83"></a>                <span class="p">):</span>
<a id="__codelineno-9-84" name="__codelineno-9-84"></a>                    <span class="n">emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">emb</span><span class="p">)</span>
<a id="__codelineno-9-85" name="__codelineno-9-85"></a>                <span class="k">if</span> <span class="n">out_key</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-9-86" name="__codelineno-9-86"></a>                    <span class="n">output</span><span class="p">[</span><span class="n">out_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-9-87" name="__codelineno-9-87"></a>                        <span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">out_key</span><span class="p">],</span> <span class="n">emb</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEY2CATDIM</span><span class="p">[</span><span class="n">out_key</span><span class="p">]</span>
<a id="__codelineno-9-88" name="__codelineno-9-88"></a>                    <span class="p">)</span>
<a id="__codelineno-9-89" name="__codelineno-9-89"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-90" name="__codelineno-9-90"></a>                    <span class="n">output</span><span class="p">[</span><span class="n">out_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">emb</span>
<a id="__codelineno-9-91" name="__codelineno-9-91"></a>        <span class="k">return</span> <span class="n">output</span>
<a id="__codelineno-9-92" name="__codelineno-9-92"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_unconditional_conditioning</span><span class="p">(</span>
<a id="__codelineno-9-93" name="__codelineno-9-93"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-94" name="__codelineno-9-94"></a>        <span class="n">batch_c</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-9-95" name="__codelineno-9-95"></a>        <span class="n">batch_uc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-9-96" name="__codelineno-9-96"></a>        <span class="n">force_uc_zero_embeddings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-9-97" name="__codelineno-9-97"></a>        <span class="n">force_cond_zero_embeddings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-9-98" name="__codelineno-9-98"></a>    <span class="p">):</span>
<a id="__codelineno-9-99" name="__codelineno-9-99"></a>        <span class="k">if</span> <span class="n">force_uc_zero_embeddings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-100" name="__codelineno-9-100"></a>            <span class="n">force_uc_zero_embeddings</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-101" name="__codelineno-9-101"></a>        <span class="n">ucg_rates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<a id="__codelineno-9-102" name="__codelineno-9-102"></a>        <span class="k">for</span> <span class="n">embedder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span><span class="p">:</span>
<a id="__codelineno-9-103" name="__codelineno-9-103"></a>            <span class="n">ucg_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">embedder</span><span class="o">.</span><span class="n">ucg_rate</span><span class="p">)</span>
<a id="__codelineno-9-104" name="__codelineno-9-104"></a>            <span class="n">embedder</span><span class="o">.</span><span class="n">ucg_rate</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-9-105" name="__codelineno-9-105"></a>        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">batch_c</span><span class="p">,</span> <span class="n">force_cond_zero_embeddings</span><span class="p">)</span>
<a id="__codelineno-9-106" name="__codelineno-9-106"></a>        <span class="n">uc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">batch_c</span> <span class="k">if</span> <span class="n">batch_uc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">batch_uc</span><span class="p">,</span> <span class="n">force_uc_zero_embeddings</span><span class="p">)</span>
<a id="__codelineno-9-107" name="__codelineno-9-107"></a>        <span class="k">for</span> <span class="n">embedder</span><span class="p">,</span> <span class="n">rate</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedders</span><span class="p">,</span> <span class="n">ucg_rates</span><span class="p">):</span>
<a id="__codelineno-9-108" name="__codelineno-9-108"></a>            <span class="n">embedder</span><span class="o">.</span><span class="n">ucg_rate</span> <span class="o">=</span> <span class="n">rate</span>
<a id="__codelineno-9-109" name="__codelineno-9-109"></a>        <span class="k">return</span> <span class="n">c</span><span class="p">,</span> <span class="n">uc</span>
</code></pre></div></td></tr></tbody></table></div>
Convet the original input to the embeding with different embedding model. Have three different kind of conditoin types.
1. vector: similar to time embedding
2. crossattn: similar to text embedding which is a sequence
3. concat: shape of [B,C,H,W] that can concat with original input like the depth, low-res, and masked image condition<p></p>
</div>
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">FrozenCLIPEmbedder</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span>
<span class="normal"><a href="#__codelineno-10-38">38</a></span>
<span class="normal"><a href="#__codelineno-10-39">39</a></span>
<span class="normal"><a href="#__codelineno-10-40">40</a></span>
<span class="normal"><a href="#__codelineno-10-41">41</a></span>
<span class="normal"><a href="#__codelineno-10-42">42</a></span>
<span class="normal"><a href="#__codelineno-10-43">43</a></span>
<span class="normal"><a href="#__codelineno-10-44">44</a></span>
<span class="normal"><a href="#__codelineno-10-45">45</a></span>
<span class="normal"><a href="#__codelineno-10-46">46</a></span>
<span class="normal"><a href="#__codelineno-10-47">47</a></span>
<span class="normal"><a href="#__codelineno-10-48">48</a></span>
<span class="normal"><a href="#__codelineno-10-49">49</a></span>
<span class="normal"><a href="#__codelineno-10-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">FrozenCLIPEmbedder</span><span class="p">(</span><span class="n">AbstractEmbModel</span><span class="p">):</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="n">LAYERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"last"</span><span class="p">,</span> <span class="s2">"pooled"</span><span class="p">,</span> <span class="s2">"hidden"</span><span class="p">]</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>        <span class="n">version</span><span class="o">=</span><span class="s2">"openai/clip-vit-large-patch14"</span><span class="p">,</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>        <span class="n">device</span><span class="o">=</span><span class="s2">"cuda"</span><span class="p">,</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>        <span class="n">max_length</span><span class="o">=</span><span class="mi">77</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="n">freeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>        <span class="n">layer</span><span class="o">=</span><span class="s2">"last"</span><span class="p">,</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>        <span class="n">layer_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>        <span class="n">always_return_pooled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>    <span class="p">):</span>  <span class="c1"># clip-vit-base-patch32</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>        <span class="k">assert</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LAYERS</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">CLIPTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">CLIPTextModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a>        <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layer_idx</span> <span class="o">=</span> <span class="n">layer_idx</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">return_pooled</span> <span class="o">=</span> <span class="n">always_return_pooled</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a>        <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">"hidden"</span><span class="p">:</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a>            <span class="k">assert</span> <span class="n">layer_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a>            <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">layer_idx</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">12</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a>    <span class="nd">@autocast</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a>        <span class="n">batch_encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a>            <span class="n">text</span><span class="p">,</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a>            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a>            <span class="n">return_length</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>            <span class="n">return_overflowing_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a>            <span class="n">padding</span><span class="o">=</span><span class="s2">"max_length"</span><span class="p">,</span>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a>            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">"pt"</span><span class="p">,</span>
<a id="__codelineno-10-37" name="__codelineno-10-37"></a>        <span class="p">)</span>
<a id="__codelineno-10-38" name="__codelineno-10-38"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="n">batch_encoding</span><span class="p">[</span><span class="s2">"input_ids"</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-10-39" name="__codelineno-10-39"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">(</span>
<a id="__codelineno-10-40" name="__codelineno-10-40"></a>            <span class="n">input_ids</span><span class="o">=</span><span class="n">tokens</span><span class="p">,</span> <span class="n">output_hidden_states</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">==</span> <span class="s2">"hidden"</span>
<a id="__codelineno-10-41" name="__codelineno-10-41"></a>        <span class="p">)</span>
<a id="__codelineno-10-42" name="__codelineno-10-42"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">==</span> <span class="s2">"last"</span><span class="p">:</span>
<a id="__codelineno-10-43" name="__codelineno-10-43"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">last_hidden_state</span>
<a id="__codelineno-10-44" name="__codelineno-10-44"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">==</span> <span class="s2">"pooled"</span><span class="p">:</span>
<a id="__codelineno-10-45" name="__codelineno-10-45"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">pooler_output</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-10-46" name="__codelineno-10-46"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-10-47" name="__codelineno-10-47"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">hidden_states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_idx</span><span class="p">]</span>
<a id="__codelineno-10-48" name="__codelineno-10-48"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_pooled</span><span class="p">:</span>
<a id="__codelineno-10-49" name="__codelineno-10-49"></a>            <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">outputs</span><span class="o">.</span><span class="n">pooler_output</span>
<a id="__codelineno-10-50" name="__codelineno-10-50"></a>        <span class="k">return</span> <span class="n">z</span>
</code></pre></div></td></tr></tbody></table></div>
It provides three different embedding reresentation
1. last hidder state: [B,S,D]
2. pooled hidden state: [B,D]
3. hidden stage correspoding to given layer index: [B,S,D]
In this model, it uses the 11-th  layer<p></p>
</div>
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span>
<span class="normal"><a href="#__codelineno-11-43">43</a></span>
<span class="normal"><a href="#__codelineno-11-44">44</a></span>
<span class="normal"><a href="#__codelineno-11-45">45</a></span>
<span class="normal"><a href="#__codelineno-11-46">46</a></span>
<span class="normal"><a href="#__codelineno-11-47">47</a></span>
<span class="normal"><a href="#__codelineno-11-48">48</a></span>
<span class="normal"><a href="#__codelineno-11-49">49</a></span>
<span class="normal"><a href="#__codelineno-11-50">50</a></span>
<span class="normal"><a href="#__codelineno-11-51">51</a></span>
<span class="normal"><a href="#__codelineno-11-52">52</a></span>
<span class="normal"><a href="#__codelineno-11-53">53</a></span>
<span class="normal"><a href="#__codelineno-11-54">54</a></span>
<span class="normal"><a href="#__codelineno-11-55">55</a></span>
<span class="normal"><a href="#__codelineno-11-56">56</a></span>
<span class="normal"><a href="#__codelineno-11-57">57</a></span>
<span class="normal"><a href="#__codelineno-11-58">58</a></span>
<span class="normal"><a href="#__codelineno-11-59">59</a></span>
<span class="normal"><a href="#__codelineno-11-60">60</a></span>
<span class="normal"><a href="#__codelineno-11-61">61</a></span>
<span class="normal"><a href="#__codelineno-11-62">62</a></span>
<span class="normal"><a href="#__codelineno-11-63">63</a></span>
<span class="normal"><a href="#__codelineno-11-64">64</a></span>
<span class="normal"><a href="#__codelineno-11-65">65</a></span>
<span class="normal"><a href="#__codelineno-11-66">66</a></span>
<span class="normal"><a href="#__codelineno-11-67">67</a></span>
<span class="normal"><a href="#__codelineno-11-68">68</a></span>
<span class="normal"><a href="#__codelineno-11-69">69</a></span>
<span class="normal"><a href="#__codelineno-11-70">70</a></span>
<span class="normal"><a href="#__codelineno-11-71">71</a></span>
<span class="normal"><a href="#__codelineno-11-72">72</a></span>
<span class="normal"><a href="#__codelineno-11-73">73</a></span>
<span class="normal"><a href="#__codelineno-11-74">74</a></span>
<span class="normal"><a href="#__codelineno-11-75">75</a></span>
<span class="normal"><a href="#__codelineno-11-76">76</a></span>
<span class="normal"><a href="#__codelineno-11-77">77</a></span>
<span class="normal"><a href="#__codelineno-11-78">78</a></span>
<span class="normal"><a href="#__codelineno-11-79">79</a></span>
<span class="normal"><a href="#__codelineno-11-80">80</a></span>
<span class="normal"><a href="#__codelineno-11-81">81</a></span>
<span class="normal"><a href="#__codelineno-11-82">82</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">FrozenOpenCLIPEmbedder2</span><span class="p">(</span><span class="n">AbstractEmbModel</span><span class="p">):</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>    <span class="n">LAYERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"pooled"</span><span class="p">,</span> <span class="s2">"last"</span><span class="p">,</span> <span class="s2">"penultimate"</span><span class="p">]</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>    <span class="k">def</span><span class="w"> </span><span class="o">**</span><span class="n">init</span><span class="o">**</span><span class="p">(</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>        <span class="n">arch</span><span class="o">=</span><span class="s2">"ViT-H-14"</span><span class="p">,</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>        <span class="n">version</span><span class="o">=</span><span class="s2">"laion2b_s32b_b79k"</span><span class="p">,</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>        <span class="n">device</span><span class="o">=</span><span class="s2">"cuda"</span><span class="p">,</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>        <span class="n">max_length</span><span class="o">=</span><span class="mi">77</span><span class="p">,</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>        <span class="n">freeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>        <span class="n">layer</span><span class="o">=</span><span class="s2">"last"</span><span class="p">,</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>        <span class="n">always_return_pooled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>        <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>    <span class="p">):</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.**</span><span class="n">init</span><span class="o">**</span><span class="p">()</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>        <span class="k">assert</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LAYERS</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>        <span class="n">model</span><span class="p">,</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span> <span class="n">open_clip</span><span class="o">.</span><span class="n">create_model_and_transforms</span><span class="p">(</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>            <span class="n">arch</span><span class="p">,</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>            <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cpu"</span><span class="p">),</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>            <span class="n">pretrained</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a>        <span class="p">)</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>        <span class="k">del</span> <span class="n">model</span><span class="o">.</span><span class="n">visual</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">return_pooled</span> <span class="o">=</span> <span class="n">always_return_pooled</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a>        <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">==</span> <span class="s2">"last"</span><span class="p">:</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">layer_idx</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">==</span> <span class="s2">"penultimate"</span><span class="p">:</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">layer_idx</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="n">legacy</span>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a>    <span class="nd">@autocast</span>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<a id="__codelineno-11-38" name="__codelineno-11-38"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="n">open_clip</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-11-39" name="__codelineno-11-39"></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_with_transformer</span><span class="p">(</span><span class="n">tokens</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_pooled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a>            <span class="k">return</span> <span class="n">z</span>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_pooled</span><span class="p">:</span>
<a id="__codelineno-11-43" name="__codelineno-11-43"></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span>
<a id="__codelineno-11-44" name="__codelineno-11-44"></a>            <span class="k">return</span> <span class="n">z</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="s2">"pooled"</span><span class="p">]</span>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a>        <span class="k">return</span> <span class="n">z</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">]</span>
<a id="__codelineno-11-46" name="__codelineno-11-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode_with_transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<a id="__codelineno-11-47" name="__codelineno-11-47"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">token_embedding</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># [batch_size, n_ctx, d_model]</span>
<a id="__codelineno-11-48" name="__codelineno-11-48"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">positional_embedding</span>
<a id="__codelineno-11-49" name="__codelineno-11-49"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># NLD -&gt; LND</span>
<a id="__codelineno-11-50" name="__codelineno-11-50"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_transformer_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attn_mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">attn_mask</span><span class="p">)</span>
<a id="__codelineno-11-51" name="__codelineno-11-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy</span><span class="p">:</span>
<a id="__codelineno-11-52" name="__codelineno-11-52"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">]</span>
<a id="__codelineno-11-53" name="__codelineno-11-53"></a>            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ln_final</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-11-54" name="__codelineno-11-54"></a>            <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-11-55" name="__codelineno-11-55"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-56" name="__codelineno-11-56"></a>            <span class="c1"># x is a dict and will stay a dict</span>
<a id="__codelineno-11-57" name="__codelineno-11-57"></a>            <span class="n">o</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s2">"last"</span><span class="p">]</span>
<a id="__codelineno-11-58" name="__codelineno-11-58"></a>            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ln_final</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<a id="__codelineno-11-59" name="__codelineno-11-59"></a>            <span class="n">pooled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-11-60" name="__codelineno-11-60"></a>            <span class="n">x</span><span class="p">[</span><span class="s2">"pooled"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pooled</span>
<a id="__codelineno-11-61" name="__codelineno-11-61"></a>            <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-11-62" name="__codelineno-11-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<a id="__codelineno-11-63" name="__codelineno-11-63"></a>        <span class="c1"># take features from the eot embedding (eot_token is the highest number in each sequence)</span>
<a id="__codelineno-11-64" name="__codelineno-11-64"></a>        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-11-65" name="__codelineno-11-65"></a>            <span class="n">x</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">text</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]</span>
<a id="__codelineno-11-66" name="__codelineno-11-66"></a>            <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">text_projection</span>
<a id="__codelineno-11-67" name="__codelineno-11-67"></a>        <span class="p">)</span>
<a id="__codelineno-11-68" name="__codelineno-11-68"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-11-69" name="__codelineno-11-69"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">text_transformer_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">attn_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-11-70" name="__codelineno-11-70"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-11-71" name="__codelineno-11-71"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">resblocks</span><span class="p">):</span>
<a id="__codelineno-11-72" name="__codelineno-11-72"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">resblocks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-11-73" name="__codelineno-11-73"></a>                <span class="n">outputs</span><span class="p">[</span><span class="s2">"penultimate"</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># LND -&gt; NLD</span>
<a id="__codelineno-11-74" name="__codelineno-11-74"></a>            <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-11-75" name="__codelineno-11-75"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">grad_checkpointing</span>
<a id="__codelineno-11-76" name="__codelineno-11-76"></a>                <span class="ow">and</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">is_scripting</span><span class="p">()</span>
<a id="__codelineno-11-77" name="__codelineno-11-77"></a>            <span class="p">):</span>
<a id="__codelineno-11-78" name="__codelineno-11-78"></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">attn_mask</span><span class="p">)</span>
<a id="__codelineno-11-79" name="__codelineno-11-79"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-80" name="__codelineno-11-80"></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attn_mask</span><span class="o">=</span><span class="n">attn_mask</span><span class="p">)</span>
<a id="__codelineno-11-81" name="__codelineno-11-81"></a>        <span class="n">outputs</span><span class="p">[</span><span class="s2">"last"</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># LND -&gt; NLD</span>
<a id="__codelineno-11-82" name="__codelineno-11-82"></a>        <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div></td></tr></tbody></table></div>
In this model, it used ViT-bigG-14. It also supports three different types of embedding. Here it chosed 'penultimate', (second last) layer and returned pooled hidden state.
If returned pool is true, this embedder will output two hidden stages: origina one and pooled one, and this two will be treated differently.
pooled embedding will be treated as vector embedding same as the process of time step embedding.
Original hidden stage will be treated as sequential embedding which fed into the U-Net through the cross-attention.<p></p>
</div>
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConcatTimestepEmbedderND</span><span class="p">(</span><span class="n">AbstractEmbModel</span><span class="p">):</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="sd">"""embeds each dimension independently and concatenates them"""</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outdim</span><span class="p">):</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="n">Timestep</span><span class="p">(</span><span class="n">outdim</span><span class="p">)</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">outdim</span> <span class="o">=</span> <span class="n">outdim</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>        <span class="n">b</span><span class="p">,</span> <span class="n">dims</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">"b d -&gt; (b d)"</span><span class="p">)</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a>        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a>        <span class="n">emb</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">emb</span><span class="p">,</span> <span class="s2">"(b d) d2 -&gt; b (d d2)"</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">d2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdim</span><span class="p">)</span>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a>        <span class="k">return</span> <span class="n">emb</span>
</code></pre></div></td></tr></tbody></table></div>
this embedding handles the 'scalar' conditions including the class label, time step, cropping parameter, original image size, target image size<p></p>
</div>
<div class="tabbed-block">
<p></p><div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span>
<span class="normal"><a href="#__codelineno-13-20">20</a></span>
<span class="normal"><a href="#__codelineno-13-21">21</a></span>
<span class="normal"><a href="#__codelineno-13-22">22</a></span>
<span class="normal"><a href="#__codelineno-13-23">23</a></span>
<span class="normal"><a href="#__codelineno-13-24">24</a></span>
<span class="normal"><a href="#__codelineno-13-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">timestep_embedding</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">max_period</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">repeat_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="sd">    Create sinusoidal timestep embeddings.</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="sd">    :param timesteps: a 1-D Tensor of N indices, one per batch element.</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="sd">                    These may be fractional.</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="sd">    :param dim: the dimension of the output.</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="sd">    :param max_period: controls the minimum frequency of the embeddings.</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="sd">    :return: an [N x dim] Tensor of positional embeddings.</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="sd">    """</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">repeat_only</span><span class="p">:</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>        <span class="n">half</span> <span class="o">=</span> <span class="n">dim</span> <span class="o">//</span> <span class="mi">2</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>        <span class="n">freqs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>            <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">max_period</span><span class="p">)</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>            <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">half</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>            <span class="o">/</span> <span class="n">half</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">timesteps</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a>        <span class="n">args</span> <span class="o">=</span> <span class="n">timesteps</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="n">freqs</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a>        <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">args</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a>            <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a>                <span class="p">[</span><span class="n">embedding</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">embedding</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">])],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a>            <span class="p">)</span>
<a id="__codelineno-13-23" name="__codelineno-13-23"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a>        <span class="n">embedding</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="s2">"b -&gt; b d"</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
<a id="__codelineno-13-25" name="__codelineno-13-25"></a>    <span class="k">return</span> <span class="n">embedding</span>
</code></pre></div></td></tr></tbody></table></div>
Here are the formulas expressed in mathematical notation using the English exp and log functions:<p></p>
<ol>
<li>
<p><strong>Frequency Calculation:</strong>
    Let</p>
<div class="arithmatex">\[
H = \left\lfloor \frac{D}{2} \right\rfloor,
\]</div>
<p>where <span class="arithmatex">\( D \)</span> is the embedding dimension. For each index <span class="arithmatex">\( i \)</span> (with <span class="arithmatex">\( 0 \le i &lt; H \)</span>), define the frequency as:</p>
<div class="arithmatex">\[
\omega_i = \exp\!\left(-\frac{i}{H} \cdot \log(\text{max\_period})\right) = \text{max\_period}^{-\frac{i}{H}}.
\]</div>
</li>
<li>
<p><strong>Angle Computation:</strong>
For a given time step <span class="arithmatex">\( t \)</span>, compute:</p>
</li>
</ol>
<div class="arithmatex">\[
\theta_{t,i} = t \cdot \omega_i.
\]</div>
<ol>
<li><strong>Embedding Vector:</strong>
The embedding for time step <span class="arithmatex">\( t \)</span> is then given by:</li>
</ol>
<div class="arithmatex">\[
\mathbf{e}(t) = \Bigl[\cos\bigl(\theta_{t,0}\bigr),\, \cos\bigl(\theta_{t,1}\bigr),\, \dots,\, \cos\bigl(\theta_{t,H-1}\bigr),\, \sin\bigl(\theta_{t,0}\bigr),\, \sin\bigl(\theta_{t,1}\bigr),\, \dots,\, \sin\bigl(\theta_{t,H-1}\bigr)\Bigr].
\]</div>
<p>If <span class="arithmatex">\( D \)</span> is odd, append one extra zero to reach the dimension <span class="arithmatex">\( D \)</span>.</p>
<ol>
<li><strong>Alternate Case (repeat_only):</strong>
If the <code>repeat_only</code> flag is set to true, then the embedding is simply:</li>
</ol>
<div class="arithmatex">\[
\mathbf{e}(t) = \underbrace{[t,\, t,\, \dots,\, t]}_{D\text{ times}}.
\]</div>
</div>
</div>
</div>
<h3 id="45-standarddiffusionloss">4.5 StandardDiffusionLoss<a class="headerlink" href="#45-standarddiffusionloss" title="Permanent link">Â¶</a></h3>
<blockquote>
<p>here is the code from the repo, but it seems not belong to the one use in sd-xl.</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span>
<span class="normal"><a href="#__codelineno-14-21">21</a></span>
<span class="normal"><a href="#__codelineno-14-22">22</a></span>
<span class="normal"><a href="#__codelineno-14-23">23</a></span>
<span class="normal"><a href="#__codelineno-14-24">24</a></span>
<span class="normal"><a href="#__codelineno-14-25">25</a></span>
<span class="normal"><a href="#__codelineno-14-26">26</a></span>
<span class="normal"><a href="#__codelineno-14-27">27</a></span>
<span class="normal"><a href="#__codelineno-14-28">28</a></span>
<span class="normal"><a href="#__codelineno-14-29">29</a></span>
<span class="normal"><a href="#__codelineno-14-30">30</a></span>
<span class="normal"><a href="#__codelineno-14-31">31</a></span>
<span class="normal"><a href="#__codelineno-14-32">32</a></span>
<span class="normal"><a href="#__codelineno-14-33">33</a></span>
<span class="normal"><a href="#__codelineno-14-34">34</a></span>
<span class="normal"><a href="#__codelineno-14-35">35</a></span>
<span class="normal"><a href="#__codelineno-14-36">36</a></span>
<span class="normal"><a href="#__codelineno-14-37">37</a></span>
<span class="normal"><a href="#__codelineno-14-38">38</a></span>
<span class="normal"><a href="#__codelineno-14-39">39</a></span>
<span class="normal"><a href="#__codelineno-14-40">40</a></span>
<span class="normal"><a href="#__codelineno-14-41">41</a></span>
<span class="normal"><a href="#__codelineno-14-42">42</a></span>
<span class="normal"><a href="#__codelineno-14-43">43</a></span>
<span class="normal"><a href="#__codelineno-14-44">44</a></span>
<span class="normal"><a href="#__codelineno-14-45">45</a></span>
<span class="normal"><a href="#__codelineno-14-46">46</a></span>
<span class="normal"><a href="#__codelineno-14-47">47</a></span>
<span class="normal"><a href="#__codelineno-14-48">48</a></span>
<span class="normal"><a href="#__codelineno-14-49">49</a></span>
<span class="normal"><a href="#__codelineno-14-50">50</a></span>
<span class="normal"><a href="#__codelineno-14-51">51</a></span>
<span class="normal"><a href="#__codelineno-14-52">52</a></span>
<span class="normal"><a href="#__codelineno-14-53">53</a></span>
<span class="normal"><a href="#__codelineno-14-54">54</a></span>
<span class="normal"><a href="#__codelineno-14-55">55</a></span>
<span class="normal"><a href="#__codelineno-14-56">56</a></span>
<span class="normal"><a href="#__codelineno-14-57">57</a></span>
<span class="normal"><a href="#__codelineno-14-58">58</a></span>
<span class="normal"><a href="#__codelineno-14-59">59</a></span>
<span class="normal"><a href="#__codelineno-14-60">60</a></span>
<span class="normal"><a href="#__codelineno-14-61">61</a></span>
<span class="normal"><a href="#__codelineno-14-62">62</a></span>
<span class="normal"><a href="#__codelineno-14-63">63</a></span>
<span class="normal"><a href="#__codelineno-14-64">64</a></span>
<span class="normal"><a href="#__codelineno-14-65">65</a></span>
<span class="normal"><a href="#__codelineno-14-66">66</a></span>
<span class="normal"><a href="#__codelineno-14-67">67</a></span>
<span class="normal"><a href="#__codelineno-14-68">68</a></span>
<span class="normal"><a href="#__codelineno-14-69">69</a></span>
<span class="normal"><a href="#__codelineno-14-70">70</a></span>
<span class="normal"><a href="#__codelineno-14-71">71</a></span>
<span class="normal"><a href="#__codelineno-14-72">72</a></span>
<span class="normal"><a href="#__codelineno-14-73">73</a></span>
<span class="normal"><a href="#__codelineno-14-74">74</a></span>
<span class="normal"><a href="#__codelineno-14-75">75</a></span>
<span class="normal"><a href="#__codelineno-14-76">76</a></span>
<span class="normal"><a href="#__codelineno-14-77">77</a></span>
<span class="normal"><a href="#__codelineno-14-78">78</a></span>
<span class="normal"><a href="#__codelineno-14-79">79</a></span>
<span class="normal"><a href="#__codelineno-14-80">80</a></span>
<span class="normal"><a href="#__codelineno-14-81">81</a></span>
<span class="normal"><a href="#__codelineno-14-82">82</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">StandardDiffusionLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>        <span class="n">sigma_sampler_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>        <span class="n">loss_weighting_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>        <span class="n">loss_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"l2"</span><span class="p">,</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>        <span class="n">offset_noise_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a>        <span class="n">batch2model_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>    <span class="p">):</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a>        <span class="k">assert</span> <span class="n">loss_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"l2"</span><span class="p">,</span> <span class="s2">"l1"</span><span class="p">,</span> <span class="s2">"lpips"</span><span class="p">]</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_sampler</span> <span class="o">=</span> <span class="n">instantiate_from_config</span><span class="p">(</span><span class="n">sigma_sampler_config</span><span class="p">)</span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_weighting</span> <span class="o">=</span> <span class="n">instantiate_from_config</span><span class="p">(</span><span class="n">loss_weighting_config</span><span class="p">)</span>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">=</span> <span class="n">loss_type</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">offset_noise_level</span> <span class="o">=</span> <span class="n">offset_noise_level</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a>        <span class="k">if</span> <span class="n">loss_type</span> <span class="o">==</span> <span class="s2">"lpips"</span><span class="p">:</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lpips</span> <span class="o">=</span> <span class="n">LPIPS</span><span class="p">()</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch2model_keys</span><span class="p">:</span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a>            <span class="n">batch2model_keys</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch2model_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a>            <span class="n">batch2model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch2model_keys</span><span class="p">]</span>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch2model_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">batch2model_keys</span><span class="p">)</span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_noised_input</span><span class="p">(</span>
<a id="__codelineno-14-24" name="__codelineno-14-24"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">sigmas_bc</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">noise</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
<a id="__codelineno-14-25" name="__codelineno-14-25"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-14-26" name="__codelineno-14-26"></a>        <span class="n">noised_input</span> <span class="o">=</span> <span class="nb">input</span> <span class="o">+</span> <span class="n">noise</span> <span class="o">*</span> <span class="n">sigmas_bc</span>
<a id="__codelineno-14-27" name="__codelineno-14-27"></a>        <span class="k">return</span> <span class="n">noised_input</span>
<a id="__codelineno-14-28" name="__codelineno-14-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
<a id="__codelineno-14-29" name="__codelineno-14-29"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-14-30" name="__codelineno-14-30"></a>        <span class="n">network</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
<a id="__codelineno-14-31" name="__codelineno-14-31"></a>        <span class="n">denoiser</span><span class="p">:</span> <span class="n">Denoiser</span><span class="p">,</span>
<a id="__codelineno-14-32" name="__codelineno-14-32"></a>        <span class="n">conditioner</span><span class="p">:</span> <span class="n">GeneralConditioner</span><span class="p">,</span>
<a id="__codelineno-14-33" name="__codelineno-14-33"></a>        <span class="nb">input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<a id="__codelineno-14-34" name="__codelineno-14-34"></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-14-35" name="__codelineno-14-35"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-14-36" name="__codelineno-14-36"></a>        <span class="n">cond</span> <span class="o">=</span> <span class="n">conditioner</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-14-37" name="__codelineno-14-37"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">denoiser</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-14-38" name="__codelineno-14-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_forward</span><span class="p">(</span>
<a id="__codelineno-14-39" name="__codelineno-14-39"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-14-40" name="__codelineno-14-40"></a>        <span class="n">network</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
<a id="__codelineno-14-41" name="__codelineno-14-41"></a>        <span class="n">denoiser</span><span class="p">:</span> <span class="n">Denoiser</span><span class="p">,</span>
<a id="__codelineno-14-42" name="__codelineno-14-42"></a>        <span class="n">cond</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-14-43" name="__codelineno-14-43"></a>        <span class="nb">input</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<a id="__codelineno-14-44" name="__codelineno-14-44"></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-14-45" name="__codelineno-14-45"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<a id="__codelineno-14-46" name="__codelineno-14-46"></a>        <span class="n">additional_model_inputs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-14-47" name="__codelineno-14-47"></a>            <span class="n">key</span><span class="p">:</span> <span class="n">batch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch2model_keys</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-14-48" name="__codelineno-14-48"></a>        <span class="p">}</span>
<a id="__codelineno-14-49" name="__codelineno-14-49"></a>        <span class="n">sigmas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_sampler</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-14-50" name="__codelineno-14-50"></a>        <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-14-51" name="__codelineno-14-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_noise_level</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-14-52" name="__codelineno-14-52"></a>            <span class="n">offset_shape</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-14-53" name="__codelineno-14-53"></a>                <span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<a id="__codelineno-14-54" name="__codelineno-14-54"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-14-55" name="__codelineno-14-55"></a>                <span class="k">else</span> <span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-14-56" name="__codelineno-14-56"></a>            <span class="p">)</span>
<a id="__codelineno-14-57" name="__codelineno-14-57"></a>            <span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_noise_level</span> <span class="o">*</span> <span class="n">append_dims</span><span class="p">(</span>
<a id="__codelineno-14-58" name="__codelineno-14-58"></a>                <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">offset_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
<a id="__codelineno-14-59" name="__codelineno-14-59"></a>                <span class="nb">input</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span>
<a id="__codelineno-14-60" name="__codelineno-14-60"></a>            <span class="p">)</span>
<a id="__codelineno-14-61" name="__codelineno-14-61"></a>        <span class="n">sigmas_bc</span> <span class="o">=</span> <span class="n">append_dims</span><span class="p">(</span><span class="n">sigmas</span><span class="p">,</span> <span class="nb">input</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
<a id="__codelineno-14-62" name="__codelineno-14-62"></a>        <span class="n">noised_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_noised_input</span><span class="p">(</span><span class="n">sigmas_bc</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-14-63" name="__codelineno-14-63"></a>
<a id="__codelineno-14-64" name="__codelineno-14-64"></a>        <span class="n">model_output</span> <span class="o">=</span> <span class="n">denoiser</span><span class="p">(</span>
<a id="__codelineno-14-65" name="__codelineno-14-65"></a>            <span class="n">network</span><span class="p">,</span> <span class="n">noised_input</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_model_inputs</span>
<a id="__codelineno-14-66" name="__codelineno-14-66"></a>        <span class="p">)</span>
<a id="__codelineno-14-67" name="__codelineno-14-67"></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">append_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_weighting</span><span class="p">(</span><span class="n">sigmas</span><span class="p">),</span> <span class="nb">input</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
<a id="__codelineno-14-68" name="__codelineno-14-68"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">model_output</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-14-69" name="__codelineno-14-69"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<a id="__codelineno-14-70" name="__codelineno-14-70"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">"l2"</span><span class="p">:</span>
<a id="__codelineno-14-71" name="__codelineno-14-71"></a>            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-14-72" name="__codelineno-14-72"></a>                <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">model_output</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span>
<a id="__codelineno-14-73" name="__codelineno-14-73"></a>            <span class="p">)</span>
<a id="__codelineno-14-74" name="__codelineno-14-74"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">"l1"</span><span class="p">:</span>
<a id="__codelineno-14-75" name="__codelineno-14-75"></a>            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-14-76" name="__codelineno-14-76"></a>                <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">model_output</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span>
<a id="__codelineno-14-77" name="__codelineno-14-77"></a>            <span class="p">)</span>
<a id="__codelineno-14-78" name="__codelineno-14-78"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">"lpips"</span><span class="p">:</span>
<a id="__codelineno-14-79" name="__codelineno-14-79"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpips</span><span class="p">(</span><span class="n">model_output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-14-80" name="__codelineno-14-80"></a>            <span class="k">return</span> <span class="n">loss</span>
<a id="__codelineno-14-81" name="__codelineno-14-81"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-82" name="__codelineno-14-82"></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown loss type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p>Fot the EDM training, the sampling of sigma is continuous class</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span>
<span class="normal"><a href="#__codelineno-15-6">6</a></span>
<span class="normal"><a href="#__codelineno-15-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">EDMSampling</span><span class="p">:</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_mean</span><span class="o">=-</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">p_std</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">p_mean</span> <span class="o">=</span> <span class="n">p_mean</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">p_std</span> <span class="o">=</span> <span class="n">p_std</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">rand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a>        <span class="n">log_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_mean</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_std</span> <span class="o">*</span> <span class="n">default</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,)))</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a>        <span class="k">return</span> <span class="n">log_sigma</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
</code></pre></div></td></tr></tbody></table></div>
<p>One thing need to mention in the code, the forward process</p>
<div class="arithmatex">\[x_t =x_0 +\sigma_t \epsilon\]</div>
<p>And different from the previous versoin, the network predicted the original input but not the noise.</p>









  






<script type="application/json" class="js-hypothesis-config">
{
  "openSidebar": false,
  "showHighlights": true,
  "theme": "clean"
}
</script>
<script async src="https://hypothes.is/embed.js"></script>

<!-- Hypothesis æ ·å¼ç¾ŽåŒ– -->
<style>
  /* ä¿®æ”¹é«˜äº®æ•ˆæžœä¸ºä¸‹åˆ’çº¿å’ŒèŠå¤©æ³¡æ³¡ */
  .hypothesis-highlight {
    background-color: transparent !important; /* ç§»é™¤é«˜äº®èƒŒæ™¯ */
    text-decoration: underline !important;
    text-decoration-color: #4285f4 !important;
    text-decoration-thickness: 2px !important;
    text-decoration-style: wavy !important;
    position: relative !important;
    cursor: pointer !important;
    border-bottom: none !important; /* ç§»é™¤ä¹‹å‰çš„è¾¹æ¡† */
    box-shadow: none !important; /* ç§»é™¤ä¹‹å‰çš„é˜´å½± */
  }

  .hypothesis-highlight::after {
    content: "ðŸ’¬" !important;
    position: absolute !important;
    display: inline-block !important;
    font-size: 14px !important;
    top: -10px !important;
    right: -5px !important;
    opacity: 0.7 !important;
    transition: opacity 0.3s ease !important;
  }

  .hypothesis-highlight:hover {
    background-color: rgba(66, 133, 244, 0.08) !important; /* é¼ æ ‡æ‚¬åœæ—¶çš„è½»å¾®èƒŒæ™¯ */
  }

  .hypothesis-highlight:hover::after {
    opacity: 1 !important;
    transform: scale(1.2) !important;
  }

  /* ç¾ŽåŒ– Hypothesis ä¾§è¾¹æ  */
  hypothesis-sidebar {
    font-family: var(--md-text-font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif) !important;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1) !important;
  }

  /* ç¾ŽåŒ–å¡ç‰‡æ ·å¼ */
  .hypothesis-annotation-card {
    border-radius: 8px !important;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05) !important;
    transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    overflow: hidden !important;
  }

  .hypothesis-annotation-card:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
  }

  /* ç¾ŽåŒ– Hypothesis æŒ‰é’® */
  .hypothesis-button {
    border-radius: 4px !important;
    transition: background-color 0.2s ease !important;
  }

  /* ç¾ŽåŒ–æ ‡ç­¾æ ·å¼ */
  .hypothesis-tag {
    border-radius: 12px !important;
    padding: 2px 8px !important;
    font-size: 12px !important;
    background-color: rgba(0, 0, 0, 0.05) !important;
    color: #606060 !important;
  }

  /* ç¾ŽåŒ–å·¥å…·æ  */
  .hypothesis-toolbar {
    background: linear-gradient(to right, #f5f5f5, #ffffff) !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
  }

  /* ç¾ŽåŒ–æ³¨é‡Šé¢æ¿header */
  .hypothesis-annotation-header {
    padding: 10px !important;
    background-color: #f9f9f9 !important;
  }

  /* ç¾ŽåŒ–æ³¨é‡Šå†…å®¹ */
  .hypothesis-annotation-body {
    font-size: 14px !important;
    line-height: 1.6 !important;
    color: #333 !important;
  }

  /* ç¾ŽåŒ–ç”¨æˆ·å */
  .hypothesis-user {
    font-weight: 600 !important;
    color: #3f51b5 !important;
  }

  /* ç¾ŽåŒ–æ—¶é—´æˆ³ */
  .hypothesis-timestamp {
    font-size: 12px !important;
    color: #757575 !important;
  }

  /* ç¾ŽåŒ–è¾“å…¥æ¡† */
  .hypothesis-input {
    border-radius: 4px !important;
    border: 1px solid #e0e0e0 !important;
    transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
  }

  .hypothesis-input:focus {
    border-color: #4dabf7 !important;
    box-shadow: 0 0 0 2px rgba(77, 171, 247, 0.2) !important;
    outline: none !important;
  }
</style>

<!-- é¡µé¢è¯„è®ºç³»ç»Ÿ -->
<div class="comments-container utterances-container">
  <div class="comments-header">
    <h2 id="__comments" class="comments-title">
      <span class="comments-icon">ðŸ’¬</span>
      Comments
      <span class="comments-subtitle">Share your thoughts!</span>
    </h2>
    <div class="comments-divider"></div>
  </div>

  <div class="comments-wrapper">
    <script src="https://utteranc.es/client.js" repo="MAD-SG/generative-ai-start-to-surrender" issue-term="pathname" label="comment" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>
  </div>
</div>

<style>
  .comments-container {
    margin: 2.5rem auto;
    padding: 1.5rem;
    background: var(--md-code-bg-color, rgba(0, 0, 0, 0.05));
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .annotation-container {
    margin-bottom: 1rem;
    background: rgba(255, 255, 240, 0.5);
    border-left: 4px solid #ffeb3b;
  }

  .utterances-container {
    background: rgba(240, 248, 255, 0.5);
    border-left: 4px solid #2196f3;
  }

  .comments-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
  }

  .comments-header {
    margin-bottom: 1.5rem;
  }

  .comments-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0;
    margin-bottom: 0.75rem;
    color: var(--md-primary-fg-color, #2196f3);
    flex-wrap: wrap;
  }

  .annotation-container .comments-title {
    color: #f57c00;
  }

  .comments-icon {
    font-size: 1.4em;
  }

  .comments-subtitle {
    font-size: 0.7em;
    font-weight: 400;
    opacity: 0.8;
    margin-left: 1rem;
  }

  .comments-divider {
    height: 3px;
    background: linear-gradient(90deg,
      var(--md-primary-fg-color, #2196f3) 0%,
      rgba(255, 255, 255, 0) 100%);
    border-radius: 3px;
    margin-bottom: 1rem;
    width: 100%;
  }

  .annotation-container .comments-divider {
    background: linear-gradient(90deg,
      #f57c00 0%,
      rgba(255, 255, 255, 0) 100%);
  }

  .comments-wrapper {
    position: relative;
    min-height: 150px;
    width: 100%;
  }

  .hypothesis-instructions {
    padding: 1rem;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 6px;
    margin-bottom: 1rem;
  }

  .hypothesis-instructions p {
    margin-top: 0;
    font-weight: 500;
  }

  .hypothesis-instructions ol {
    margin-bottom: 0;
    padding-left: 1.5rem;
  }

  .hypothesis-instructions li {
    margin-bottom: 0.5rem;
  }

  .hypothesis-instructions li:last-child {
    margin-bottom: 0;
  }

  /* ç¡®ä¿utterancesçš„iframeå¡«å……å¯ç”¨å®½åº¦ */
  .utterances-container .comments-wrapper iframe {
    border-radius: 6px;
    width: 100% !important;
    max-width: 100% !important;
  }

  /* åŠ¨ç”»æ•ˆæžœ */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translate3d(0, 20px, 0);
    }
    to {
      opacity: 1;
      transform: translate3d(0, 0, 0);
    }
  }

  .comments-wrapper {
    animation: fadeInUp 0.6s ease forwards;
  }

  /* å“åº”å¼è®¾è®¡ - å°å±å¹•è°ƒæ•´ */
  @media (max-width: 768px) {
    .comments-container {
      padding: 1rem;
      margin: 1.5rem auto;
    }

    .comments-title {
      font-size: 1.3rem;
    }

    .comments-subtitle {
      display: block;
      width: 100%;
      margin-left: 0;
      margin-top: 0.3rem;
    }
  }
</style>
                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../stable_diffusion_series/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Overview
              </div>
            </div>
          </a>
        
        
          
          <a href="../stable_diffusion_3_reading/" class="md-footer__link md-footer__link--next" aria-label="Next: Stable Diffusion 3">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Stable Diffusion 3
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://mad-sg.github.io/generative-ai-start-to-surrender/" target="_blank" rel="noopener" title="mad-sg.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://hub.docker.com/r/squidfunk/mkdocs-material/" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/mkdocs-material/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://bsky.app/profile/squidfunk.bsky.social" target="_blank" rel="noopener" title="bsky.app" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M407.8 294.7c-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3M288 227.1c-26.1-50.7-97.1-145.2-163.1-191.8C61.6-9.4 37.5-1.7 21.6 5.5 3.3 13.8 0 41.9 0 58.4S9.1 194 15 213.9c19.5 65.7 89.1 87.9 153.2 80.7 3.3-.5 6.6-.9 10-1.4-3.3.5-6.6 1-10 1.4-93.9 14-177.3 48.2-67.9 169.9C220.6 589.1 265.1 437.8 288 361.1c22.9 76.7 49.2 222.5 185.6 103.4 102.4-103.4 28.1-156-65.8-169.9-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3 64.1 7.1 133.6-15.1 153.2-80.7C566.9 194 576 75 576 58.4s-3.3-44.7-21.6-52.9c-15.8-7.1-40-14.9-103.2 29.8C385.1 81.9 314.1 176.4 288 227.1"></path></svg>
    </a>
  
    
    
      
    
    
    
      
      
    
    <a href="https://fosstodon.org/@squidfunk" target="_blank" rel="noopener me" title="fosstodon.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M433 179.1c0-97.2-63.7-125.7-63.7-125.7-62.5-28.7-228.6-28.4-290.5 0 0 0-63.7 28.5-63.7 125.7 0 115.7-6.6 259.4 105.6 289.1 40.5 10.7 75.3 13 103.3 11.4 50.8-2.8 79.3-18.1 79.3-18.1l-1.7-36.9s-36.3 11.4-77.1 10.1c-40.4-1.4-83-4.4-89.6-54-.6-4.6-.9-9.3-.9-13.9 85.6 20.9 158.7 9.1 178.7 6.7 56.1-6.7 105-41.3 111.2-72.9 9.8-49.8 9-121.5 9-121.5zm-75.1 125.2h-46.6V190.1c0-49.7-64-51.6-64 6.9v62.5H201V197c0-58.5-64-56.6-64-6.9v114.2H90.3c0-122.1-5.2-147.9 18.4-175 25.9-28.9 79.8-30.8 103.8 6.1l11.6 19.5 11.6-19.5c24.1-37.1 78.1-34.8 103.8-6.1 23.7 27.3 18.4 53 18.4 175"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://x.com/squidfunk" target="_blank" rel="noopener" title="x.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M357.2 48h70.6L273.6 224.2 455 464H313L201.7 318.6 74.5 464H3.8l164.9-188.5L-5.2 48h145.6l100.5 132.9zm-24.8 373.8h39.1L119.1 88h-42z"></path></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.tabs", "toc.integrate", "content.code.copy", "content.code.select", "content.code.annotate", "content.tabs.link", "content.footnote.tooltips", "content.tooltips", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.expand", "search.share", "search.suggest"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.26.1/minified.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html><!-- æ®µè½æ³¨é‡Šç³»ç»Ÿ
<div class="comments-container annotation-container">
  <div class="comments-header">
    <h2 id="__annotations" class="comments-title">
      <span class="comments-icon">ðŸ”</span>
      æ®µè½æ³¨é‡Š
      <span class="comments-subtitle">æ‚¨å¯ä»¥é«˜äº®å¹¶è¯„è®ºä»»ä½•æ–‡æœ¬!</span>
    </h2>
    <div class="comments-divider"></div>
  </div>

  <div class="comments-wrapper">
    <div class="hypothesis-instructions">
      <p><strong>å¦‚ä½•ä½¿ç”¨æ®µè½æ³¨é‡ŠåŠŸèƒ½ï¼š</strong></p>
      <ol>
        <li>ç‚¹å‡»å³ä¸Šè§’çš„ <img src="https://hypothes.is/assets/images/logo.png" alt="Hypothesis" style="height: 16px; vertical-align: middle;"> å›¾æ ‡æ‰“å¼€ä¾§è¾¹æ </li>
        <li>é€‰æ‹©ä»»æ„æ–‡æœ¬æ®µè½å³å¯é«˜äº®å¹¶æ·»åŠ æ³¨é‡Š</li>
        <li>æ‚¨è¿˜å¯ä»¥å¯¹å…¶ä»–äººçš„æ³¨é‡Šè¿›è¡Œå›žå¤</li>
      </ol>
    </div>
  </div>
</div> --><!-- åŠ è½½  -->