<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../ldm/">
      
      
        <link rel="next" href="../diffusion_model_varients/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>LDM Handson - Generative AI: From Start to Surrender</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
  <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#latent-diffusion-handson" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Generative AI: From Start to Surrender" class="md-header__button md-logo" aria-label="Generative AI: From Start to Surrender" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Generative AI: From Start to Surrender
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              LDM Handson
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo" aria-label="Switch to system preference" type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../chapter1_Introduction/1.1terminology/" class="md-tabs__link">
          
  
  
    
  
  Introduction

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../chapter2_generation_theory/mle/" class="md-tabs__link">
          
  
  
    
  
  Generation Theory

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../chapter3_energy_based_model/introduction/" class="md-tabs__link">
          
  
  
    
  
  Energy Based Models

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../chapter6_VAE/vae_introduction/" class="md-tabs__link">
          
  
  
    
  
  VAE

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../chapter5_GAN/3.1from_gan_to_stylegan/paper/" class="md-tabs__link">
          
  
  
    
  
  GANs

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../ddpm/" class="md-tabs__link">
          
  
  
    
  
  Diffusion Models

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../chapter9_flow_matching/introduction/" class="md-tabs__link">
          
  
  
    
  
  Flow Matching

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../chapter11_hybrid_sota_models/hybrid_methods/" class="md-tabs__link">
          
  
  
    
  
  Hybrid SOTA Models

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../chapter12_applications/diffusion_anomaly_detection/" class="md-tabs__link">
          
  
  
    
  
  Application

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Generative AI: From Start to Surrender" class="md-nav__button md-logo" aria-label="Generative AI: From Start to Surrender" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    Generative AI: From Start to Surrender
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Introduction
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1_Introduction/1.1terminology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Terms
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1_Introduction/1.2fourier_transform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fourier Transform
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1_Introduction/1.3signal_processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Signal Processing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1_Introduction/1.4statistics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Statistics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1_Introduction/tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Generation Theory
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Generation Theory
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2_generation_theory/mle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Maximal Likelihood
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2_generation_theory/manifold_hypothesis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Manifold Hypothesis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2_generation_theory/generative_model_category/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Generative Model Category
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4">
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Energy Based Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Energy Based Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3_energy_based_model/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3_energy_based_model/score_function/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Score Functions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3_energy_based_model/sampling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sampling Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3_energy_based_model/cd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contrastive Divergence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3_energy_based_model/score_matching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Score Matching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5">
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    VAE
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    VAE
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6_VAE/vae_introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6_VAE/vq_vae/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VA-VAE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6">
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    GANs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    GANs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5_GAN/3.1from_gan_to_stylegan/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    From GAN to StyleGAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_2">
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN Variants
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    StyleGAN Variants
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5_GAN/3.3stylegan/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5_GAN/3.4stylegan2/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5_GAN/3.5stylegan3/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5_GAN/3.6styleganT/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StyleGAN-T
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5_GAN/3.7R3Gan/paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    R3GAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5_GAN/vq_gan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VQ-GAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diffusion Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" checked>
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Discrete Diffusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Discrete Diffusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ddpm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DDPM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ldm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LDM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    LDM Handson
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    LDM Handson
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-build-a-web-demo" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Build A Web Demo
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-generating-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Generating Results
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Code
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-autoencoder" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Autoencoder
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-ddpm" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 DDPM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-latent-dm" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 Latent DM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-unet" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4 UNet
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-ddim-sampling" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5 DDIM sampling
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../diffusion_model_varients/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Model Varients
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../general_diffusion_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    General Diffusion Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_2">
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    SDE Diffusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    SDE Diffusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../introduction_sde/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE Fundamentals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../from_ddpm_2_sde/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE for DDPM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../score_based_sde/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Score Based SDE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../probability_flow_ode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Probability Flow ODE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sde_diffusion_speedup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE Diffusion Speedup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sde_diffusion_unified_representation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Scaling and Scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_3">
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Network
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diffusion Network
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DiT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DiT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_4">
        
          
          <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Solver
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diffusion Solver
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../diffusion_solver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DPM Solver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_5">
        
          
          <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Conditional Diffusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Conditional Diffusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../controlnet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ControlNet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sde_diffusion_guidance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SDE Diffusion Guidance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8">
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Flow Matching
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Flow Matching
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9_flow_matching/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9_flow_matching/probability_with_velocity_field/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Probability Path and Velocity Fields
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9_flow_matching/flow_matching_theory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flow Matching Theorem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9_flow_matching/affine_conditional_flows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Affine Conditional Flow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9_flow_matching/optimal_transport_flow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Optimal Transport Flow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9_flow_matching/comparison_with_flow_ode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comparison with Diffusion Flow ODE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9">
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Hybrid SOTA Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Hybrid SOTA Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/hybrid_methods/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hybrid Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/sota_closed_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Closed Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9_3">
        
          
          <label class="md-nav__link" for="__nav_9_3" id="__nav_9_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Open Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Open Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/sota_open_models/dalle_series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dalle Series
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9_3_2">
        
          
          <label class="md-nav__link" for="__nav_9_3_2" id="__nav_9_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion Series
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Stable Diffusion Series
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/sota_open_models/stable_diffusion_series/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/sota_open_models/stable_diffusion_xl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion XL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/sota_open_models/stable_diffusion_3_reading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion 3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/sota_open_models/stable_diffusion_3_5_reading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stable Diffusion 3.5
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9_3_3">
        
          
          <label class="md-nav__link" for="__nav_9_3_3" id="__nav_9_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Flux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Flux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/sota_open_models/flux1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flux.1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/sota_open_models/flux.1_kontext/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flux.1 Kontext
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/sota_open_models/qwen_image/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Qwen-Image
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter11_hybrid_sota_models/trends_future/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Future Trends
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10">
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Application
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Application
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_1">
        
          
          <label class="md-nav__link" for="__nav_10_1" id="__nav_10_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Anomaly Detection
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Anomaly Detection
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/diffusion_anomaly_detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diffusion Anomaly Detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_2">
        
          
          <label class="md-nav__link" for="__nav_10_2" id="__nav_10_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Deepfake Detection
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Deepfake Detection
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection_structured/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/FOCAL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FOCAL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/PSCC-Net/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PSCC-Net
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/DeCLIP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DeCLIP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/FakeLocator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FakeLocator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/Weakly-supervised-Deepfake-Localization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Weakly-supervised Deepfake Localization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/FSBI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FSBI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/DE-FAKE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DE-FAKE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/DADF/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DADF
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/SIDA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SIDA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/UnivCLIP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UnivCLIP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/Multi-Attention-Based-Approach/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Attention-Based-Approach
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/Mastering-Deepfake-Detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mastering-Deepfake-Detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/Leveraging-Frequency-Analysis-for-Deep-Fake-Image-Recognition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Leveraging-Frequency-Analysis-for-Deep-Fake-Image-Recognition
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter12_applications/deepfake_detection/An-Analysis-of-Recent-Advances-in-Deepfake-Image-Detection-in-an-Evolving-Threat-Landscape/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    An-Analysis-of-Recent-Advances-in-Deepfake-Image-Detection-in-an-Evolving-Threat-Landscape
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="latent-diffusion-handson">Latent Diffusion Handson<a class="headerlink" href="#latent-diffusion-handson" title="Permanent link"></a></h1>
<h2 id="1-build-a-web-demo">1. Build A Web Demo<a class="headerlink" href="#1-build-a-web-demo" title="Permanent link"></a></h2>
<p>Web Demo</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../images/image-50.png" data-desc-position="bottom"><img alt="alt text" src="../../../images/image-50.png"></a>
Refer the demo in <code>demo/sd_demo/app.py</code> in the repo.</p>
<h2 id="2-generating-results">2. Generating Results<a class="headerlink" href="#2-generating-results" title="Permanent link"></a></h2>
<h2 id="3-code">3. Code<a class="headerlink" href="#3-code" title="Permanent link"></a></h2>
<p>The overall framework concists of two main blocks, <code>ddpm</code> and <code>vae</code></p>
<p>The <code>vae</code> devides intro two types, either the <code>VQ-GAN</code> or <code>KL-VAE</code>. Refer VQ-GAN for more details. Here we only look as the structure details about the <code>KL-VAE</code>. And in the future version, stable diffusion only used the <code>KL-VAE</code>.</p>
<h3 id="31-autoencoder">3.1 Autoencoder<a class="headerlink" href="#31-autoencoder" title="Permanent link"></a></h3>
<h4 id="311-autoencoderkl">3.1.1 AutoencoderKL<a class="headerlink" href="#311-autoencoderkl" title="Permanent link"></a></h4>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">AutoEncoderKL</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">  1</a></span>
<span class="normal"><a href="#__codelineno-0-2">  2</a></span>
<span class="normal"><a href="#__codelineno-0-3">  3</a></span>
<span class="normal"><a href="#__codelineno-0-4">  4</a></span>
<span class="normal"><a href="#__codelineno-0-5">  5</a></span>
<span class="normal"><a href="#__codelineno-0-6">  6</a></span>
<span class="normal"><a href="#__codelineno-0-7">  7</a></span>
<span class="normal"><a href="#__codelineno-0-8">  8</a></span>
<span class="normal"><a href="#__codelineno-0-9">  9</a></span>
<span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AutoencoderKL</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="sd">"""</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="sd">     KL </span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="sd">    </span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="sd">    </span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    </span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    """</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>                 <span class="n">ddconfig</span><span class="p">,</span> <span class="c1"># </span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>                 <span class="n">lossconfig</span><span class="p">,</span> <span class="c1">#  instantiate_from_config </span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>                 <span class="n">embed_dim</span><span class="p">,</span> <span class="c1"># </span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>                 <span class="n">ckpt_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># </span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>                 <span class="n">ignore_keys</span><span class="o">=</span><span class="p">[],</span> <span class="c1"># </span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>                 <span class="n">image_key</span><span class="o">=</span><span class="s2">"image"</span><span class="p">,</span> <span class="c1">#  batch  "image"</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>                 <span class="n">colorize_nlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1">#  RGB</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>                 <span class="n">monitor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># </span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>                 <span class="p">):</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="err">```</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="n"></span> <span class="n">ddconfig</span> <span class="n"></span><span class="err"></span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="n"></span> <span class="n">lossconfig</span> <span class="n"></span><span class="err"></span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="n"></span> <span class="n">ddconfig</span><span class="p">[</span><span class="s2">"double_z"</span><span class="p">]</span> <span class="n"></span> <span class="kc">True</span><span class="err"></span><span class="n"></span><span class="err"></span><span class="n"></span><span class="err"></span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n"></span><span class="err"></span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">quant_conv</span><span class="err"></span><span class="n"></span><span class="err"></span><span class="n"></span> <span class="mi">2</span><span class="o">*</span><span class="n">z_channels</span><span class="err"></span><span class="n"></span> <span class="mi">2</span><span class="o">*</span><span class="n">embed_dim</span><span class="err"></span><span class="n"></span><span class="err"></span><span class="n"></span><span class="err"></span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">post_quant_conv</span><span class="err"></span><span class="n"></span><span class="err"></span><span class="n"></span> <span class="n">embed_dim</span> <span class="n"></span> <span class="n">z_channels</span><span class="err"></span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n"></span> <span class="n">colorize_nlabels</span> <span class="n"></span><span class="err"></span><span class="n"></span> <span class="n">colorize</span> <span class="n"></span> <span class="n">buffer</span><span class="err"></span><span class="n"></span> <span class="n">RGB</span> <span class="n"></span><span class="err"></span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n"></span><span class="err"></span><span class="n"></span> <span class="n">init_from_ckpt</span> <span class="n"></span><span class="err"></span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="err">```</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_key</span> <span class="o">=</span> <span class="n">image_key</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="o">**</span><span class="n">ddconfig</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="o">**</span><span class="n">ddconfig</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">instantiate_from_config</span><span class="p">(</span><span class="n">lossconfig</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="k">assert</span> <span class="n">ddconfig</span><span class="p">[</span><span class="s2">"double_z"</span><span class="p">]</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">quant_conv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ddconfig</span><span class="p">[</span><span class="s2">"z_channels"</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">embed_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">post_quant_conv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">embed_dim</span><span class="p">,</span> <span class="n">ddconfig</span><span class="p">[</span><span class="s2">"z_channels"</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="n">embed_dim</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="k">if</span> <span class="n">colorize_nlabels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">colorize_nlabels</span><span class="p">)</span><span class="o">==</span><span class="nb">int</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">"colorize"</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">colorize_nlabels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="k">if</span> <span class="n">monitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">if</span> <span class="n">ckpt_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">init_from_ckpt</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="n">ignore_keys</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_from_ckpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="nb">list</span><span class="p">()):</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">        </span><span class="sd">"""  init_from_ckpt</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        state_dict</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        </span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">         ignore_keys </span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">         load_state_dict strict=False </span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        """</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">sd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">"cpu"</span><span class="p">)[</span><span class="s2">"state_dict"</span><span class="p">]</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sd</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="n">ignore_keys</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ik</span><span class="p">):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">"Deleting key </span><span class="si">{}</span><span class="s2"> from state_dict."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                    <span class="k">del</span> <span class="n">sd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Restored from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        encode </span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">         x  h</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">         quant_conv moments</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">         DiagonalGaussianDistribution</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        """</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">moments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quant_conv</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">posterior</span> <span class="o">=</span> <span class="n">DiagonalGaussianDistribution</span><span class="p">(</span><span class="n">moments</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">return</span> <span class="n">posterior</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">         z  post_quant_conv </span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        """</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_quant_conv</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="k">return</span> <span class="n">dec</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">sample_posterior</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">         encode  posterior</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">         sample_posterior  z</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">         z  decode </span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        </span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        """</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="n">posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">if</span> <span class="n">sample_posterior</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="n">z</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="k">return</span> <span class="n">dec</span><span class="p">,</span> <span class="n">posterior</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="err">```</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n"></span><span class="err"></span><span class="n"></span> <span class="n">batch</span> <span class="n"></span><span class="err"></span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n"></span><span class="err"></span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n"></span> <span class="n">image_key</span> <span class="n"></span><span class="err"></span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n"></span> <span class="mi">3</span><span class="err"></span><span class="n"></span><span class="err"></span><span class="n"></span><span class="err"></span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n"></span> <span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span> <span class="n"></span> <span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span><span class="err"></span><span class="n"></span> <span class="n">PyTorch</span> <span class="n"></span><span class="err"></span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n"></span><span class="err"></span><span class="n"></span><span class="err"></span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="err">```</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">contiguous_format</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">optimizer_idx</span><span class="p">):</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">        training_step </span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">         optimizer_idx encoder+decoder</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">         optimizer_idx == 0KL </span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">         optimizer_idx == 1</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">         self.loss </span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        validation_step </span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">         "val/rec_loss"</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">        """</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_key</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="n">reconstructions</span><span class="p">,</span> <span class="n">posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="k">if</span> <span class="n">optimizer_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="c1"># train encoder+decoder+logvar</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="n">aeloss</span><span class="p">,</span> <span class="n">log_dict_ae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">reconstructions</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">optimizer_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">,</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                                            <span class="n">last_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_last_layer</span><span class="p">(),</span> <span class="n">split</span><span class="o">=</span><span class="s2">"train"</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"aeloss"</span><span class="p">,</span> <span class="n">aeloss</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log_dict</span><span class="p">(</span><span class="n">log_dict_ae</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="k">return</span> <span class="n">aeloss</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">if</span> <span class="n">optimizer_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="c1"># train the discriminator</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="n">discloss</span><span class="p">,</span> <span class="n">log_dict_disc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">reconstructions</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">optimizer_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                                                <span class="n">last_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_last_layer</span><span class="p">(),</span> <span class="n">split</span><span class="o">=</span><span class="s2">"train"</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"discloss"</span><span class="p">,</span> <span class="n">discloss</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log_dict</span><span class="p">(</span><span class="n">log_dict_disc</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="k">return</span> <span class="n">discloss</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_key</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">reconstructions</span><span class="p">,</span> <span class="n">posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">aeloss</span><span class="p">,</span> <span class="n">log_dict_ae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">reconstructions</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                                        <span class="n">last_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_last_layer</span><span class="p">(),</span> <span class="n">split</span><span class="o">=</span><span class="s2">"val"</span><span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="n">discloss</span><span class="p">,</span> <span class="n">log_dict_disc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">reconstructions</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                                            <span class="n">last_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_last_layer</span><span class="p">(),</span> <span class="n">split</span><span class="o">=</span><span class="s2">"val"</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"val/rec_loss"</span><span class="p">,</span> <span class="n">log_dict_ae</span><span class="p">[</span><span class="s2">"val/rec_loss"</span><span class="p">])</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_dict</span><span class="p">(</span><span class="n">log_dict_ae</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_dict</span><span class="p">(</span><span class="n">log_dict_disc</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_dict</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        </span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">            </span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">             Adam </span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">             self.loss.discriminator  Adam </span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">            self.learning_rate Adam betas=(0.5, 0.9)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        """</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="n">opt_ae</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">+</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                                  <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">+</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                                  <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quant_conv</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">+</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                                  <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post_quant_conv</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                                  <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">))</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">opt_disc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">discriminator</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                                    <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">))</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">opt_ae</span><span class="p">,</span> <span class="n">opt_disc</span><span class="p">],</span> <span class="p">[]</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_last_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="w">        </span><span class="sd">""""""</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">conv_out</span><span class="o">.</span><span class="n">weight</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">only_inputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        </span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">         3 to_rgb  RGB </span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">         "inputs""reconstructions""samples" </span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">        """</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="n">log</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_key</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_inputs</span><span class="p">:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="n">xrec</span><span class="p">,</span> <span class="n">posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="c1"># colorize with random projection</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                <span class="k">assert</span> <span class="n">xrec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="n">xrec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">xrec</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="n">log</span><span class="p">[</span><span class="s2">"samples"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">sample</span><span class="p">()))</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">log</span><span class="p">[</span><span class="s2">"reconstructions"</span><span class="p">]</span> <span class="o">=</span> <span class="n">xrec</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="n">log</span><span class="p">[</span><span class="s2">"inputs"</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">return</span> <span class="n">log</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_rgb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">        3 RGB </span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">         colorize buffer [-1, 1] </span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        """</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_key</span> <span class="o">==</span> <span class="s2">"segmentation"</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"colorize"</span><span class="p">):</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">"colorize"</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colorize</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="n">x</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">-</span> <span class="mf">1.</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div>
<p>Compared with a "normal" VAE, we need to check if the loss and encoding and decoding process is same to the normal VAE.</p>
<p>At first look, the loss combines two parts</p>
<ol>
<li>Standard VAE Loss, that is, the reconstruction loss + KL divergence (regularization) loss</li>
<li>GAN loss</li>
</ol>
<p>Theoretical, the loss should be</p>
<div class="arithmatex">\[\tag{1}
 \mathcal{L} = \frac{1}{N} \sum_{i=1}^{N} \| x_i - \hat{x}_i \|^2+ \sum_{l} \lambda_l \| \phi_l(x) - \phi_l(G(z)) \|_2^2  + \frac{1}{2} \sum_{j=1}^{d} (1 + \log \sigma_{i,j}^2 - \mu_{i,j}^2 - \sigma_{i,j}^2)+ L_{adv}
\]</div>
<p>where</p>
<div class="arithmatex">\[
L_{adv} = -\mathbb{E}_{z \sim p(z)}\left[ D\bigl(G(z)\bigr) \right]
\]</div>
<p>and <span class="arithmatex">\(\phi_l(x)\)</span> is the feature map from the pretrained CNN.</p>
<p>In equation (1), the first two can be considered as the perceptual reconstruction loss which is used in <code>VQ-GAN</code> to train the encoder and decoder.</p>
<p>Let's check if it is same with the above assumption.</p>
<h4 id="312-gaussian-sampling">3.1.2 Gaussian Sampling<a class="headerlink" href="#312-gaussian-sampling" title="Permanent link"></a></h4>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">Gaussian Sampling</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span>
<span class="normal"><a href="#__codelineno-1-32">32</a></span>
<span class="normal"><a href="#__codelineno-1-33">33</a></span>
<span class="normal"><a href="#__codelineno-1-34">34</a></span>
<span class="normal"><a href="#__codelineno-1-35">35</a></span>
<span class="normal"><a href="#__codelineno-1-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">DiagonalGaussianDistribution</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logvar</span><span class="p">,</span> <span class="o">-</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="n">deterministic</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span><span class="p">)</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logvar</span><span class="p">)</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deterministic</span><span class="p">:</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">kl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deterministic</span><span class="p">:</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">])</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a>            <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a>                <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a>                                       <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span><span class="p">,</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a>                                       <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>                <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a>                    <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">var</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a>                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">var</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">logvar</span><span class="p">,</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a>                    <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]):</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deterministic</span><span class="p">:</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a>            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">])</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a>        <span class="n">logtwopi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a>        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a>            <span class="n">logtwopi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">sample</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">,</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>            <span class="n">dim</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span>
</code></pre></div></td></tr></tbody></table></div>
<h4 id="313-losses">3.1.3 Losses<a class="headerlink" href="#313-losses" title="Permanent link"></a></h4>
<p>Details of the loss</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">LPIPSWithDiscriminator</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">  1</a></span>
<span class="normal"><a href="#__codelineno-2-2">  2</a></span>
<span class="normal"><a href="#__codelineno-2-3">  3</a></span>
<span class="normal"><a href="#__codelineno-2-4">  4</a></span>
<span class="normal"><a href="#__codelineno-2-5">  5</a></span>
<span class="normal"><a href="#__codelineno-2-6">  6</a></span>
<span class="normal"><a href="#__codelineno-2-7">  7</a></span>
<span class="normal"><a href="#__codelineno-2-8">  8</a></span>
<span class="normal"><a href="#__codelineno-2-9">  9</a></span>
<span class="normal"><a href="#__codelineno-2-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-2-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-2-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-2-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-2-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-2-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-2-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-2-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-2-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-2-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-2-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-2-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-2-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-2-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-2-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-2-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-2-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-2-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-2-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-2-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-2-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-2-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-2-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-2-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-2-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-2-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-2-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-2-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-2-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-2-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-2-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-2-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-2-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-2-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-2-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-2-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-2-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-2-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-2-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-2-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-2-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-2-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-2-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-2-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-2-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-2-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-2-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-2-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-2-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-2-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-2-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-2-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-2-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-2-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-2-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-2-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-2-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-2-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-2-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-2-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-2-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-2-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-2-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-2-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-2-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-2-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-2-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-2-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-2-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-2-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-2-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-2-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-2-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-2-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-2-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-2-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-2-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-2-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-2-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-2-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-2-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-2-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-2-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-2-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-2-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-2-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-2-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-2-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-2-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-2-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-2-100">100</a></span>
<span class="normal"><a href="#__codelineno-2-101">101</a></span>
<span class="normal"><a href="#__codelineno-2-102">102</a></span>
<span class="normal"><a href="#__codelineno-2-103">103</a></span>
<span class="normal"><a href="#__codelineno-2-104">104</a></span>
<span class="normal"><a href="#__codelineno-2-105">105</a></span>
<span class="normal"><a href="#__codelineno-2-106">106</a></span>
<span class="normal"><a href="#__codelineno-2-107">107</a></span>
<span class="normal"><a href="#__codelineno-2-108">108</a></span>
<span class="normal"><a href="#__codelineno-2-109">109</a></span>
<span class="normal"><a href="#__codelineno-2-110">110</a></span>
<span class="normal"><a href="#__codelineno-2-111">111</a></span>
<span class="normal"><a href="#__codelineno-2-112">112</a></span>
<span class="normal"><a href="#__codelineno-2-113">113</a></span>
<span class="normal"><a href="#__codelineno-2-114">114</a></span>
<span class="normal"><a href="#__codelineno-2-115">115</a></span>
<span class="normal"><a href="#__codelineno-2-116">116</a></span>
<span class="normal"><a href="#__codelineno-2-117">117</a></span>
<span class="normal"><a href="#__codelineno-2-118">118</a></span>
<span class="normal"><a href="#__codelineno-2-119">119</a></span>
<span class="normal"><a href="#__codelineno-2-120">120</a></span>
<span class="normal"><a href="#__codelineno-2-121">121</a></span>
<span class="normal"><a href="#__codelineno-2-122">122</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">taming.modules.losses.vqperceptual</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">LPIPSWithDiscriminator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">disc_start</span><span class="p">,</span> <span class="n">logvar_init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">kl_weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">pixelloss_weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>                 <span class="n">disc_num_layers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">disc_in_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">disc_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">disc_weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>                 <span class="n">perceptual_weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">use_actnorm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">disc_conditional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>                 <span class="n">disc_loss</span><span class="o">=</span><span class="s2">"hinge"</span><span class="p">):</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>        <span class="k">assert</span> <span class="n">disc_loss</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"hinge"</span><span class="p">,</span> <span class="s2">"vanilla"</span><span class="p">]</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_weight</span> <span class="o">=</span> <span class="n">kl_weight</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_weight</span> <span class="o">=</span> <span class="n">pixelloss_weight</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">perceptual_loss</span> <span class="o">=</span> <span class="n">LPIPS</span><span class="p">()</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>        <span class="c1"># LPIPSLearned Perceptual Image Patch Similarity#  perceptual_weight  0  # L1 </span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">perceptual_weight</span> <span class="o">=</span> <span class="n">perceptual_weight</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>        <span class="c1"># output log variance</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">())</span> <span class="o">*</span> <span class="n">logvar_init</span><span class="p">)</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>        <span class="c1"># self.logvar  $\exp(\text{logvar})$</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a>        <span class="c1">#  logvar</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span> <span class="o">=</span> <span class="n">NLayerDiscriminator</span><span class="p">(</span><span class="n">input_nc</span><span class="o">=</span><span class="n">disc_in_channels</span><span class="p">,</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a>                                                 <span class="n">n_layers</span><span class="o">=</span><span class="n">disc_num_layers</span><span class="p">,</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a>                                                 <span class="n">use_actnorm</span><span class="o">=</span><span class="n">use_actnorm</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>                                                 <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">weights_init</span><span class="p">)</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a>        <span class="c1">#  NLayerDiscriminator  use_actnorm </span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">discriminator_iter_start</span> <span class="o">=</span> <span class="n">disc_start</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a>        <span class="c1"># discriminator_iter_start </span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">disc_loss</span> <span class="o">=</span> <span class="n">hinge_d_loss</span> <span class="k">if</span> <span class="n">disc_loss</span> <span class="o">==</span> <span class="s2">"hinge"</span> <span class="k">else</span> <span class="n">vanilla_d_loss</span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a>        <span class="c1"># disc_conditional </span>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a>        <span class="c1"># disc_loss  hinge  vanilla </span>
<a id="__codelineno-2-34" name="__codelineno-2-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">disc_factor</span> <span class="o">=</span> <span class="n">disc_factor</span>
<a id="__codelineno-2-35" name="__codelineno-2-35"></a>        <span class="c1"># disc_factor  discriminator_weight  GAN </span>
<a id="__codelineno-2-36" name="__codelineno-2-36"></a>
<a id="__codelineno-2-37" name="__codelineno-2-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">discriminator_weight</span> <span class="o">=</span> <span class="n">disc_weight</span>
<a id="__codelineno-2-38" name="__codelineno-2-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">disc_conditional</span> <span class="o">=</span> <span class="n">disc_conditional</span>
<a id="__codelineno-2-39" name="__codelineno-2-39"></a>
<a id="__codelineno-2-40" name="__codelineno-2-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_adaptive_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nll_loss</span><span class="p">,</span> <span class="n">g_loss</span><span class="p">,</span> <span class="n">last_layer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-2-42" name="__codelineno-2-42"></a><span class="sd">        NLLg_loss</span>
<a id="__codelineno-2-43" name="__codelineno-2-43"></a><span class="sd">        """</span>
<a id="__codelineno-2-44" name="__codelineno-2-44"></a>
<a id="__codelineno-2-45" name="__codelineno-2-45"></a>        <span class="k">if</span> <span class="n">last_layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-46" name="__codelineno-2-46"></a>            <span class="n">nll_grads</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">nll_loss</span><span class="p">,</span> <span class="n">last_layer</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-47" name="__codelineno-2-47"></a>            <span class="n">g_grads</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">g_loss</span><span class="p">,</span> <span class="n">last_layer</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-48" name="__codelineno-2-48"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-49" name="__codelineno-2-49"></a>            <span class="n">nll_grads</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">nll_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-50" name="__codelineno-2-50"></a>            <span class="n">g_grads</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">g_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-51" name="__codelineno-2-51"></a>
<a id="__codelineno-2-52" name="__codelineno-2-52"></a>        <span class="n">d_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">nll_grads</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">g_grads</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)</span>
<a id="__codelineno-2-53" name="__codelineno-2-53"></a>        <span class="n">d_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">d_weight</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<a id="__codelineno-2-54" name="__codelineno-2-54"></a>        <span class="n">d_weight</span> <span class="o">=</span> <span class="n">d_weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator_weight</span>
<a id="__codelineno-2-55" name="__codelineno-2-55"></a>        <span class="k">return</span> <span class="n">d_weight</span>
<a id="__codelineno-2-56" name="__codelineno-2-56"></a>
<a id="__codelineno-2-57" name="__codelineno-2-57"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">reconstructions</span><span class="p">,</span> <span class="n">posteriors</span><span class="p">,</span> <span class="n">optimizer_idx</span><span class="p">,</span>
<a id="__codelineno-2-58" name="__codelineno-2-58"></a>                <span class="n">global_step</span><span class="p">,</span> <span class="n">last_layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">"train"</span><span class="p">,</span>
<a id="__codelineno-2-59" name="__codelineno-2-59"></a>                <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-2-60" name="__codelineno-2-60"></a>        <span class="n">rec_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> <span class="o">-</span> <span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">())</span>
<a id="__codelineno-2-61" name="__codelineno-2-61"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perceptual_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-62" name="__codelineno-2-62"></a>            <span class="n">p_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perceptual_loss</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">())</span>
<a id="__codelineno-2-63" name="__codelineno-2-63"></a>            <span class="n">rec_loss</span> <span class="o">=</span> <span class="n">rec_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">perceptual_weight</span> <span class="o">*</span> <span class="n">p_loss</span>
<a id="__codelineno-2-64" name="__codelineno-2-64"></a>
<a id="__codelineno-2-65" name="__codelineno-2-65"></a>        <span class="n">nll_loss</span> <span class="o">=</span> <span class="n">rec_loss</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logvar</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span>
<a id="__codelineno-2-66" name="__codelineno-2-66"></a>        <span class="n">weighted_nll_loss</span> <span class="o">=</span> <span class="n">nll_loss</span>
<a id="__codelineno-2-67" name="__codelineno-2-67"></a>        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-68" name="__codelineno-2-68"></a>            <span class="n">weighted_nll_loss</span> <span class="o">=</span> <span class="n">weights</span><span class="o">*</span><span class="n">nll_loss</span>
<a id="__codelineno-2-69" name="__codelineno-2-69"></a>        <span class="n">weighted_nll_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_nll_loss</span><span class="p">)</span> <span class="o">/</span> <span class="n">weighted_nll_loss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-70" name="__codelineno-2-70"></a>        <span class="n">nll_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nll_loss</span><span class="p">)</span> <span class="o">/</span> <span class="n">nll_loss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-71" name="__codelineno-2-71"></a>        <span class="n">kl_loss</span> <span class="o">=</span> <span class="n">posteriors</span><span class="o">.</span><span class="n">kl</span><span class="p">()</span>
<a id="__codelineno-2-72" name="__codelineno-2-72"></a>        <span class="n">kl_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kl_loss</span><span class="p">)</span> <span class="o">/</span> <span class="n">kl_loss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-73" name="__codelineno-2-73"></a>
<a id="__codelineno-2-74" name="__codelineno-2-74"></a>        <span class="c1"># now the GAN part</span>
<a id="__codelineno-2-75" name="__codelineno-2-75"></a>        <span class="k">if</span> <span class="n">optimizer_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-76" name="__codelineno-2-76"></a>            <span class="c1"># generator update</span>
<a id="__codelineno-2-77" name="__codelineno-2-77"></a>            <span class="k">if</span> <span class="n">cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-78" name="__codelineno-2-78"></a>                <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_conditional</span>
<a id="__codelineno-2-79" name="__codelineno-2-79"></a>                <span class="n">logits_fake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">())</span>
<a id="__codelineno-2-80" name="__codelineno-2-80"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-81" name="__codelineno-2-81"></a>                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_conditional</span>
<a id="__codelineno-2-82" name="__codelineno-2-82"></a>                <span class="n">logits_fake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">cond</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-83" name="__codelineno-2-83"></a>            <span class="n">g_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logits_fake</span><span class="p">)</span>
<a id="__codelineno-2-84" name="__codelineno-2-84"></a>
<a id="__codelineno-2-85" name="__codelineno-2-85"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_factor</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-2-86" name="__codelineno-2-86"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-2-87" name="__codelineno-2-87"></a>                    <span class="n">d_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_adaptive_weight</span><span class="p">(</span><span class="n">nll_loss</span><span class="p">,</span> <span class="n">g_loss</span><span class="p">,</span> <span class="n">last_layer</span><span class="o">=</span><span class="n">last_layer</span><span class="p">)</span>
<a id="__codelineno-2-88" name="__codelineno-2-88"></a>                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
<a id="__codelineno-2-89" name="__codelineno-2-89"></a>                    <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span>
<a id="__codelineno-2-90" name="__codelineno-2-90"></a>                    <span class="n">d_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-2-91" name="__codelineno-2-91"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-92" name="__codelineno-2-92"></a>                <span class="n">d_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-2-93" name="__codelineno-2-93"></a>
<a id="__codelineno-2-94" name="__codelineno-2-94"></a>            <span class="n">disc_factor</span> <span class="o">=</span> <span class="n">adopt_weight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_factor</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">discriminator_iter_start</span><span class="p">)</span>
<a id="__codelineno-2-95" name="__codelineno-2-95"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">weighted_nll_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_weight</span> <span class="o">*</span> <span class="n">kl_loss</span> <span class="o">+</span> <span class="n">d_weight</span> <span class="o">*</span> <span class="n">disc_factor</span> <span class="o">*</span> <span class="n">g_loss</span>
<a id="__codelineno-2-96" name="__codelineno-2-96"></a>
<a id="__codelineno-2-97" name="__codelineno-2-97"></a>            <span class="n">log</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"</span><span class="si">{}</span><span class="s2">/total_loss"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">loss</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">/logvar"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span>
<a id="__codelineno-2-98" name="__codelineno-2-98"></a>                   <span class="s2">"</span><span class="si">{}</span><span class="s2">/kl_loss"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">kl_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">/nll_loss"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">nll_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
<a id="__codelineno-2-99" name="__codelineno-2-99"></a>                   <span class="s2">"</span><span class="si">{}</span><span class="s2">/rec_loss"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">rec_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
<a id="__codelineno-2-100" name="__codelineno-2-100"></a>                   <span class="s2">"</span><span class="si">{}</span><span class="s2">/d_weight"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">d_weight</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span>
<a id="__codelineno-2-101" name="__codelineno-2-101"></a>                   <span class="s2">"</span><span class="si">{}</span><span class="s2">/disc_factor"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">disc_factor</span><span class="p">),</span>
<a id="__codelineno-2-102" name="__codelineno-2-102"></a>                   <span class="s2">"</span><span class="si">{}</span><span class="s2">/g_loss"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">g_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
<a id="__codelineno-2-103" name="__codelineno-2-103"></a>                   <span class="p">}</span>
<a id="__codelineno-2-104" name="__codelineno-2-104"></a>            <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">log</span>
<a id="__codelineno-2-105" name="__codelineno-2-105"></a>
<a id="__codelineno-2-106" name="__codelineno-2-106"></a>        <span class="k">if</span> <span class="n">optimizer_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-2-107" name="__codelineno-2-107"></a>            <span class="c1"># second pass for discriminator update</span>
<a id="__codelineno-2-108" name="__codelineno-2-108"></a>            <span class="k">if</span> <span class="n">cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-109" name="__codelineno-2-109"></a>                <span class="n">logits_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
<a id="__codelineno-2-110" name="__codelineno-2-110"></a>                <span class="n">logits_fake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
<a id="__codelineno-2-111" name="__codelineno-2-111"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-112" name="__codelineno-2-112"></a>                <span class="n">logits_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">inputs</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">cond</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-113" name="__codelineno-2-113"></a>                <span class="n">logits_fake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">cond</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-114" name="__codelineno-2-114"></a>
<a id="__codelineno-2-115" name="__codelineno-2-115"></a>            <span class="n">disc_factor</span> <span class="o">=</span> <span class="n">adopt_weight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_factor</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">discriminator_iter_start</span><span class="p">)</span>
<a id="__codelineno-2-116" name="__codelineno-2-116"></a>            <span class="n">d_loss</span> <span class="o">=</span> <span class="n">disc_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_loss</span><span class="p">(</span><span class="n">logits_real</span><span class="p">,</span> <span class="n">logits_fake</span><span class="p">)</span>
<a id="__codelineno-2-117" name="__codelineno-2-117"></a>
<a id="__codelineno-2-118" name="__codelineno-2-118"></a>            <span class="n">log</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"</span><span class="si">{}</span><span class="s2">/disc_loss"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">d_loss</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
<a id="__codelineno-2-119" name="__codelineno-2-119"></a>                   <span class="s2">"</span><span class="si">{}</span><span class="s2">/logits_real"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">logits_real</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
<a id="__codelineno-2-120" name="__codelineno-2-120"></a>                   <span class="s2">"</span><span class="si">{}</span><span class="s2">/logits_fake"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">logits_fake</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-2-121" name="__codelineno-2-121"></a>                   <span class="p">}</span>
<a id="__codelineno-2-122" name="__codelineno-2-122"></a>            <span class="k">return</span> <span class="n">d_loss</span><span class="p">,</span> <span class="n">log</span>
</code></pre></div></td></tr></tbody></table></div>
<p>The default config for loss is</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nt">params</span><span class="p">:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="nt">disc_start</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50001</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="nt">kl_weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.000001</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="nt">disc_weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
</code></pre></div></td></tr></tbody></table></div>
<p>Here <code>adopt_weight</code> is defined as</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">adopt_weight</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="k">if</span> <span class="n">global_step</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>        <span class="n">weight</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="k">return</span> <span class="n">weight</span>
</code></pre></div></td></tr></tbody></table></div>
<p>which control in which step, we introduce the GAN loss.</p>
<h5 id="3131-adaptive-weights-for-reconstruction-loss-and-gan-loss">3.1.3.1 Adaptive weights for reconstruction loss and gan loss<a class="headerlink" href="#3131-adaptive-weights-for-reconstruction-loss-and-gan-loss" title="Permanent link"></a></h5>
<p>We can express <code>calculate_adaptive_weight</code>  using the following formula</p>
<ol>
<li>assume the gradient of last layer from the NLL loss</li>
</ol>
<div class="arithmatex">\[
\nabla_{\text{nll}} = \nabla_{\theta_{\text{last}}} \mathcal{L}_{\text{nll}}
\]</div>
<p>and the gradient of the last layer from the GAN loss</p>
<div class="arithmatex">\[
\nabla_{g} = \nabla_{\theta_{\text{last}}} \mathcal{L}_{g}
\]</div>
<ol>
<li>Adptive weights</li>
</ol>
<div class="arithmatex">\[
w_{\text{adaptive}} = \text{clip}\!\left(\frac{\|\nabla_{\text{nll}}\|}{\|\nabla_{g}\| + \epsilon}, \, 0, \, 10^4\right)
\]</div>
<ol>
<li>Finally adding the weights <span class="arithmatex">\(w_{\text{disc}}\)</span></li>
</ol>
<div class="arithmatex">\[
d_{\text{weight}} = w_{\text{adaptive}} \times w_{\text{disc}}
\]</div>
<p>It assumes that the norm of the gradient of the GAN should be equal to that of the reconstruction loss, make them in same level. Of course, finnaly, it will multiply another weights to control the importance of the GAN loss compared with other loss</p>
<h5 id="3132-forward">3.1.3.2 Forward<a class="headerlink" href="#3132-forward" title="Permanent link"></a></h5>
<p>The forward part is splited by the optimizer index, when <code>optimizer_idx==0</code>, it optimized the VAE, when <code>optimizer_idx==1</code>, it optimized the GAN</p>
<h6 id="31321-optimization-of-vae">3.1.3.2.1 Optimization of VAE<a class="headerlink" href="#31321-optimization-of-vae" title="Permanent link"></a></h6>
<p>It also splited into three parts</p>
<ol>
<li>reconstruction loss
    It used the <span class="arithmatex">\(L_1\)</span> loss for reconstruction loss. If the <code>perceptual_weight&gt;0</code>, it also combines with the <code>perceptual_loss</code>, which is usually a loss to constrained the feature map distances between the generation and input via a pretrained CNN feature extraction like "VGG"</li>
</ol>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">rec_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> <span class="o">-</span> <span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">())</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="c1">#  LPIPS </span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perceptual_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="n">p_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perceptual_loss</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">())</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>    <span class="n">rec_loss</span> <span class="o">=</span> <span class="n">rec_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">perceptual_weight</span> <span class="o">*</span> <span class="n">p_loss</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>    <span class="c1"># NLL  logvar</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="n">nll_loss</span> <span class="o">=</span> <span class="n">rec_loss</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logvar</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="n">weighted_nll_loss</span> <span class="o">=</span> <span class="n">nll_loss</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="n">weighted_nll_loss</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">nll_loss</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="n">weighted_nll_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_nll_loss</span><span class="p">)</span> <span class="o">/</span> <span class="n">weighted_nll_loss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="n">nll_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nll_loss</span><span class="p">)</span> <span class="o">/</span> <span class="n">nll_loss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></tbody></table></div>
<ol>
<li>
<p>KL Divergence
   posteriors.kl() the KL divence between the posteriors and the Gaussian distribution <span class="arithmatex">\(U(0,1)\)</span>. It is defined in the Gaissian Sampler <code>DiagonalGaussianDistribution</code>.  It it is a deterministic sampling, this loss returns <code>0</code>.</p>
</li>
<li>
<p>Gan Loss
    Since here it aimed to train the generator (VAE), we dont have the real part for adversary loss. If it is a conditional GAN, then put the conditional information into the input, which is a quite standard adversary loss.</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span>
<span class="normal"><a href="#__codelineno-6-6">6</a></span>
<span class="normal"><a href="#__codelineno-6-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">if</span> <span class="n">cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_conditional</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>    <span class="n">logits_fake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">())</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_conditional</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>    <span class="n">logits_fake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span> <span class="n">cond</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="n">g_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logits_fake</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
</li>
</ol>
<h6 id="31322-optimization-of-gan">3.1.3.2.2 Optimization of GAN<a class="headerlink" href="#31322-optimization-of-gan" title="Permanent link"></a></h6>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">if</span> <span class="n">optimizer_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="c1">#  logits</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>    <span class="k">if</span> <span class="n">cond</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>        <span class="n">logits_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>        <span class="n">logits_fake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>        <span class="n">logits_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">inputs</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">cond</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>        <span class="n">logits_fake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminator</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">reconstructions</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">cond</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>    <span class="c1">#  adopt_weight </span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>    <span class="n">disc_factor</span> <span class="o">=</span> <span class="n">adopt_weight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disc_factor</span><span class="p">,</span> <span class="n">global_step</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">discriminator_iter_start</span><span class="p">)</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>    <span class="c1">#  hinge  vanilla </span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>    <span class="n">d_loss</span> <span class="o">=</span> <span class="n">disc_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc_loss</span><span class="p">(</span><span class="n">logits_real</span><span class="p">,</span> <span class="n">logits_fake</span><span class="p">)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>    <span class="n">log</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"</span><span class="si">{}</span><span class="s2">/disc_loss"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">d_loss</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>           <span class="s2">"</span><span class="si">{}</span><span class="s2">/logits_real"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">logits_real</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>           <span class="s2">"</span><span class="si">{}</span><span class="s2">/logits_fake"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">):</span> <span class="n">logits_fake</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a>           <span class="p">}</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a>    <span class="k">return</span> <span class="n">d_loss</span><span class="p">,</span> <span class="n">log</span>
</code></pre></div></td></tr></tbody></table></div>
<p>To optimize the GAN, we only need the fake/real images. Also, add the condition into the <code>discriminator</code> when it is a conditional GAN.</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">hinge_d_loss</span><span class="p">(</span><span class="n">logits_real</span><span class="p">,</span> <span class="n">logits_fake</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="n">loss_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">logits_real</span><span class="p">))</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>    <span class="n">loss_fake</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">logits_fake</span><span class="p">))</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>    <span class="n">d_loss</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">loss_real</span> <span class="o">+</span> <span class="n">loss_fake</span><span class="p">)</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>    <span class="k">return</span> <span class="n">d_loss</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">vanilla_d_loss</span><span class="p">(</span><span class="n">logits_real</span><span class="p">,</span> <span class="n">logits_fake</span><span class="p">):</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>    <span class="n">d_loss</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="o">-</span><span class="n">logits_real</span><span class="p">))</span> <span class="o">+</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">logits_fake</span><span class="p">)))</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>    <span class="k">return</span> <span class="n">d_loss</span>
</code></pre></div></td></tr></tbody></table></div>
<p>use hinge or vanilla loss by the parameter
Below are the mathematical formulas for the two loss functions as implemented in the code:</p>
<hr>
<h6 id="31323-hinge-loss">3.1.3.2.3 Hinge Loss<a class="headerlink" href="#31323-hinge-loss" title="Permanent link"></a></h6>
<p>Given the discriminator outputs for real samples, <span class="arithmatex">\( D(x) \)</span>, and for generated samples, <span class="arithmatex">\( D(\tilde{x}) \)</span>, the hinge loss for the discriminator is defined as:</p>
<div class="arithmatex">\[
\mathcal{L}_D^{\text{hinge}} = \frac{1}{2} \left( \mathbb{E}_{x \sim p_{\text{data}}}\left[\max\left(0,\, 1 - D(x)\right)\right] + \mathbb{E}_{\tilde{x} \sim p_G}\left[\max\left(0,\, 1 + D(\tilde{x})\right)\right] \right)
\]</div>
<ul>
<li><span class="arithmatex">\(\max(0,\, 1 - D(x))\)</span> computes the loss for real samples.</li>
<li><span class="arithmatex">\(\max(0,\, 1 + D(\tilde{x}))\)</span> computes the loss for generated (fake) samples.</li>
</ul>
<h6 id="31324-vanilla-loss">3.1.3.2.4 Vanilla Loss<a class="headerlink" href="#31324-vanilla-loss" title="Permanent link"></a></h6>
<p>For the vanilla loss, we use the softplus function, defined as:</p>
<div class="arithmatex">\[
\text{softplus}(x) = \ln(1 + e^x)
\]</div>
<p>Then the vanilla loss for the discriminator is given by:</p>
<div class="arithmatex">\[
\mathcal{L}_D^{\text{vanilla}} = \frac{1}{2} \left( \mathbb{E}_{x \sim p_{\text{data}}}\left[\ln\left(1 + e^{-D(x)}\right)\right] + \mathbb{E}_{\tilde{x} \sim p_G}\left[\ln\left(1 + e^{D(\tilde{x})}\right)\right] \right)
\]</div>
<p>These formulas correspond exactly to the implementation in the code:</p>
<ul>
<li>For the hinge loss, the code computes <span class="arithmatex">\(\text{loss\_real} = \text{mean}(\text{ReLU}(1 - \text{logits\_real}))\)</span> and <span class="arithmatex">\(\text{loss\_fake} = \text{mean}(\text{ReLU}(1 + \text{logits\_fake}))\)</span>, then takes their average.</li>
<li>For the vanilla loss, the code computes <span class="arithmatex">\(\text{mean}(\text{softplus}(-\text{logits\_real}))\)</span> and <span class="arithmatex">\(\text{mean}(\text{softplus}(\text{logits\_fake}))\)</span> and averages them.
Here we plot the curve of the above two types of losses for intuitive comparison.</li>
</ul>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../images/image-47.png" data-desc-position="bottom"><img alt="alt text" src="../../../images/image-47.png"></a></p>
<h4 id="314-summary">3.1.4 Summary<a class="headerlink" href="#314-summary" title="Permanent link"></a></h4>
<p>Based on the above analysis, we can see that the loss is basically a normal <code>VAE loss</code> +  <code>GAN loss</code> + <code>Perceptural Loss</code>.</p>
<h3 id="32-ddpm">3.2 DDPM<a class="headerlink" href="#32-ddpm" title="Permanent link"></a></h3>
<p>Train latent diffusion</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span>&lt;GPU_ID&gt;<span class="w"> </span>python<span class="w"> </span>main.py<span class="w"> </span>--base<span class="w"> </span>configs/latent-diffusion/&lt;config_spec&gt;.yaml<span class="w"> </span>-t<span class="w"> </span>--gpus<span class="w"> </span><span class="m">0</span>,
</code></pre></div></td></tr></tbody></table></div>
<p>Let's study the codes step by step. The code is in <code>ldm/models/diffusion/ddpm.py</code> in <a href="https://github.com/CompVis/latent-diffusion">github: CompVis/latent-diffusion</a></p>
<h4 id="321-ddpm-class">3.2.1 DDPM Class<a class="headerlink" href="#321-ddpm-class" title="Permanent link"></a></h4>
<h5 id="3211-__init__">3.2.1.1 <code>__init__</code><a class="headerlink" href="#3211-__init__" title="Permanent link"></a></h5>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">init</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span>
<span class="normal"><a href="#__codelineno-10-38">38</a></span>
<span class="normal"><a href="#__codelineno-10-39">39</a></span>
<span class="normal"><a href="#__codelineno-10-40">40</a></span>
<span class="normal"><a href="#__codelineno-10-41">41</a></span>
<span class="normal"><a href="#__codelineno-10-42">42</a></span>
<span class="normal"><a href="#__codelineno-10-43">43</a></span>
<span class="normal"><a href="#__codelineno-10-44">44</a></span>
<span class="normal"><a href="#__codelineno-10-45">45</a></span>
<span class="normal"><a href="#__codelineno-10-46">46</a></span>
<span class="normal"><a href="#__codelineno-10-47">47</a></span>
<span class="normal"><a href="#__codelineno-10-48">48</a></span>
<span class="normal"><a href="#__codelineno-10-49">49</a></span>
<span class="normal"><a href="#__codelineno-10-50">50</a></span>
<span class="normal"><a href="#__codelineno-10-51">51</a></span>
<span class="normal"><a href="#__codelineno-10-52">52</a></span>
<span class="normal"><a href="#__codelineno-10-53">53</a></span>
<span class="normal"><a href="#__codelineno-10-54">54</a></span>
<span class="normal"><a href="#__codelineno-10-55">55</a></span>
<span class="normal"><a href="#__codelineno-10-56">56</a></span>
<span class="normal"><a href="#__codelineno-10-57">57</a></span>
<span class="normal"><a href="#__codelineno-10-58">58</a></span>
<span class="normal"><a href="#__codelineno-10-59">59</a></span>
<span class="normal"><a href="#__codelineno-10-60">60</a></span>
<span class="normal"><a href="#__codelineno-10-61">61</a></span>
<span class="normal"><a href="#__codelineno-10-62">62</a></span>
<span class="normal"><a href="#__codelineno-10-63">63</a></span>
<span class="normal"><a href="#__codelineno-10-64">64</a></span>
<span class="normal"><a href="#__codelineno-10-65">65</a></span>
<span class="normal"><a href="#__codelineno-10-66">66</a></span>
<span class="normal"><a href="#__codelineno-10-67">67</a></span>
<span class="normal"><a href="#__codelineno-10-68">68</a></span>
<span class="normal"><a href="#__codelineno-10-69">69</a></span>
<span class="normal"><a href="#__codelineno-10-70">70</a></span>
<span class="normal"><a href="#__codelineno-10-71">71</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">DDPM</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="c1"># classic DDPM with Gaussian diffusion, in image space</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>                 <span class="n">unet_config</span><span class="p">,</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>                 <span class="n">timesteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>                 <span class="n">beta_schedule</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">,</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>                 <span class="n">loss_type</span><span class="o">=</span><span class="s2">"l2"</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>                 <span class="n">ckpt_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>                 <span class="n">ignore_keys</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>                 <span class="n">load_only_unet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>                 <span class="n">monitor</span><span class="o">=</span><span class="s2">"val/loss"</span><span class="p">,</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>                 <span class="n">use_ema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>                 <span class="n">first_stage_key</span><span class="o">=</span><span class="s2">"image"</span><span class="p">,</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>                 <span class="n">image_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>                 <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>                 <span class="n">log_every_t</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a>                 <span class="n">clip_denoised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a>                 <span class="n">linear_start</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a>                 <span class="n">linear_end</span><span class="o">=</span><span class="mf">2e-2</span><span class="p">,</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a>                 <span class="n">cosine_s</span><span class="o">=</span><span class="mf">8e-3</span><span class="p">,</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a>                 <span class="n">given_betas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>                 <span class="n">original_elbo_weight</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a>                 <span class="n">v_posterior</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>  <span class="c1"># weight for choosing posterior variance as sigma = (1-v) * beta_tilde + v * beta</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a>                 <span class="n">l_simple_weight</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a>                 <span class="n">conditioning_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a>                 <span class="n">parameterization</span><span class="o">=</span><span class="s2">"eps"</span><span class="p">,</span>  <span class="c1"># all assuming fixed variance schedules</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a>                 <span class="n">scheduler_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a>                 <span class="n">use_positional_encodings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a>                 <span class="n">learn_logvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a>                 <span class="n">logvar_init</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a>                 <span class="p">):</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a>        <span class="k">assert</span> <span class="n">parameterization</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"eps"</span><span class="p">,</span> <span class="s2">"x0"</span><span class="p">],</span> <span class="s1">'currently only supporting "eps" and "x0"'</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">=</span> <span class="n">parameterization</span>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: Running in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span><span class="si">}</span><span class="s2">-prediction mode"</span><span class="p">)</span>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cond_stage_model</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-10-37" name="__codelineno-10-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clip_denoised</span> <span class="o">=</span> <span class="n">clip_denoised</span>
<a id="__codelineno-10-38" name="__codelineno-10-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_every_t</span> <span class="o">=</span> <span class="n">log_every_t</span>
<a id="__codelineno-10-39" name="__codelineno-10-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_stage_key</span> <span class="o">=</span> <span class="n">first_stage_key</span>
<a id="__codelineno-10-40" name="__codelineno-10-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span> <span class="o">=</span> <span class="n">image_size</span>  <span class="c1"># try conv?</span>
<a id="__codelineno-10-41" name="__codelineno-10-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
<a id="__codelineno-10-42" name="__codelineno-10-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_positional_encodings</span> <span class="o">=</span> <span class="n">use_positional_encodings</span>
<a id="__codelineno-10-43" name="__codelineno-10-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">DiffusionWrapper</span><span class="p">(</span><span class="n">unet_config</span><span class="p">,</span> <span class="n">conditioning_key</span><span class="p">)</span>
<a id="__codelineno-10-44" name="__codelineno-10-44"></a>        <span class="n">count_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-10-45" name="__codelineno-10-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_ema</span> <span class="o">=</span> <span class="n">use_ema</span>
<a id="__codelineno-10-46" name="__codelineno-10-46"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ema</span><span class="p">:</span>
<a id="__codelineno-10-47" name="__codelineno-10-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model_ema</span> <span class="o">=</span> <span class="n">LitEma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-10-48" name="__codelineno-10-48"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Keeping EMAs of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_ema</span><span class="o">.</span><span class="n">buffers</span><span class="p">()))</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>
<a id="__codelineno-10-49" name="__codelineno-10-49"></a>
<a id="__codelineno-10-50" name="__codelineno-10-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_scheduler</span> <span class="o">=</span> <span class="n">scheduler_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-10-51" name="__codelineno-10-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_scheduler</span><span class="p">:</span>
<a id="__codelineno-10-52" name="__codelineno-10-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_config</span> <span class="o">=</span> <span class="n">scheduler_config</span>
<a id="__codelineno-10-53" name="__codelineno-10-53"></a>
<a id="__codelineno-10-54" name="__codelineno-10-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">v_posterior</span> <span class="o">=</span> <span class="n">v_posterior</span>
<a id="__codelineno-10-55" name="__codelineno-10-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_elbo_weight</span> <span class="o">=</span> <span class="n">original_elbo_weight</span>
<a id="__codelineno-10-56" name="__codelineno-10-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">l_simple_weight</span> <span class="o">=</span> <span class="n">l_simple_weight</span>
<a id="__codelineno-10-57" name="__codelineno-10-57"></a>
<a id="__codelineno-10-58" name="__codelineno-10-58"></a>        <span class="k">if</span> <span class="n">monitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-10-59" name="__codelineno-10-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
<a id="__codelineno-10-60" name="__codelineno-10-60"></a>        <span class="k">if</span> <span class="n">ckpt_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-10-61" name="__codelineno-10-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">init_from_ckpt</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="n">ignore_keys</span><span class="p">,</span> <span class="n">only_model</span><span class="o">=</span><span class="n">load_only_unet</span><span class="p">)</span>
<a id="__codelineno-10-62" name="__codelineno-10-62"></a>
<a id="__codelineno-10-63" name="__codelineno-10-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_schedule</span><span class="p">(</span><span class="n">given_betas</span><span class="o">=</span><span class="n">given_betas</span><span class="p">,</span> <span class="n">beta_schedule</span><span class="o">=</span><span class="n">beta_schedule</span><span class="p">,</span> <span class="n">timesteps</span><span class="o">=</span><span class="n">timesteps</span><span class="p">,</span>
<a id="__codelineno-10-64" name="__codelineno-10-64"></a>                               <span class="n">linear_start</span><span class="o">=</span><span class="n">linear_start</span><span class="p">,</span> <span class="n">linear_end</span><span class="o">=</span><span class="n">linear_end</span><span class="p">,</span> <span class="n">cosine_s</span><span class="o">=</span><span class="n">cosine_s</span><span class="p">)</span>
<a id="__codelineno-10-65" name="__codelineno-10-65"></a>
<a id="__codelineno-10-66" name="__codelineno-10-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">=</span> <span class="n">loss_type</span>
<a id="__codelineno-10-67" name="__codelineno-10-67"></a>
<a id="__codelineno-10-68" name="__codelineno-10-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">learn_logvar</span> <span class="o">=</span> <span class="n">learn_logvar</span>
<a id="__codelineno-10-69" name="__codelineno-10-69"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="n">logvar_init</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">,))</span>
<a id="__codelineno-10-70" name="__codelineno-10-70"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_logvar</span><span class="p">:</span>
<a id="__codelineno-10-71" name="__codelineno-10-71"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logvar</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logvar</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p>The DDPM class is herited from the <code>pl.LightningModule</code>, includes the forward, reversem training and sampling processes.</p>
<p>In the init part,</p>
<ul>
<li><code>timesteps=1000</code> is the diffusion steps, usually be 1000,</li>
<li><code>beta_schedule='linear'</code> is the noise scheduler that controls <span class="arithmatex">\(\beta_t\)</span></li>
<li><code>parameterization="eps"</code> is the training target, 'eps' means network predicted the noise, <code>x0</code> means predict the denoied image</li>
<li><code>use_ema=True</code> means the expotentinoal moving average to stabalize the training. <code>LitEma(self.model)</code> defines the ema model</li>
<li><code>logvar_init=0</code>: the initial value of log var in the traiing. Can be choose to learn or use fixed value.</li>
<li><code>self.model = DiffusionWrapper(unet_config, conditioning_key)</code> defines the U-Net used in the diffusion proces</li>
</ul>
<h5 id="3212-register_schedule">3.2.1.2 <code>register_schedule</code><a class="headerlink" href="#3212-register_schedule" title="Permanent link"></a></h5>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">register_schedule</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span>
<span class="normal"><a href="#__codelineno-11-43">43</a></span>
<span class="normal"><a href="#__codelineno-11-44">44</a></span>
<span class="normal"><a href="#__codelineno-11-45">45</a></span>
<span class="normal"><a href="#__codelineno-11-46">46</a></span>
<span class="normal"><a href="#__codelineno-11-47">47</a></span>
<span class="normal"><a href="#__codelineno-11-48">48</a></span>
<span class="normal"><a href="#__codelineno-11-49">49</a></span>
<span class="normal"><a href="#__codelineno-11-50">50</a></span>
<span class="normal"><a href="#__codelineno-11-51">51</a></span>
<span class="normal"><a href="#__codelineno-11-52">52</a></span>
<span class="normal"><a href="#__codelineno-11-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">given_betas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta_schedule</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">,</span> <span class="n">timesteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>                          <span class="n">linear_start</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">linear_end</span><span class="o">=</span><span class="mf">2e-2</span><span class="p">,</span> <span class="n">cosine_s</span><span class="o">=</span><span class="mf">8e-3</span><span class="p">):</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">given_betas</span><span class="p">):</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>            <span class="n">betas</span> <span class="o">=</span> <span class="n">given_betas</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>            <span class="n">betas</span> <span class="o">=</span> <span class="n">make_beta_schedule</span><span class="p">(</span><span class="n">beta_schedule</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">linear_start</span><span class="o">=</span><span class="n">linear_start</span><span class="p">,</span> <span class="n">linear_end</span><span class="o">=</span><span class="n">linear_end</span><span class="p">,</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>                                       <span class="n">cosine_s</span><span class="o">=</span><span class="n">cosine_s</span><span class="p">)</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>        <span class="n">alphas</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">betas</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>        <span class="n">alphas_cumprod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>        <span class="n">alphas_cumprod_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">alphas_cumprod</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>        <span class="n">timesteps</span><span class="p">,</span> <span class="o">=</span> <span class="n">betas</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timesteps</span><span class="p">)</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear_start</span> <span class="o">=</span> <span class="n">linear_start</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear_end</span> <span class="o">=</span> <span class="n">linear_end</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>        <span class="k">assert</span> <span class="n">alphas_cumprod</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">,</span> <span class="s1">'alphas have to be defined for each timestep'</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>        <span class="n">to_torch</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'betas'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">betas</span><span class="p">))</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">alphas_cumprod</span><span class="p">))</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'alphas_cumprod_prev'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">alphas_cumprod_prev</span><span class="p">))</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a>        <span class="c1"># calculations for diffusion q(x_t | x_{t-1}) and others</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'sqrt_alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alphas_cumprod</span><span class="p">)))</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'sqrt_one_minus_alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="p">)))</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'log_one_minus_alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="p">)))</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'sqrt_recip_alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">alphas_cumprod</span><span class="p">)))</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'sqrt_recipm1_alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">alphas_cumprod</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a>        <span class="c1"># calculations for posterior q(x_{t-1} | x_t, x_0)</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a>        <span class="n">posterior_variance</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_posterior</span><span class="p">)</span> <span class="o">*</span> <span class="n">betas</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod_prev</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a>                    <span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_posterior</span> <span class="o">*</span> <span class="n">betas</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>        <span class="c1"># above: equal to 1. / (1. / (1. - alpha_cumprod_tm1) + alpha_t / beta_t)</span>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'posterior_variance'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">posterior_variance</span><span class="p">))</span>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a>        <span class="c1"># below: log calculation clipped because the posterior variance is 0 at the beginning of the diffusion chain</span>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'posterior_log_variance_clipped'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">posterior_variance</span><span class="p">,</span> <span class="mf">1e-20</span><span class="p">))))</span>
<a id="__codelineno-11-38" name="__codelineno-11-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'posterior_mean_coef1'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span>
<a id="__codelineno-11-39" name="__codelineno-11-39"></a>            <span class="n">betas</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alphas_cumprod_prev</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="p">)))</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'posterior_mean_coef2'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a>            <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod_prev</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="p">)))</span>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a>
<a id="__codelineno-11-43" name="__codelineno-11-43"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">==</span> <span class="s2">"eps"</span><span class="p">:</span>
<a id="__codelineno-11-44" name="__codelineno-11-44"></a>            <span class="n">lvlb_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">betas</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a>                        <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior_variance</span> <span class="o">*</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_cumprod</span><span class="p">))</span>
<a id="__codelineno-11-46" name="__codelineno-11-46"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">==</span> <span class="s2">"x0"</span><span class="p">:</span>
<a id="__codelineno-11-47" name="__codelineno-11-47"></a>            <span class="n">lvlb_weights</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">alphas_cumprod</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">alphas_cumprod</span><span class="p">))</span>
<a id="__codelineno-11-48" name="__codelineno-11-48"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-49" name="__codelineno-11-49"></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"mu not supported"</span><span class="p">)</span>
<a id="__codelineno-11-50" name="__codelineno-11-50"></a>        <span class="c1"># TODO how to choose this term</span>
<a id="__codelineno-11-51" name="__codelineno-11-51"></a>        <span class="n">lvlb_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lvlb_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-11-52" name="__codelineno-11-52"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'lvlb_weights'</span><span class="p">,</span> <span class="n">lvlb_weights</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-11-53" name="__codelineno-11-53"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lvlb_weights</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div></td></tr></tbody></table></div>
<p><code>register_schedule</code> is mainly used tp <strong>calculate the noise scheduler</strong>, including the  <span class="arithmatex">\(\beta_t\)</span> (noise), <span class="arithmatex">\(\alpha_t\)</span> (original image info) accumulated <span class="arithmatex">\(\alpha_t\)</span>, (<span class="arithmatex">\(\bar{\alpha}_t\)</span>), and mean and variance of posterior distribution <span class="arithmatex">\(q(x_{t-1} | x_t, x_0)\)</span>.</p>
<p><strong><span class="arithmatex">\(\beta_t\)</span></strong></p>
<ul>
<li><strong>Linear</strong>:</li>
</ul>
<p>$$
  \beta_t = \text{linear_start} + t \cdot \frac{\text{linear_end} - \text{linear_start}}{\text{timesteps} - 1}
  $$</p>
<p>Here  <code>linear_start = 1e-4</code><code>linear_end = 2e-2</code>noise is increasing w.r.t <span class="arithmatex">\(t\)</span>.</p>
<ul>
<li><strong>Cosine</strong>:</li>
</ul>
<p>$$
  \beta_t = 1 - \frac{\cos\left(\frac{t / T + s}{1 + s} \cdot \frac{\pi}{2} \right)^2}{\cos\left(\frac{s}{1+s} \cdot \frac{\pi}{2}\right)^2}
  $$</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>`s = 8e-3` controls the initial noise
</code></pre></div></td></tr></tbody></table></div>
<p><strong><span class="arithmatex">\(\alpha_t\)</span> and  <span class="arithmatex">\(\bar{\alpha}_t\)</span></strong></p>
<ul>
<li><strong><span class="arithmatex">\(\alpha_t\)</span></strong>:</li>
</ul>
<p>$$
  \alpha_t = 1 - \beta_t
  $$</p>
<ul>
<li><strong><span class="arithmatex">\(\bar{\alpha}_t\)</span> (product of previous <span class="arithmatex">\(t\)</span> steps)</strong>:</li>
</ul>
<p>$$
  \bar{\alpha}<em i="1">t = \prod</em> \alpha_i
  $$}^{t</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>$\bar{\alpha}_t$ represents the aspect of original info is left from $x_0$ to $x_t$
</code></pre></div></td></tr></tbody></table></div>
<p><strong><span class="arithmatex">\(q(x_{t-1} | x_t, x_0)\)</span></strong></p>
<ul>
<li><strong>mean <span class="arithmatex">\(\mu_t\)</span></strong>:</li>
</ul>
<p>$$
  \mu_t = \frac{\sqrt{\bar{\alpha}<em t-1="t-1">{t-1}} \beta_t}{1 - \bar{\alpha}_t} x_0 + \frac{\sqrt{\alpha_t} (1 - \bar{\alpha}</em> x_t
  $$})}{1 - \bar{\alpha}_t</p>
<ul>
<li><strong>varience <span class="arithmatex">\(\sigma_t^2\)</span></strong>:</li>
</ul>
<p>$$
  \sigma_t^2 = (1 - v) \cdot \frac{\beta_t (1 - \bar{\alpha}_{t-1})}{1 - \bar{\alpha}_t} + v \cdot \beta_t
  $$</p>
<p><code>v</code><code>v_posterior</code>) determines the calculatetion of the variance, default <code>v=0</code></p>
<p>According to the 'make_beta_schedule' formula</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">betas</span> <span class="o">=</span> <span class="n">make_beta_schedule</span><span class="p">(</span><span class="n">beta_schedule</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">linear_start</span><span class="o">=</span><span class="n">linear_start</span><span class="p">,</span> <span class="n">linear_end</span><span class="o">=</span><span class="n">linear_end</span><span class="p">,</span> <span class="n">cosine_s</span><span class="o">=</span><span class="n">cosine_s</span><span class="p">)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="n">alphas</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">betas</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="n">alphas_cumprod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="n">alphas_cumprod_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">alphas_cumprod</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li>Here <code>betas</code>  is  <span class="arithmatex">\(\beta_t\)</span><code>alphas</code> is <span class="arithmatex">\(\alpha_t\)</span><code>alphas_cumprod</code> is <span class="arithmatex">\(\bar{\alpha}_t\)</span>.</li>
</ul>
<p>Here is uses the <code>make_beta_schedule</code> functoin, which is</p>
<p>The function <code>make_beta_schedule</code> is designed to generate the noise schedule <span class="arithmatex">\(\beta_t\)</span> used in the diffusion process. Different scheduling methods impact the convergence and final image quality of the diffusion model.</p>
<p>Input Parameters</p>
<ul>
<li><code>schedule</code>: Specifies the method for computing <strong><span class="arithmatex">\(\beta_t\)</span></strong>.</li>
<li><code>n_timestep</code>: Total number of diffusion steps <code>T</code>, typically <strong>1000</strong>.</li>
<li><code>linear_start</code> &amp; <code>linear_end</code>:</li>
<li><strong>Linear schedule</strong>: <span class="arithmatex">\(\beta_t\)</span> gradually increases from <code>linear_start</code> to <code>linear_end</code>.</li>
<li><strong>Square root schedule</strong>: <span class="arithmatex">\(\beta_t\)</span> increases based on a <strong>square root transformation</strong>.</li>
<li><code>cosine_s=8e-3</code>:</li>
<li>
<p>Used in <strong>cosine schedule</strong>, typically for <strong>Stable Diffusion</strong>, improving stability.</p>
</li>
<li>
<p><strong>1. Linear Schedule</strong></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">if</span> <span class="n">schedule</span> <span class="o">==</span> <span class="s2">"linear"</span><span class="p">:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>    <span class="n">betas</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">linear_start</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">linear_end</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n_timestep</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>    <span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p><strong>Mathematical Formula</strong>:</p>
<p>$$
 \beta_t = \left( \sqrt{\text{linear_start}} + \frac{t}{T} \left( \sqrt{\text{linear_end}} - \sqrt{\text{linear_start}} \right) \right)^2
 $$</p>
<p>First <strong>take the square root</strong>, then apply <strong>linear interpolation</strong>, and finally <strong>square the values</strong>.
This ensures a <strong>smooth increase</strong> in <span class="arithmatex">\(\beta_t\)</span>.</p>
</li>
<li>
<p><strong>2. Cosine Schedule</strong></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span>
<span class="normal"><a href="#__codelineno-14-5">5</a></span>
<span class="normal"><a href="#__codelineno-14-6">6</a></span>
<span class="normal"><a href="#__codelineno-14-7">7</a></span>
<span class="normal"><a href="#__codelineno-14-8">8</a></span>
<span class="normal"><a href="#__codelineno-14-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">elif</span> <span class="n">schedule</span> <span class="o">==</span> <span class="s2">"cosine"</span><span class="p">:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>    <span class="n">timesteps</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_timestep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_timestep</span> <span class="o">+</span> <span class="n">cosine_s</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>    <span class="p">)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>    <span class="n">alphas</span> <span class="o">=</span> <span class="n">timesteps</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cosine_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>    <span class="n">alphas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>    <span class="n">alphas</span> <span class="o">=</span> <span class="n">alphas</span> <span class="o">/</span> <span class="n">alphas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a>    <span class="n">betas</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alphas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">alphas</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>    <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p><strong>Mathematical Formula</strong>:</p>
<p>$$
  \alpha_t = \cos^2 \left( \frac{t/T + s}{1 + s} \cdot \frac{\pi}{2} \right)
$$
  - <code>s</code> controls the <strong>initial noise strength</strong>.
  - <span class="arithmatex">\(\alpha_t\)</span> is normalized so that <span class="arithmatex">\(\alpha_0 = 1\)</span>.
  - <span class="arithmatex">\(\beta_t = 1 - \frac{\alpha_{t+1}}{\alpha_t}\)</span> ensures <span class="arithmatex">\(\beta_t\)</span> is computed correctly.</p>
<ul>
<li><strong>Key Features</strong>:</li>
<li>Cosine scheduling <strong>increases slowly at first</strong> and then <strong>rapidly</strong> towards the end.</li>
<li>This better <strong>matches human perception of noise</strong> and improves <strong>detail generation</strong>.</li>
</ul>
</li>
<li>
<p><strong>3. Square Root Linear Schedule</strong></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="k">elif</span> <span class="n">schedule</span> <span class="o">==</span> <span class="s2">"sqrt_linear"</span><span class="p">:</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>    <span class="n">betas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">linear_start</span><span class="p">,</span> <span class="n">linear_end</span><span class="p">,</span> <span class="n">n_timestep</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p><strong>Mathematical Formula</strong>:
$$
 \beta_t = \text{linear_start} + \frac{t}{T} \left( \text{linear_end} - \text{linear_start} \right)
$$
<span class="arithmatex">\(\beta_t\)</span> <strong>increases uniformly</strong> over time.</p>
</li>
<li>
<p><strong>4. Square Root Schedule</strong></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="k">elif</span> <span class="n">schedule</span> <span class="o">==</span> <span class="s2">"sqrt"</span><span class="p">:</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>    <span class="n">betas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">linear_start</span><span class="p">,</span> <span class="n">linear_end</span><span class="p">,</span> <span class="n">n_timestep</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
</code></pre></div></td></tr></tbody></table></div>
<p><strong>Mathematical Formula</strong>:</p>
<div class="arithmatex">\[
\beta_t = \left( \text{linear\_start} + \frac{t}{T} \left( \text{linear\_end} - \text{linear\_start} \right) \right)^{0.5}
\]</div>
<p><strong>Takes the square root</strong> to achieve a <strong>smoother increase</strong> in <span class="arithmatex">\(\beta_t\)</span>.</p>
</li>
</ul>
<p><strong>Comparison of Different <span class="arithmatex">\(\beta_t\)</span> Schedules</strong></p>
<table>
<thead>
<tr>
<th>Schedule Type</th>
<th>Formula</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Linear</strong></td>
<td><span class="arithmatex">\( \beta_t = \left( \sqrt{\text{start}} + \frac{t}{T} \left( \sqrt{\text{end}} - \sqrt{\text{start}} \right) \right)^2 \)</span></td>
<td><strong>Standard DDPM, suitable for most tasks</strong></td>
</tr>
<tr>
<td><strong>Cosine</strong></td>
<td><span class="arithmatex">\( \alpha_t = \cos^2 \left( \frac{t/T + s}{1 + s} \cdot \frac{\pi}{2} \right) \)</span></td>
<td><strong>Stable Diffusion, improves image quality</strong></td>
</tr>
<tr>
<td><strong>Sqrt Linear</strong></td>
<td><span class="arithmatex">\( \beta_t = \text{start} + \frac{t}{T} \left( \text{end} - \text{start} \right) \)</span></td>
<td><strong>Used for denoising tasks</strong></td>
</tr>
<tr>
<td><strong>Sqrt</strong></td>
<td><span class="arithmatex">\( \beta_t = \left( \text{start} + \frac{t}{T} \left( \text{end} - \text{start} \right) \right)^{0.5} \)</span></td>
<td><strong>Smooth increase, useful for video tasks</strong></td>
</tr>
</tbody>
</table>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../images/image-48.png" data-desc-position="bottom"><img alt="addd" src="../../../images/image-48.png"></a></p>
<p>The choice of schedule impacts <strong>model convergence, image quality, and noise control</strong>. <strong>Experiments</strong> are often necessary to determine the most suitable <span class="arithmatex">\(\beta_t\)</span> scheduling method.</p>
<p>And calculated the posterior distribution</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="n">posterior_variance</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_posterior</span><span class="p">)</span> <span class="o">*</span> <span class="n">betas</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod_prev</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>                <span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_posterior</span> <span class="o">*</span> <span class="n">betas</span>
</code></pre></div></td></tr></tbody></table></div>
<p>Here <code>posterior_variance</code> is <span class="arithmatex">\(\sigma_t^2\)</span></p>
<p>Mean parameters</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'posterior_mean_coef1'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>    <span class="n">betas</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alphas_cumprod_prev</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="p">)))</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'posterior_mean_coef2'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a>    <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod_prev</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="p">)))</span>
</code></pre></div></td></tr></tbody></table></div>
<p>Which is the two coes of the <span class="arithmatex">\(\mu_t\)</span></p>
<h5 id="3213-training-step">3.2.1.3 training step<a class="headerlink" href="#3213-training-step" title="Permanent link"></a></h5>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span>
<span class="normal"><a href="#__codelineno-19-35">35</a></span>
<span class="normal"><a href="#__codelineno-19-36">36</a></span>
<span class="normal"><a href="#__codelineno-19-37">37</a></span>
<span class="normal"><a href="#__codelineno-19-38">38</a></span>
<span class="normal"><a href="#__codelineno-19-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">q_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_start</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a>    <span class="n">noise</span> <span class="o">=</span> <span class="n">default</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">x_start</span><span class="p">))</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">extract_into_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqrt_alphas_cumprod</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_start</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_start</span> <span class="o">+</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a>                <span class="n">extract_into_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqrt_one_minus_alphas_cumprod</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_start</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise</span><span class="p">)</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a>    <span class="c1"># input image shape is: [b, c, h, w]</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a>    <span class="c1"># random pick a time step t, as the argument of the model</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_losses</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">p_losses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_start</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a>    <span class="n">noise</span> <span class="o">=</span> <span class="n">default</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">x_start</span><span class="p">))</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a>    <span class="n">x_noisy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_sample</span><span class="p">(</span><span class="n">x_start</span><span class="o">=</span><span class="n">x_start</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a>    <span class="n">model_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x_noisy</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a>    <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">==</span> <span class="s2">"eps"</span><span class="p">:</span>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">noise</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">==</span> <span class="s2">"x0"</span><span class="p">:</span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">x_start</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Paramterization </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span><span class="si">}</span><span class="s2"> not yet supported"</span><span class="p">)</span>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loss</span><span class="p">(</span><span class="n">model_out</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a>    <span class="n">log_prefix</span> <span class="o">=</span> <span class="s1">'train'</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">else</span> <span class="s1">'val'</span>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a>    <span class="n">loss_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">log_prefix</span><span class="si">}</span><span class="s1">/loss_simple'</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()})</span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a>    <span class="n">loss_simple</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_simple_weight</span>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a>
<a id="__codelineno-19-32" name="__codelineno-19-32"></a>    <span class="n">loss_vlb</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lvlb_weights</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-19-33" name="__codelineno-19-33"></a>    <span class="n">loss_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">log_prefix</span><span class="si">}</span><span class="s1">/loss_vlb'</span><span class="p">:</span> <span class="n">loss_vlb</span><span class="p">})</span>
<a id="__codelineno-19-34" name="__codelineno-19-34"></a>
<a id="__codelineno-19-35" name="__codelineno-19-35"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_simple</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_elbo_weight</span> <span class="o">*</span> <span class="n">loss_vlb</span>
<a id="__codelineno-19-36" name="__codelineno-19-36"></a>
<a id="__codelineno-19-37" name="__codelineno-19-37"></a>    <span class="n">loss_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">log_prefix</span><span class="si">}</span><span class="s1">/loss'</span><span class="p">:</span> <span class="n">loss</span><span class="p">})</span>
<a id="__codelineno-19-38" name="__codelineno-19-38"></a>
<a id="__codelineno-19-39" name="__codelineno-19-39"></a>    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">loss_dict</span>
</code></pre></div></td></tr></tbody></table></div>
<p>Let's recall the forward process of ddpm</p>
<div class="arithmatex">\[
x_t = \sqrt{1-\beta_t}\, x_{t-1} + \sqrt{\beta_t}\, \epsilon_t,\quad \epsilon_t \sim \mathcal{N}(0,I)
\]</div>
<p><span class="arithmatex">\(x_0\)</span> is the noiseless image. The diffusion process (adding noise) is definedin the <code>q_sample</code> method, which is exactly</p>
<p> DDPMDenoising Diffusion Probabilistic Modelsforward diffusion process</p>
<div class="arithmatex">\[
x_t = \sqrt{1-\beta_t}\, x_{t-1} + \sqrt{\beta_t}\, \epsilon_t,\quad \epsilon_t \sim \mathcal{N}(0,I)
\]</div>
<p>with</p>
<div class="arithmatex">\[
\bar{\alpha}_t = \prod_{s=1}^{t} (1-\beta_s)
\]</div>
<p>Theoretically,</p>
<div class="arithmatex">\[
x_t = \sqrt{\bar{\alpha}_t}\, x_0 + \sqrt{1-\bar{\alpha}_t}\, \epsilon
\]</div>
<p>And in the code  <code>q_sample</code>,</p>
<ul>
<li><code>self.sqrt_alphas_cumprod</code> <span class="arithmatex">\(\leftrightarrow\)</span> <span class="arithmatex">\(\sqrt{\bar{\alpha}_t}\)</span> (product of square root of <span class="arithmatex">\(\prod_{s=1}^{t} (1-\beta_s)\)</span></li>
<li><code>self.sqrt_one_minus_alphas_cumprod</code> <span class="arithmatex">\(\leftrightarrow\)</span> <span class="arithmatex">\(\sqrt{1-\bar{\alpha}_t}\)</span></li>
</ul>
<p>There are two types of target, one is <code>x_0</code>, one is <code>eps</code>, corresponds to the noiseless image and the noise. We usually used the noise prediction. The loss is then used <span class="arithmatex">\(L_1\)</span> or <span class="arithmatex">\(L_2\)</span>.</p>
<p>The loss typically is quite simple, but it gots another re-weighted copy which is</p>
<p>This code snippet is part of the loss computation in a diffusion model when the model is parameterized to predict the noise (often referred to as "eps" parameterization). Heres what it does:
weights help balance the contribution of each term.</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="o">...</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">==</span> <span class="s2">"eps"</span><span class="p">:</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a>    <span class="n">lvlb_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">betas</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a>        <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior_variance</span> <span class="o">*</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_cumprod</span><span class="p">))</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="err"></span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">p_losses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_start</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a>    <span class="o">...</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a>    <span class="n">loss_vlb</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lvlb_weights</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a>    <span class="n">loss_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">log_prefix</span><span class="si">}</span><span class="s1">/loss_vlb'</span><span class="p">:</span> <span class="n">loss_vlb</span><span class="p">})</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a>    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_simple</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_elbo_weight</span> <span class="o">*</span> <span class="n">loss_vlb</span>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a>    <span class="o">...</span>
</code></pre></div></td></tr></tbody></table></div>
<p><strong>Accounting for the Noise Schedule and Posterior Variance:</strong></p>
<ul>
<li><code>self.betas</code> represents the noise schedule parameters at each timestep.</li>
<li><code>self.posterior_variance</code> is the variance of the reverse (posterior) process <span class="arithmatex">\( q(x_{t-1}\mid x_t, x_0) \)</span>.</li>
<li><code>alphas</code> (converted to a torch tensor) and <code>self.alphas_cumprod</code> (the cumulative product of <span class="arithmatex">\( 1-\beta_t \)</span>) are used to capture how the signal decays over time.</li>
</ul>
<p>The formula</p>
<p>$$
   \text{lvlb_weights} = \frac{\beta_t^2}{2 \cdot \text{posterior_variance} \cdot \alpha_t \cdot (1 - \text{alphas_cumprod}_t)}
   $$
   adjusts the loss term based on these factors, ensuring that the loss is appropriately scaled at each timestep.</p>
<p><strong>Usage in the Loss Function:</strong>
   When the model predicts <span class="arithmatex">\(\epsilon\)</span> (the noise added to <span class="arithmatex">\( x_0 \)</span>), the training loss often reduces to a weighted mean squared error (MSE) between the predicted and actual noise. The <code>lvlb_weights</code> are used to weight this error term, so that the models learning objective better approximates the true variational lower bound of the data likelihood.
We can visualize the curve of te weights according to <span class="arithmatex">\(t\)</span>, to see whether weights are focused on.</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../images/image-49.png" data-desc-position="bottom"><img alt="alt text" src="../../../images/image-49.png"></a></p>
<p>This seems that the weights are more focused on the <span class="arithmatex">\(t\)</span> close to zero, which means the model focus more on the denosing steps that is close to the noiseless images.</p>
<p>So far, we have understand the ddpm process. Let's go further on the latent ddpm process</p>
<h4 id="322-sampling">3.2.2 Sampling<a class="headerlink" href="#322-sampling" title="Permanent link"></a></h4>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span>
<span class="normal"><a href="#__codelineno-21-19">19</a></span>
<span class="normal"><a href="#__codelineno-21-20">20</a></span>
<span class="normal"><a href="#__codelineno-21-21">21</a></span>
<span class="normal"><a href="#__codelineno-21-22">22</a></span>
<span class="normal"><a href="#__codelineno-21-23">23</a></span>
<span class="normal"><a href="#__codelineno-21-24">24</a></span>
<span class="normal"><a href="#__codelineno-21-25">25</a></span>
<span class="normal"><a href="#__codelineno-21-26">26</a></span>
<span class="normal"><a href="#__codelineno-21-27">27</a></span>
<span class="normal"><a href="#__codelineno-21-28">28</a></span>
<span class="normal"><a href="#__codelineno-21-29">29</a></span>
<span class="normal"><a href="#__codelineno-21-30">30</a></span>
<span class="normal"><a href="#__codelineno-21-31">31</a></span>
<span class="normal"><a href="#__codelineno-21-32">32</a></span>
<span class="normal"><a href="#__codelineno-21-33">33</a></span>
<span class="normal"><a href="#__codelineno-21-34">34</a></span>
<span class="normal"><a href="#__codelineno-21-35">35</a></span>
<span class="normal"><a href="#__codelineno-21-36">36</a></span>
<span class="normal"><a href="#__codelineno-21-37">37</a></span>
<span class="normal"><a href="#__codelineno-21-38">38</a></span>
<span class="normal"><a href="#__codelineno-21-39">39</a></span>
<span class="normal"><a href="#__codelineno-21-40">40</a></span>
<span class="normal"><a href="#__codelineno-21-41">41</a></span>
<span class="normal"><a href="#__codelineno-21-42">42</a></span>
<span class="normal"><a href="#__codelineno-21-43">43</a></span>
<span class="normal"><a href="#__codelineno-21-44">44</a></span>
<span class="normal"><a href="#__codelineno-21-45">45</a></span>
<span class="normal"><a href="#__codelineno-21-46">46</a></span>
<span class="normal"><a href="#__codelineno-21-47">47</a></span>
<span class="normal"><a href="#__codelineno-21-48">48</a></span>
<span class="normal"><a href="#__codelineno-21-49">49</a></span>
<span class="normal"><a href="#__codelineno-21-50">50</a></span>
<span class="normal"><a href="#__codelineno-21-51">51</a></span>
<span class="normal"><a href="#__codelineno-21-52">52</a></span>
<span class="normal"><a href="#__codelineno-21-53">53</a></span>
<span class="normal"><a href="#__codelineno-21-54">54</a></span>
<span class="normal"><a href="#__codelineno-21-55">55</a></span>
<span class="normal"><a href="#__codelineno-21-56">56</a></span>
<span class="normal"><a href="#__codelineno-21-57">57</a></span>
<span class="normal"><a href="#__codelineno-21-58">58</a></span>
<span class="normal"><a href="#__codelineno-21-59">59</a></span>
<span class="normal"><a href="#__codelineno-21-60">60</a></span>
<span class="normal"><a href="#__codelineno-21-61">61</a></span>
<span class="normal"><a href="#__codelineno-21-62">62</a></span>
<span class="normal"><a href="#__codelineno-21-63">63</a></span>
<span class="normal"><a href="#__codelineno-21-64">64</a></span>
<span class="normal"><a href="#__codelineno-21-65">65</a></span>
<span class="normal"><a href="#__codelineno-21-66">66</a></span>
<span class="normal"><a href="#__codelineno-21-67">67</a></span>
<span class="normal"><a href="#__codelineno-21-68">68</a></span>
<span class="normal"><a href="#__codelineno-21-69">69</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">q_mean_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_start</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">        </span><span class="sd">"""</span>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="sd">        Get the distribution q(x_t | x_0).</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="sd">        :param x_start: the [N x C x ...] tensor of noiseless inputs.</span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="sd">        :param t: the number of diffusion steps (minus 1). Here, 0 means one step.</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="sd">        :return: A tuple (mean, variance, log_variance), all of x_start's shape.</span>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="sd">        """</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">extract_into_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqrt_alphas_cumprod</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_start</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_start</span><span class="p">)</span>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a>        <span class="n">variance</span> <span class="o">=</span> <span class="n">extract_into_tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_cumprod</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_start</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a>        <span class="n">log_variance</span> <span class="o">=</span> <span class="n">extract_into_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_one_minus_alphas_cumprod</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_start</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a>        <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">log_variance</span>
<a id="__codelineno-21-12" name="__codelineno-21-12"></a>
<a id="__codelineno-21-13" name="__codelineno-21-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict_start_from_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">noise</span><span class="p">):</span>
<a id="__codelineno-21-14" name="__codelineno-21-14"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-21-15" name="__codelineno-21-15"></a>                <span class="n">extract_into_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqrt_recip_alphas_cumprod</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_t</span> <span class="o">-</span>
<a id="__codelineno-21-16" name="__codelineno-21-16"></a>                <span class="n">extract_into_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqrt_recipm1_alphas_cumprod</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise</span>
<a id="__codelineno-21-17" name="__codelineno-21-17"></a>        <span class="p">)</span>
<a id="__codelineno-21-18" name="__codelineno-21-18"></a>
<a id="__codelineno-21-19" name="__codelineno-21-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">q_posterior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_start</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<a id="__codelineno-21-20" name="__codelineno-21-20"></a>        <span class="n">posterior_mean</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-21-21" name="__codelineno-21-21"></a>                <span class="n">extract_into_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior_mean_coef1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_start</span> <span class="o">+</span>
<a id="__codelineno-21-22" name="__codelineno-21-22"></a>                <span class="n">extract_into_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior_mean_coef2</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_t</span>
<a id="__codelineno-21-23" name="__codelineno-21-23"></a>        <span class="p">)</span>
<a id="__codelineno-21-24" name="__codelineno-21-24"></a>        <span class="n">posterior_variance</span> <span class="o">=</span> <span class="n">extract_into_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior_variance</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-21-25" name="__codelineno-21-25"></a>        <span class="n">posterior_log_variance_clipped</span> <span class="o">=</span> <span class="n">extract_into_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">posterior_log_variance_clipped</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<a id="__codelineno-21-26" name="__codelineno-21-26"></a>        <span class="k">return</span> <span class="n">posterior_mean</span><span class="p">,</span> <span class="n">posterior_variance</span><span class="p">,</span> <span class="n">posterior_log_variance_clipped</span>
<a id="__codelineno-21-27" name="__codelineno-21-27"></a>
<a id="__codelineno-21-28" name="__codelineno-21-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">p_mean_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clip_denoised</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<a id="__codelineno-21-29" name="__codelineno-21-29"></a>        <span class="n">model_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<a id="__codelineno-21-30" name="__codelineno-21-30"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">==</span> <span class="s2">"eps"</span><span class="p">:</span>
<a id="__codelineno-21-31" name="__codelineno-21-31"></a>            <span class="n">x_recon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_start_from_noise</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">model_out</span><span class="p">)</span>
<a id="__codelineno-21-32" name="__codelineno-21-32"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">==</span> <span class="s2">"x0"</span><span class="p">:</span>
<a id="__codelineno-21-33" name="__codelineno-21-33"></a>            <span class="n">x_recon</span> <span class="o">=</span> <span class="n">model_out</span>
<a id="__codelineno-21-34" name="__codelineno-21-34"></a>        <span class="k">if</span> <span class="n">clip_denoised</span><span class="p">:</span>
<a id="__codelineno-21-35" name="__codelineno-21-35"></a>            <span class="n">x_recon</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<a id="__codelineno-21-36" name="__codelineno-21-36"></a>
<a id="__codelineno-21-37" name="__codelineno-21-37"></a>        <span class="n">model_mean</span><span class="p">,</span> <span class="n">posterior_variance</span><span class="p">,</span> <span class="n">posterior_log_variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_posterior</span><span class="p">(</span><span class="n">x_start</span><span class="o">=</span><span class="n">x_recon</span><span class="p">,</span> <span class="n">x_t</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
<a id="__codelineno-21-38" name="__codelineno-21-38"></a>        <span class="k">return</span> <span class="n">model_mean</span><span class="p">,</span> <span class="n">posterior_variance</span><span class="p">,</span> <span class="n">posterior_log_variance</span>
<a id="__codelineno-21-39" name="__codelineno-21-39"></a>
<a id="__codelineno-21-40" name="__codelineno-21-40"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-21-41" name="__codelineno-21-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">p_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">clip_denoised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">repeat_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-21-42" name="__codelineno-21-42"></a>        <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-21-43" name="__codelineno-21-43"></a>        <span class="n">model_mean</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">model_log_variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_mean_variance</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">clip_denoised</span><span class="o">=</span><span class="n">clip_denoised</span><span class="p">)</span>
<a id="__codelineno-21-44" name="__codelineno-21-44"></a>        <span class="n">noise</span> <span class="o">=</span> <span class="n">noise_like</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">repeat_noise</span><span class="p">)</span>
<a id="__codelineno-21-45" name="__codelineno-21-45"></a>        <span class="c1"># no noise when t == 0</span>
<a id="__codelineno-21-46" name="__codelineno-21-46"></a>        <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-21-47" name="__codelineno-21-47"></a>        <span class="k">return</span> <span class="n">model_mean</span> <span class="o">+</span> <span class="n">nonzero_mask</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">model_log_variance</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">*</span> <span class="n">noise</span>
<a id="__codelineno-21-48" name="__codelineno-21-48"></a>
<a id="__codelineno-21-49" name="__codelineno-21-49"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-21-50" name="__codelineno-21-50"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">p_sample_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">return_intermediates</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-21-51" name="__codelineno-21-51"></a>        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">betas</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-21-52" name="__codelineno-21-52"></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-21-53" name="__codelineno-21-53"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-21-54" name="__codelineno-21-54"></a>        <span class="n">intermediates</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span><span class="p">]</span>
<a id="__codelineno-21-55" name="__codelineno-21-55"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">'Sampling t'</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">):</span>
<a id="__codelineno-21-56" name="__codelineno-21-56"></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_sample</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b</span><span class="p">,),</span> <span class="n">i</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
<a id="__codelineno-21-57" name="__codelineno-21-57"></a>                                <span class="n">clip_denoised</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_denoised</span><span class="p">)</span>
<a id="__codelineno-21-58" name="__codelineno-21-58"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_every_t</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-21-59" name="__codelineno-21-59"></a>                <span class="n">intermediates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-21-60" name="__codelineno-21-60"></a>        <span class="k">if</span> <span class="n">return_intermediates</span><span class="p">:</span>
<a id="__codelineno-21-61" name="__codelineno-21-61"></a>            <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">intermediates</span>
<a id="__codelineno-21-62" name="__codelineno-21-62"></a>        <span class="k">return</span> <span class="n">img</span>
<a id="__codelineno-21-63" name="__codelineno-21-63"></a>
<a id="__codelineno-21-64" name="__codelineno-21-64"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-21-65" name="__codelineno-21-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">return_intermediates</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-21-66" name="__codelineno-21-66"></a>        <span class="n">image_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span>
<a id="__codelineno-21-67" name="__codelineno-21-67"></a>        <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span>
<a id="__codelineno-21-68" name="__codelineno-21-68"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_sample_loop</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">),</span>
<a id="__codelineno-21-69" name="__codelineno-21-69"></a>                                  <span class="n">return_intermediates</span><span class="o">=</span><span class="n">return_intermediates</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p>We give the following explanation for the DDPM sampling steps and corresponds it to the original DDPM reverse process</p>
<ul>
<li><strong><span class="arithmatex">\(x_0\)</span> Estimation:</strong>
  $$
  x_0 = \frac{1}{\sqrt{\bar{\alpha}_t}}\, x_t - \sqrt{\frac{1}{\bar{\alpha}_t} - 1}\, \epsilon
  $$</li>
</ul>
<p> <code>predict_start_from_noise</code>
  (Coefficients: <code>sqrt_recip_alphas_cumprod</code> and <code>sqrt_recipm1_alphas_cumprod</code>)</p>
<ul>
<li>
<p><strong>Posterior Mean Calculation:</strong>
  $$
  \mu_{\text{posterior}}(x_t, x_0) = \frac{\sqrt{\bar{\alpha}<em t-1="t-1">{t-1}}\, \beta_t}{1-\bar{\alpha}_t}\, x_0 + \frac{\sqrt{\alpha_t}\,(1-\bar{\alpha}</em>\, x_t
  $$
   })}{1-\bar{\alpha}_t<code>q_posterior</code>
  (Coefficients: <code>posterior_mean_coef1</code> and <code>posterior_mean_coef2</code>)</p>
</li>
<li>
<p><strong>Reverse Process Sampling:</strong>
  $$
  x_{t-1} = \mu_\theta(x_t,t) + \sigma_t\, z,\quad z \sim \mathcal{N}(0,I)
  $$</p>
</li>
</ul>
<p> <code>p_sample</code>
  (Mean from <code>p_mean_variance</code> and variance computed via</p>
<p>$<span class="arithmatex">\(e^{0.5 \times \text{model-log-variance}}\)</span>$</p>
<ul>
<li><strong>Forward Process Sampling:</strong>
  $$
  x_t = \sqrt{\bar{\alpha}_t}\, x_0 + \sqrt{1-\bar{\alpha}_t}\, \epsilon
  $$
   <code>q_sample</code>
  (Coefficients: <code>sqrt_alphas_cumprod</code> and <code>sqrt_one_minus_alphas_cumprod</code>)</li>
</ul>
<p>Need to mention that, every time, it predicted a <span class="arithmatex">\(x_0\)</span> and then calculate <span class="arithmatex">\(x_{t-1}\)</span> according to the forward process.</p>
<h3 id="33-latent-dm">3.3 Latent DM<a class="headerlink" href="#33-latent-dm" title="Permanent link"></a></h3>
<p>In this section, we can just compare the differences between the LDM ad DDPM.</p>
<p>First, in the init stage, it has extra</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instantiate_first_stage</span><span class="p">(</span><span class="n">first_stage_config</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<p>to initialize the auto encoder which map the original image to the latent space.</p>
<p>In summary, the loss are exactly the same as that of DDPM. The differences comes from the forward step, which</p>
<p>If do not considet the condition, the main difference is</p>
<p>The LDM will first convert image to latent space by the pretrained VAE</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span>
<span class="normal"><a href="#__codelineno-23-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="n">encoder_posterior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_first_stage</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_first_stage_encoding</span><span class="p">(</span><span class="n">encoder_posterior</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</code></pre></div></td></tr></tbody></table></div>
<p>All the rest is same.</p>
<p>The codes got a lot of lines dealing with the conditioning including <code>get_input</code>, <code>apply_model</code></p>
<h4 id="331-conditional-latent-dm">3.3.1 Conditional Latent DM<a class="headerlink" href="#331-conditional-latent-dm" title="Permanent link"></a></h4>
<p>Next, we focus on how the latent DM put the condition into the network. The training is not guided on the conditioning, it just puts the condition information into the betwork for conditional generation in a implicite architecture.</p>
<p>The diffusion model accepts three different types of conditions</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><th colspan="2" class="filename"><span class="filename">DiffusionWrapper</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span>
<span class="normal"><a href="#__codelineno-24-15">15</a></span>
<span class="normal"><a href="#__codelineno-24-16">16</a></span>
<span class="normal"><a href="#__codelineno-24-17">17</a></span>
<span class="normal"><a href="#__codelineno-24-18">18</a></span>
<span class="normal"><a href="#__codelineno-24-19">19</a></span>
<span class="normal"><a href="#__codelineno-24-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c_concat</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c_crossattn</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditioning_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a>            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffusion_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditioning_key</span> <span class="o">==</span> <span class="s1">'concat'</span><span class="p">:</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a>            <span class="n">xc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">c_concat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a>            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffusion_model</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditioning_key</span> <span class="o">==</span> <span class="s1">'crossattn'</span><span class="p">:</span>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a>            <span class="n">cc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">c_crossattn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a>            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffusion_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">cc</span><span class="p">)</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditioning_key</span> <span class="o">==</span> <span class="s1">'hybrid'</span><span class="p">:</span>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a>            <span class="n">xc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">c_concat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-12" name="__codelineno-24-12"></a>            <span class="n">cc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">c_crossattn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-24-13" name="__codelineno-24-13"></a>            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffusion_model</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">cc</span><span class="p">)</span>
<a id="__codelineno-24-14" name="__codelineno-24-14"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditioning_key</span> <span class="o">==</span> <span class="s1">'adm'</span><span class="p">:</span>
<a id="__codelineno-24-15" name="__codelineno-24-15"></a>            <span class="n">cc</span> <span class="o">=</span> <span class="n">c_crossattn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-24-16" name="__codelineno-24-16"></a>            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffusion_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">cc</span><span class="p">)</span>
<a id="__codelineno-24-17" name="__codelineno-24-17"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-24-18" name="__codelineno-24-18"></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
<a id="__codelineno-24-19" name="__codelineno-24-19"></a>
<a id="__codelineno-24-20" name="__codelineno-24-20"></a>        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></tbody></table></div>
<p>The conditioning_key have "hybrid", "concat", "crossattn", "adm" types.</p>
<ul>
<li>Concat
  In the "Concat" format, the condition information is concated in to the original input, which require the same shape with the input <span class="arithmatex">\(x\)</span>. It can handles the conditions like</li>
<li>segmentation map</li>
<li>edge map</li>
<li>depthmap</li>
<li>
<p>any spacial condition with the same shape</p>
</li>
<li>
<p>CrossAttention
    In this type, the condition should be a sequence of shape [B,L,D]. Which usually handles for conditions</p>
</li>
<li>texts (ex. from the clip model)</li>
<li>class embeddings</li>
<li>
<p>any conditions in sequence format</p>
<p>These infomation will be fed into the attention block in the UNet via cross attention</p>
</li>
<li>
<p>ADM
    The condition shape if of [B,D] which is a single token embedding. Can handle conditions like
    The information will be assigned to class label <span class="arithmatex">\(y\)</span>.
    In the network, the class label condition is added into the time step condition</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span>
<span class="normal"><a href="#__codelineno-25-3">3</a></span>
<span class="normal"><a href="#__codelineno-25-4">4</a></span>
<span class="normal"><a href="#__codelineno-25-5">5</a></span>
<span class="normal"><a href="#__codelineno-25-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a>        <span class="n">t_emb</span> <span class="o">=</span> <span class="n">timestep_embedding</span><span class="p">(</span><span class="n">timesteps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_channels</span><span class="p">,</span> <span class="n">repeat_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>    <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_embed</span><span class="p">(</span><span class="n">t_emb</span><span class="p">)</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a>        <span class="k">assert</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a>        <span class="n">emb</span> <span class="o">=</span> <span class="n">emb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_emb</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
</li>
<li>
<p>classfier guided generation</p>
</li>
<li>Hybrid
    Which combines different types of conditions together</li>
</ul>
<h4 id="332-sampling-with-ddpm-class">3.3.2 Sampling with DDPM class<a class="headerlink" href="#332-sampling-with-ddpm-class" title="Permanent link"></a></h4>
<p>This is exactly the same as that of DDPM sampling except with handling with different conditions</p>
<h3 id="34-unet">3.4 UNet<a class="headerlink" href="#34-unet" title="Permanent link"></a></h3>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio"><input id="__tabbed_1_2" name="__tabbed_1" type="radio"><input id="__tabbed_1_3" name="__tabbed_1" type="radio"><div class="tabbed-labels"><label for="__tabbed_1_1">SpatialTransformer</label><label for="__tabbed_1_2">Basic Transfomer Block</label><label for="__tabbed_1_3">Cross Attention</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span>
<span class="normal"><a href="#__codelineno-26-15">15</a></span>
<span class="normal"><a href="#__codelineno-26-16">16</a></span>
<span class="normal"><a href="#__codelineno-26-17">17</a></span>
<span class="normal"><a href="#__codelineno-26-18">18</a></span>
<span class="normal"><a href="#__codelineno-26-19">19</a></span>
<span class="normal"><a href="#__codelineno-26-20">20</a></span>
<span class="normal"><a href="#__codelineno-26-21">21</a></span>
<span class="normal"><a href="#__codelineno-26-22">22</a></span>
<span class="normal"><a href="#__codelineno-26-23">23</a></span>
<span class="normal"><a href="#__codelineno-26-24">24</a></span>
<span class="normal"><a href="#__codelineno-26-25">25</a></span>
<span class="normal"><a href="#__codelineno-26-26">26</a></span>
<span class="normal"><a href="#__codelineno-26-27">27</a></span>
<span class="normal"><a href="#__codelineno-26-28">28</a></span>
<span class="normal"><a href="#__codelineno-26-29">29</a></span>
<span class="normal"><a href="#__codelineno-26-30">30</a></span>
<span class="normal"><a href="#__codelineno-26-31">31</a></span>
<span class="normal"><a href="#__codelineno-26-32">32</a></span>
<span class="normal"><a href="#__codelineno-26-33">33</a></span>
<span class="normal"><a href="#__codelineno-26-34">34</a></span>
<span class="normal"><a href="#__codelineno-26-35">35</a></span>
<span class="normal"><a href="#__codelineno-26-36">36</a></span>
<span class="normal"><a href="#__codelineno-26-37">37</a></span>
<span class="normal"><a href="#__codelineno-26-38">38</a></span>
<span class="normal"><a href="#__codelineno-26-39">39</a></span>
<span class="normal"><a href="#__codelineno-26-40">40</a></span>
<span class="normal"><a href="#__codelineno-26-41">41</a></span>
<span class="normal"><a href="#__codelineno-26-42">42</a></span>
<span class="normal"><a href="#__codelineno-26-43">43</a></span>
<span class="normal"><a href="#__codelineno-26-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a>Input<span class="w"> </span>x<span class="w"> </span><span class="o">[</span>B,<span class="w"> </span>C,<span class="w"> </span>H,<span class="w"> </span>W<span class="o">]</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">    </span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">    </span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a>LayerNorm<span class="w"> </span><span class="o">(</span>self.norm<span class="o">)</span><span class="w">     </span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a>Projection<span class="w"> </span><span class="o">(</span>self.proj_in<span class="o">)</span><span class="w"> </span>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="o">[</span>B,<span class="w"> </span>C<span class="s1">', H, W]             </span>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="s1">                         </span>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="s1">                         </span>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="s1">Reshape (rearrange)       </span>
<a id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="s1">[B, (HW), C'</span><span class="o">]</span><span class="w">            </span>
<a id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="w">       </span>
<a id="__codelineno-26-18" name="__codelineno-26-18"></a>Transformer<span class="w"> </span>Block<span class="w">       </span>
<a id="__codelineno-26-19" name="__codelineno-26-19"></a><span class="w">  </span><span class="w">   </span><span class="w">       </span>
<a id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="w">  </span>Self-Attn<span class="w">    </span><span class="w">       </span>
<a id="__codelineno-26-21" name="__codelineno-26-21"></a><span class="w">  </span><span class="w">   </span><span class="w">       </span>
<a id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="w">      </span><span class="w">          </span><span class="w">       </span>
<a id="__codelineno-26-23" name="__codelineno-26-23"></a><span class="w">  </span><span class="w">   </span><span class="w">       </span>
<a id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="w">  </span>Cross-Attcontext
<a id="__codelineno-26-25" name="__codelineno-26-25"></a><span class="w">  </span><span class="w">   </span><span class="w">       </span>
<a id="__codelineno-26-26" name="__codelineno-26-26"></a><span class="w">      </span><span class="w">          </span><span class="w">       </span>
<a id="__codelineno-26-27" name="__codelineno-26-27"></a><span class="w">  </span><span class="w">   </span><span class="w">       </span>
<a id="__codelineno-26-28" name="__codelineno-26-28"></a><span class="w">  </span><span class="w">   </span>FF<span class="w">    </span><span class="w">    </span><span class="w">       </span>
<a id="__codelineno-26-29" name="__codelineno-26-29"></a><span class="w">  </span><span class="w">   </span><span class="w">       </span>
<a id="__codelineno-26-30" name="__codelineno-26-30"></a><span class="w">       </span>
<a id="__codelineno-26-31" name="__codelineno-26-31"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-32" name="__codelineno-26-32"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-33" name="__codelineno-26-33"></a>Reshape<span class="w"> </span><span class="o">(</span>rearrange<span class="o">)</span><span class="w">       </span>
<a id="__codelineno-26-34" name="__codelineno-26-34"></a><span class="o">[</span>B,<span class="w"> </span>C<span class="err">'</span>,<span class="w"> </span>H,<span class="w"> </span>W<span class="o">]</span><span class="w">             </span>
<a id="__codelineno-26-35" name="__codelineno-26-35"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-36" name="__codelineno-26-36"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-37" name="__codelineno-26-37"></a>Projection<span class="w"> </span><span class="o">(</span>self.proj_out<span class="o">)</span>
<a id="__codelineno-26-38" name="__codelineno-26-38"></a><span class="o">[</span>B,<span class="w"> </span>C,<span class="w"> </span>H,<span class="w"> </span>W<span class="o">]</span><span class="w">              </span>
<a id="__codelineno-26-39" name="__codelineno-26-39"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-40" name="__codelineno-26-40"></a><span class="w">    </span><span class="w">                     </span>
<a id="__codelineno-26-41" name="__codelineno-26-41"></a><span class="w">    </span>+
<a id="__codelineno-26-42" name="__codelineno-26-42"></a><span class="w">    </span>
<a id="__codelineno-26-43" name="__codelineno-26-43"></a>Output
<a id="__codelineno-26-44" name="__codelineno-26-44"></a><span class="o">[</span>B,<span class="w"> </span>C,<span class="w"> </span>H,<span class="w"> </span>W<span class="o">]</span>
</code></pre></div></td></tr></tbody></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span>
<span class="normal"><a href="#__codelineno-27-24">24</a></span>
<span class="normal"><a href="#__codelineno-27-25">25</a></span>
<span class="normal"><a href="#__codelineno-27-26">26</a></span>
<span class="normal"><a href="#__codelineno-27-27">27</a></span>
<span class="normal"><a href="#__codelineno-27-28">28</a></span>
<span class="normal"><a href="#__codelineno-27-29">29</a></span>
<span class="normal"><a href="#__codelineno-27-30">30</a></span>
<span class="normal"><a href="#__codelineno-27-31">31</a></span>
<span class="normal"><a href="#__codelineno-27-32">32</a></span>
<span class="normal"><a href="#__codelineno-27-33">33</a></span>
<span class="normal"><a href="#__codelineno-27-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a>Input x
<a id="__codelineno-27-2" name="__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>             
<a id="__codelineno-27-5" name="__codelineno-27-5"></a>LayerNorm1    
<a id="__codelineno-27-6" name="__codelineno-27-6"></a>             
<a id="__codelineno-27-7" name="__codelineno-27-7"></a>             
<a id="__codelineno-27-8" name="__codelineno-27-8"></a>Self-Attention
<a id="__codelineno-27-9" name="__codelineno-27-9"></a>(attn1)       
<a id="__codelineno-27-10" name="__codelineno-27-10"></a>             
<a id="__codelineno-27-11" name="__codelineno-27-11"></a> + 
<a id="__codelineno-27-12" name="__codelineno-27-12"></a>        
<a id="__codelineno-27-13" name="__codelineno-27-13"></a>        
<a id="__codelineno-27-14" name="__codelineno-27-14"></a>                      
<a id="__codelineno-27-15" name="__codelineno-27-15"></a>    LayerNorm2         
<a id="__codelineno-27-16" name="__codelineno-27-16"></a>                      
<a id="__codelineno-27-17" name="__codelineno-27-17"></a>                      
<a id="__codelineno-27-18" name="__codelineno-27-18"></a>    Cross-Attention    
<a id="__codelineno-27-19" name="__codelineno-27-19"></a>    (attn2)            
<a id="__codelineno-27-20" name="__codelineno-27-20"></a>                      
<a id="__codelineno-27-21" name="__codelineno-27-21"></a>        + 
<a id="__codelineno-27-22" name="__codelineno-27-22"></a>                
<a id="__codelineno-27-23" name="__codelineno-27-23"></a>                
<a id="__codelineno-27-24" name="__codelineno-27-24"></a>                              
<a id="__codelineno-27-25" name="__codelineno-27-25"></a>                LayerNorm3     
<a id="__codelineno-27-26" name="__codelineno-27-26"></a>                              
<a id="__codelineno-27-27" name="__codelineno-27-27"></a>                              
<a id="__codelineno-27-28" name="__codelineno-27-28"></a>            Feed-Forward       
<a id="__codelineno-27-29" name="__codelineno-27-29"></a>                (ff)           
<a id="__codelineno-27-30" name="__codelineno-27-30"></a>                              
<a id="__codelineno-27-31" name="__codelineno-27-31"></a>                 + 
<a id="__codelineno-27-32" name="__codelineno-27-32"></a>                        
<a id="__codelineno-27-33" name="__codelineno-27-33"></a>                        
<a id="__codelineno-27-34" name="__codelineno-27-34"></a>                    Output
</code></pre></div></td></tr></tbody></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span>
<span class="normal"><a href="#__codelineno-28-16">16</a></span>
<span class="normal"><a href="#__codelineno-28-17">17</a></span>
<span class="normal"><a href="#__codelineno-28-18">18</a></span>
<span class="normal"><a href="#__codelineno-28-19">19</a></span>
<span class="normal"><a href="#__codelineno-28-20">20</a></span>
<span class="normal"><a href="#__codelineno-28-21">21</a></span>
<span class="normal"><a href="#__codelineno-28-22">22</a></span>
<span class="normal"><a href="#__codelineno-28-23">23</a></span>
<span class="normal"><a href="#__codelineno-28-24">24</a></span>
<span class="normal"><a href="#__codelineno-28-25">25</a></span>
<span class="normal"><a href="#__codelineno-28-26">26</a></span>
<span class="normal"><a href="#__codelineno-28-27">27</a></span>
<span class="normal"><a href="#__codelineno-28-28">28</a></span>
<span class="normal"><a href="#__codelineno-28-29">29</a></span>
<span class="normal"><a href="#__codelineno-28-30">30</a></span>
<span class="normal"><a href="#__codelineno-28-31">31</a></span>
<span class="normal"><a href="#__codelineno-28-32">32</a></span>
<span class="normal"><a href="#__codelineno-28-33">33</a></span>
<span class="normal"><a href="#__codelineno-28-34">34</a></span>
<span class="normal"><a href="#__codelineno-28-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a>Input x             Context
<a id="__codelineno-28-2" name="__codelineno-28-2"></a>[b, n, dim]       [b, m, dim]
<a id="__codelineno-28-3" name="__codelineno-28-3"></a>                      
<a id="__codelineno-28-4" name="__codelineno-28-4"></a>                      
<a id="__codelineno-28-5" name="__codelineno-28-5"></a>to_q Linear                       
<a id="__codelineno-28-6" name="__codelineno-28-6"></a>                 to_k Linear    to_v Linear
<a id="__codelineno-28-7" name="__codelineno-28-7"></a>                                   
<a id="__codelineno-28-8" name="__codelineno-28-8"></a>[b, n, h*d]    [b, m, h*d]    [b, m, h*d]
<a id="__codelineno-28-9" name="__codelineno-28-9"></a>                                   
<a id="__codelineno-28-10" name="__codelineno-28-10"></a>                                   
<a id="__codelineno-28-11" name="__codelineno-28-11"></a>Reshape to heads  Reshape to heads   Reshape
<a id="__codelineno-28-12" name="__codelineno-28-12"></a>[b*h, n, d]      [b*h, m, d]    [b*h, m, d]
<a id="__codelineno-28-13" name="__codelineno-28-13"></a>                                   
<a id="__codelineno-28-14" name="__codelineno-28-14"></a>                                   
<a id="__codelineno-28-15" name="__codelineno-28-15"></a>     QK^T * scale            
<a id="__codelineno-28-16" name="__codelineno-28-16"></a>        [b*h, n, m]                  
<a id="__codelineno-28-17" name="__codelineno-28-17"></a>                                    
<a id="__codelineno-28-18" name="__codelineno-28-18"></a>                                    
<a id="__codelineno-28-19" name="__codelineno-28-19"></a>        softmax(dim=-1)              
<a id="__codelineno-28-20" name="__codelineno-28-20"></a>        [b*h, n, m]                  
<a id="__codelineno-28-21" name="__codelineno-28-21"></a>                                    
<a id="__codelineno-28-22" name="__codelineno-28-22"></a>              V 
<a id="__codelineno-28-23" name="__codelineno-28-23"></a>                    
<a id="__codelineno-28-24" name="__codelineno-28-24"></a>                    
<a id="__codelineno-28-25" name="__codelineno-28-25"></a>                [b*h, n, d]
<a id="__codelineno-28-26" name="__codelineno-28-26"></a>                    
<a id="__codelineno-28-27" name="__codelineno-28-27"></a>                    
<a id="__codelineno-28-28" name="__codelineno-28-28"></a>            Reshape to batch
<a id="__codelineno-28-29" name="__codelineno-28-29"></a>            [b, n, h*d]
<a id="__codelineno-28-30" name="__codelineno-28-30"></a>                    
<a id="__codelineno-28-31" name="__codelineno-28-31"></a>                    
<a id="__codelineno-28-32" name="__codelineno-28-32"></a>            Linear Output
<a id="__codelineno-28-33" name="__codelineno-28-33"></a>                    
<a id="__codelineno-28-34" name="__codelineno-28-34"></a>                    
<a id="__codelineno-28-35" name="__codelineno-28-35"></a>            [b, n, query_dim]
</code></pre></div></td></tr></tbody></table></div>
</div>
</div>
</div>
<p>Based on the above basic block, the overall structure is
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../../images/unet.png" data-desc-position="bottom"><img alt="alt text" src="../../../images/unet.png"></a></p>
<h3 id="35-ddim-sampling">3.5 DDIM sampling<a class="headerlink" href="#35-ddim-sampling" title="Permanent link"></a></h3>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">  1</a></span>
<span class="normal"><a href="#__codelineno-29-2">  2</a></span>
<span class="normal"><a href="#__codelineno-29-3">  3</a></span>
<span class="normal"><a href="#__codelineno-29-4">  4</a></span>
<span class="normal"><a href="#__codelineno-29-5">  5</a></span>
<span class="normal"><a href="#__codelineno-29-6">  6</a></span>
<span class="normal"><a href="#__codelineno-29-7">  7</a></span>
<span class="normal"><a href="#__codelineno-29-8">  8</a></span>
<span class="normal"><a href="#__codelineno-29-9">  9</a></span>
<span class="normal"><a href="#__codelineno-29-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-29-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-29-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-29-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-29-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-29-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-29-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-29-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-29-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-29-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-29-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-29-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-29-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-29-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-29-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-29-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-29-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-29-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-29-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-29-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-29-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-29-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-29-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-29-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-29-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-29-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-29-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-29-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-29-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-29-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-29-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-29-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-29-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-29-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-29-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-29-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-29-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-29-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-29-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-29-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-29-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-29-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-29-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-29-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-29-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-29-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-29-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-29-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-29-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-29-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-29-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-29-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-29-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-29-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-29-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-29-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-29-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-29-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-29-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-29-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-29-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-29-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-29-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-29-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-29-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-29-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-29-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-29-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-29-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-29-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-29-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-29-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-29-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-29-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-29-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-29-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-29-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-29-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-29-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-29-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-29-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-29-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-29-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-29-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-29-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-29-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-29-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-29-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-29-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-29-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-29-100">100</a></span>
<span class="normal"><a href="#__codelineno-29-101">101</a></span>
<span class="normal"><a href="#__codelineno-29-102">102</a></span>
<span class="normal"><a href="#__codelineno-29-103">103</a></span>
<span class="normal"><a href="#__codelineno-29-104">104</a></span>
<span class="normal"><a href="#__codelineno-29-105">105</a></span>
<span class="normal"><a href="#__codelineno-29-106">106</a></span>
<span class="normal"><a href="#__codelineno-29-107">107</a></span>
<span class="normal"><a href="#__codelineno-29-108">108</a></span>
<span class="normal"><a href="#__codelineno-29-109">109</a></span>
<span class="normal"><a href="#__codelineno-29-110">110</a></span>
<span class="normal"><a href="#__codelineno-29-111">111</a></span>
<span class="normal"><a href="#__codelineno-29-112">112</a></span>
<span class="normal"><a href="#__codelineno-29-113">113</a></span>
<span class="normal"><a href="#__codelineno-29-114">114</a></span>
<span class="normal"><a href="#__codelineno-29-115">115</a></span>
<span class="normal"><a href="#__codelineno-29-116">116</a></span>
<span class="normal"><a href="#__codelineno-29-117">117</a></span>
<span class="normal"><a href="#__codelineno-29-118">118</a></span>
<span class="normal"><a href="#__codelineno-29-119">119</a></span>
<span class="normal"><a href="#__codelineno-29-120">120</a></span>
<span class="normal"><a href="#__codelineno-29-121">121</a></span>
<span class="normal"><a href="#__codelineno-29-122">122</a></span>
<span class="normal"><a href="#__codelineno-29-123">123</a></span>
<span class="normal"><a href="#__codelineno-29-124">124</a></span>
<span class="normal"><a href="#__codelineno-29-125">125</a></span>
<span class="normal"><a href="#__codelineno-29-126">126</a></span>
<span class="normal"><a href="#__codelineno-29-127">127</a></span>
<span class="normal"><a href="#__codelineno-29-128">128</a></span>
<span class="normal"><a href="#__codelineno-29-129">129</a></span>
<span class="normal"><a href="#__codelineno-29-130">130</a></span>
<span class="normal"><a href="#__codelineno-29-131">131</a></span>
<span class="normal"><a href="#__codelineno-29-132">132</a></span>
<span class="normal"><a href="#__codelineno-29-133">133</a></span>
<span class="normal"><a href="#__codelineno-29-134">134</a></span>
<span class="normal"><a href="#__codelineno-29-135">135</a></span>
<span class="normal"><a href="#__codelineno-29-136">136</a></span>
<span class="normal"><a href="#__codelineno-29-137">137</a></span>
<span class="normal"><a href="#__codelineno-29-138">138</a></span>
<span class="normal"><a href="#__codelineno-29-139">139</a></span>
<span class="normal"><a href="#__codelineno-29-140">140</a></span>
<span class="normal"><a href="#__codelineno-29-141">141</a></span>
<span class="normal"><a href="#__codelineno-29-142">142</a></span>
<span class="normal"><a href="#__codelineno-29-143">143</a></span>
<span class="normal"><a href="#__codelineno-29-144">144</a></span>
<span class="normal"><a href="#__codelineno-29-145">145</a></span>
<span class="normal"><a href="#__codelineno-29-146">146</a></span>
<span class="normal"><a href="#__codelineno-29-147">147</a></span>
<span class="normal"><a href="#__codelineno-29-148">148</a></span>
<span class="normal"><a href="#__codelineno-29-149">149</a></span>
<span class="normal"><a href="#__codelineno-29-150">150</a></span>
<span class="normal"><a href="#__codelineno-29-151">151</a></span>
<span class="normal"><a href="#__codelineno-29-152">152</a></span>
<span class="normal"><a href="#__codelineno-29-153">153</a></span>
<span class="normal"><a href="#__codelineno-29-154">154</a></span>
<span class="normal"><a href="#__codelineno-29-155">155</a></span>
<span class="normal"><a href="#__codelineno-29-156">156</a></span>
<span class="normal"><a href="#__codelineno-29-157">157</a></span>
<span class="normal"><a href="#__codelineno-29-158">158</a></span>
<span class="normal"><a href="#__codelineno-29-159">159</a></span>
<span class="normal"><a href="#__codelineno-29-160">160</a></span>
<span class="normal"><a href="#__codelineno-29-161">161</a></span>
<span class="normal"><a href="#__codelineno-29-162">162</a></span>
<span class="normal"><a href="#__codelineno-29-163">163</a></span>
<span class="normal"><a href="#__codelineno-29-164">164</a></span>
<span class="normal"><a href="#__codelineno-29-165">165</a></span>
<span class="normal"><a href="#__codelineno-29-166">166</a></span>
<span class="normal"><a href="#__codelineno-29-167">167</a></span>
<span class="normal"><a href="#__codelineno-29-168">168</a></span>
<span class="normal"><a href="#__codelineno-29-169">169</a></span>
<span class="normal"><a href="#__codelineno-29-170">170</a></span>
<span class="normal"><a href="#__codelineno-29-171">171</a></span>
<span class="normal"><a href="#__codelineno-29-172">172</a></span>
<span class="normal"><a href="#__codelineno-29-173">173</a></span>
<span class="normal"><a href="#__codelineno-29-174">174</a></span>
<span class="normal"><a href="#__codelineno-29-175">175</a></span>
<span class="normal"><a href="#__codelineno-29-176">176</a></span>
<span class="normal"><a href="#__codelineno-29-177">177</a></span>
<span class="normal"><a href="#__codelineno-29-178">178</a></span>
<span class="normal"><a href="#__codelineno-29-179">179</a></span>
<span class="normal"><a href="#__codelineno-29-180">180</a></span>
<span class="normal"><a href="#__codelineno-29-181">181</a></span>
<span class="normal"><a href="#__codelineno-29-182">182</a></span>
<span class="normal"><a href="#__codelineno-29-183">183</a></span>
<span class="normal"><a href="#__codelineno-29-184">184</a></span>
<span class="normal"><a href="#__codelineno-29-185">185</a></span>
<span class="normal"><a href="#__codelineno-29-186">186</a></span>
<span class="normal"><a href="#__codelineno-29-187">187</a></span>
<span class="normal"><a href="#__codelineno-29-188">188</a></span>
<span class="normal"><a href="#__codelineno-29-189">189</a></span>
<span class="normal"><a href="#__codelineno-29-190">190</a></span>
<span class="normal"><a href="#__codelineno-29-191">191</a></span>
<span class="normal"><a href="#__codelineno-29-192">192</a></span>
<span class="normal"><a href="#__codelineno-29-193">193</a></span>
<span class="normal"><a href="#__codelineno-29-194">194</a></span>
<span class="normal"><a href="#__codelineno-29-195">195</a></span>
<span class="normal"><a href="#__codelineno-29-196">196</a></span>
<span class="normal"><a href="#__codelineno-29-197">197</a></span>
<span class="normal"><a href="#__codelineno-29-198">198</a></span>
<span class="normal"><a href="#__codelineno-29-199">199</a></span>
<span class="normal"><a href="#__codelineno-29-200">200</a></span>
<span class="normal"><a href="#__codelineno-29-201">201</a></span>
<span class="normal"><a href="#__codelineno-29-202">202</a></span>
<span class="normal"><a href="#__codelineno-29-203">203</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="sd">"""SAMPLING ONLY."""</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<a id="__codelineno-29-7" name="__codelineno-29-7"></a>
<a id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ldm.modules.diffusionmodules.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_ddim_sampling_parameters</span><span class="p">,</span> <span class="n">make_ddim_timesteps</span><span class="p">,</span> <span class="n">noise_like</span>
<a id="__codelineno-29-9" name="__codelineno-29-9"></a>
<a id="__codelineno-29-10" name="__codelineno-29-10"></a>
<a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">DDIMSampler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-29-12" name="__codelineno-29-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-29-13" name="__codelineno-29-13"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-29-14" name="__codelineno-29-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
<a id="__codelineno-29-15" name="__codelineno-29-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ddpm_num_timesteps</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">num_timesteps</span>
<a id="__codelineno-29-16" name="__codelineno-29-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="n">schedule</span>
<a id="__codelineno-29-17" name="__codelineno-29-17"></a>
<a id="__codelineno-29-18" name="__codelineno-29-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
<a id="__codelineno-29-19" name="__codelineno-29-19"></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-29-20" name="__codelineno-29-20"></a>            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda"</span><span class="p">):</span>
<a id="__codelineno-29-21" name="__codelineno-29-21"></a>                <span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda"</span><span class="p">))</span>
<a id="__codelineno-29-22" name="__codelineno-29-22"></a>        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-29-23" name="__codelineno-29-23"></a>
<a id="__codelineno-29-24" name="__codelineno-29-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ddim_num_steps</span><span class="p">,</span> <span class="n">ddim_discretize</span><span class="o">=</span><span class="s2">"uniform"</span><span class="p">,</span> <span class="n">ddim_eta</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-29-25" name="__codelineno-29-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ddim_timesteps</span> <span class="o">=</span> <span class="n">make_ddim_timesteps</span><span class="p">(</span><span class="n">ddim_discr_method</span><span class="o">=</span><span class="n">ddim_discretize</span><span class="p">,</span> <span class="n">num_ddim_timesteps</span><span class="o">=</span><span class="n">ddim_num_steps</span><span class="p">,</span>
<a id="__codelineno-29-26" name="__codelineno-29-26"></a>                                                  <span class="n">num_ddpm_timesteps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddpm_num_timesteps</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-29-27" name="__codelineno-29-27"></a>        <span class="n">alphas_cumprod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">alphas_cumprod</span>
<a id="__codelineno-29-28" name="__codelineno-29-28"></a>        <span class="k">assert</span> <span class="n">alphas_cumprod</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddpm_num_timesteps</span><span class="p">,</span> <span class="s1">'alphas have to be defined for each timestep'</span>
<a id="__codelineno-29-29" name="__codelineno-29-29"></a>        <span class="n">to_torch</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-29-30" name="__codelineno-29-30"></a>
<a id="__codelineno-29-31" name="__codelineno-29-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'betas'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">betas</span><span class="p">))</span>
<a id="__codelineno-29-32" name="__codelineno-29-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">alphas_cumprod</span><span class="p">))</span>
<a id="__codelineno-29-33" name="__codelineno-29-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'alphas_cumprod_prev'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">alphas_cumprod_prev</span><span class="p">))</span>
<a id="__codelineno-29-34" name="__codelineno-29-34"></a>
<a id="__codelineno-29-35" name="__codelineno-29-35"></a>        <span class="c1"># calculations for diffusion q(x_t | x_{t-1}) and others</span>
<a id="__codelineno-29-36" name="__codelineno-29-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'sqrt_alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alphas_cumprod</span><span class="o">.</span><span class="n">cpu</span><span class="p">())))</span>
<a id="__codelineno-29-37" name="__codelineno-29-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'sqrt_one_minus_alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="o">.</span><span class="n">cpu</span><span class="p">())))</span>
<a id="__codelineno-29-38" name="__codelineno-29-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'log_one_minus_alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">alphas_cumprod</span><span class="o">.</span><span class="n">cpu</span><span class="p">())))</span>
<a id="__codelineno-29-39" name="__codelineno-29-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'sqrt_recip_alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">alphas_cumprod</span><span class="o">.</span><span class="n">cpu</span><span class="p">())))</span>
<a id="__codelineno-29-40" name="__codelineno-29-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'sqrt_recipm1_alphas_cumprod'</span><span class="p">,</span> <span class="n">to_torch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">alphas_cumprod</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-29-41" name="__codelineno-29-41"></a>
<a id="__codelineno-29-42" name="__codelineno-29-42"></a>        <span class="c1"># ddim sampling parameters</span>
<a id="__codelineno-29-43" name="__codelineno-29-43"></a>        <span class="n">ddim_sigmas</span><span class="p">,</span> <span class="n">ddim_alphas</span><span class="p">,</span> <span class="n">ddim_alphas_prev</span> <span class="o">=</span> <span class="n">make_ddim_sampling_parameters</span><span class="p">(</span><span class="n">alphacums</span><span class="o">=</span><span class="n">alphas_cumprod</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
<a id="__codelineno-29-44" name="__codelineno-29-44"></a>                                                                                   <span class="n">ddim_timesteps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddim_timesteps</span><span class="p">,</span>
<a id="__codelineno-29-45" name="__codelineno-29-45"></a>                                                                                   <span class="n">eta</span><span class="o">=</span><span class="n">ddim_eta</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-29-46" name="__codelineno-29-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'ddim_sigmas'</span><span class="p">,</span> <span class="n">ddim_sigmas</span><span class="p">)</span>
<a id="__codelineno-29-47" name="__codelineno-29-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'ddim_alphas'</span><span class="p">,</span> <span class="n">ddim_alphas</span><span class="p">)</span>
<a id="__codelineno-29-48" name="__codelineno-29-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'ddim_alphas_prev'</span><span class="p">,</span> <span class="n">ddim_alphas_prev</span><span class="p">)</span>
<a id="__codelineno-29-49" name="__codelineno-29-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'ddim_sqrt_one_minus_alphas'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ddim_alphas</span><span class="p">))</span>
<a id="__codelineno-29-50" name="__codelineno-29-50"></a>        <span class="n">sigmas_for_original_sampling_steps</span> <span class="o">=</span> <span class="n">ddim_eta</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
<a id="__codelineno-29-51" name="__codelineno-29-51"></a>            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_cumprod_prev</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_cumprod</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
<a id="__codelineno-29-52" name="__codelineno-29-52"></a>                        <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_cumprod</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas_cumprod_prev</span><span class="p">))</span>
<a id="__codelineno-29-53" name="__codelineno-29-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">'ddim_sigmas_for_original_num_steps'</span><span class="p">,</span> <span class="n">sigmas_for_original_sampling_steps</span><span class="p">)</span>
<a id="__codelineno-29-54" name="__codelineno-29-54"></a>
<a id="__codelineno-29-55" name="__codelineno-29-55"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-29-56" name="__codelineno-29-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-29-57" name="__codelineno-29-57"></a>               <span class="n">S</span><span class="p">,</span>
<a id="__codelineno-29-58" name="__codelineno-29-58"></a>               <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-29-59" name="__codelineno-29-59"></a>               <span class="n">shape</span><span class="p">,</span>
<a id="__codelineno-29-60" name="__codelineno-29-60"></a>               <span class="n">conditioning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-61" name="__codelineno-29-61"></a>               <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-62" name="__codelineno-29-62"></a>               <span class="n">normals_sequence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-63" name="__codelineno-29-63"></a>               <span class="n">img_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-64" name="__codelineno-29-64"></a>               <span class="n">quantize_x0</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-29-65" name="__codelineno-29-65"></a>               <span class="n">eta</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
<a id="__codelineno-29-66" name="__codelineno-29-66"></a>               <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-67" name="__codelineno-29-67"></a>               <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-68" name="__codelineno-29-68"></a>               <span class="n">temperature</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
<a id="__codelineno-29-69" name="__codelineno-29-69"></a>               <span class="n">noise_dropout</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
<a id="__codelineno-29-70" name="__codelineno-29-70"></a>               <span class="n">score_corrector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-71" name="__codelineno-29-71"></a>               <span class="n">corrector_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-72" name="__codelineno-29-72"></a>               <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-29-73" name="__codelineno-29-73"></a>               <span class="n">x_T</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-74" name="__codelineno-29-74"></a>               <span class="n">log_every_t</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-29-75" name="__codelineno-29-75"></a>               <span class="n">unconditional_guidance_scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
<a id="__codelineno-29-76" name="__codelineno-29-76"></a>               <span class="n">unconditional_conditioning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-77" name="__codelineno-29-77"></a>               <span class="c1"># this has to come in the same format as the conditioning, # e.g. as encoded tokens, ...</span>
<a id="__codelineno-29-78" name="__codelineno-29-78"></a>               <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-29-79" name="__codelineno-29-79"></a>               <span class="p">):</span>
<a id="__codelineno-29-80" name="__codelineno-29-80"></a>        <span class="k">if</span> <span class="n">conditioning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-29-81" name="__codelineno-29-81"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conditioning</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-29-82" name="__codelineno-29-82"></a>                <span class="n">cbs</span> <span class="o">=</span> <span class="n">conditioning</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">conditioning</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-29-83" name="__codelineno-29-83"></a>                <span class="k">if</span> <span class="n">cbs</span> <span class="o">!=</span> <span class="n">batch_size</span><span class="p">:</span>
<a id="__codelineno-29-84" name="__codelineno-29-84"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Warning: Got </span><span class="si">{</span><span class="n">cbs</span><span class="si">}</span><span class="s2"> conditionings but batch-size is </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-29-85" name="__codelineno-29-85"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-29-86" name="__codelineno-29-86"></a>                <span class="k">if</span> <span class="n">conditioning</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">batch_size</span><span class="p">:</span>
<a id="__codelineno-29-87" name="__codelineno-29-87"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Warning: Got </span><span class="si">{</span><span class="n">conditioning</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> conditionings but batch-size is </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a id="__codelineno-29-88" name="__codelineno-29-88"></a>
<a id="__codelineno-29-89" name="__codelineno-29-89"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">make_schedule</span><span class="p">(</span><span class="n">ddim_num_steps</span><span class="o">=</span><span class="n">S</span><span class="p">,</span> <span class="n">ddim_eta</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-29-90" name="__codelineno-29-90"></a>        <span class="c1"># sampling</span>
<a id="__codelineno-29-91" name="__codelineno-29-91"></a>        <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">shape</span>
<a id="__codelineno-29-92" name="__codelineno-29-92"></a>        <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
<a id="__codelineno-29-93" name="__codelineno-29-93"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Data shape for DDIM sampling is </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">, eta </span><span class="si">{</span><span class="n">eta</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<a id="__codelineno-29-94" name="__codelineno-29-94"></a>
<a id="__codelineno-29-95" name="__codelineno-29-95"></a>        <span class="n">samples</span><span class="p">,</span> <span class="n">intermediates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddim_sampling</span><span class="p">(</span><span class="n">conditioning</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-29-96" name="__codelineno-29-96"></a>                                                    <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
<a id="__codelineno-29-97" name="__codelineno-29-97"></a>                                                    <span class="n">img_callback</span><span class="o">=</span><span class="n">img_callback</span><span class="p">,</span>
<a id="__codelineno-29-98" name="__codelineno-29-98"></a>                                                    <span class="n">quantize_denoised</span><span class="o">=</span><span class="n">quantize_x0</span><span class="p">,</span>
<a id="__codelineno-29-99" name="__codelineno-29-99"></a>                                                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span>
<a id="__codelineno-29-100" name="__codelineno-29-100"></a>                                                    <span class="n">ddim_use_original_steps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-29-101" name="__codelineno-29-101"></a>                                                    <span class="n">noise_dropout</span><span class="o">=</span><span class="n">noise_dropout</span><span class="p">,</span>
<a id="__codelineno-29-102" name="__codelineno-29-102"></a>                                                    <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
<a id="__codelineno-29-103" name="__codelineno-29-103"></a>                                                    <span class="n">score_corrector</span><span class="o">=</span><span class="n">score_corrector</span><span class="p">,</span>
<a id="__codelineno-29-104" name="__codelineno-29-104"></a>                                                    <span class="n">corrector_kwargs</span><span class="o">=</span><span class="n">corrector_kwargs</span><span class="p">,</span>
<a id="__codelineno-29-105" name="__codelineno-29-105"></a>                                                    <span class="n">x_T</span><span class="o">=</span><span class="n">x_T</span><span class="p">,</span>
<a id="__codelineno-29-106" name="__codelineno-29-106"></a>                                                    <span class="n">log_every_t</span><span class="o">=</span><span class="n">log_every_t</span><span class="p">,</span>
<a id="__codelineno-29-107" name="__codelineno-29-107"></a>                                                    <span class="n">unconditional_guidance_scale</span><span class="o">=</span><span class="n">unconditional_guidance_scale</span><span class="p">,</span>
<a id="__codelineno-29-108" name="__codelineno-29-108"></a>                                                    <span class="n">unconditional_conditioning</span><span class="o">=</span><span class="n">unconditional_conditioning</span><span class="p">,</span>
<a id="__codelineno-29-109" name="__codelineno-29-109"></a>                                                    <span class="p">)</span>
<a id="__codelineno-29-110" name="__codelineno-29-110"></a>        <span class="k">return</span> <span class="n">samples</span><span class="p">,</span> <span class="n">intermediates</span>
<a id="__codelineno-29-111" name="__codelineno-29-111"></a>
<a id="__codelineno-29-112" name="__codelineno-29-112"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-29-113" name="__codelineno-29-113"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ddim_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span>
<a id="__codelineno-29-114" name="__codelineno-29-114"></a>                      <span class="n">x_T</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddim_use_original_steps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-29-115" name="__codelineno-29-115"></a>                      <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timesteps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quantize_denoised</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-29-116" name="__codelineno-29-116"></a>                      <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_every_t</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-29-117" name="__codelineno-29-117"></a>                      <span class="n">temperature</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">noise_dropout</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">score_corrector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">corrector_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-118" name="__codelineno-29-118"></a>                      <span class="n">unconditional_guidance_scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">unconditional_conditioning</span><span class="o">=</span><span class="kc">None</span><span class="p">,):</span>
<a id="__codelineno-29-119" name="__codelineno-29-119"></a>        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">betas</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-29-120" name="__codelineno-29-120"></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-29-121" name="__codelineno-29-121"></a>        <span class="k">if</span> <span class="n">x_T</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-29-122" name="__codelineno-29-122"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-29-123" name="__codelineno-29-123"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-29-124" name="__codelineno-29-124"></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">x_T</span>
<a id="__codelineno-29-125" name="__codelineno-29-125"></a>
<a id="__codelineno-29-126" name="__codelineno-29-126"></a>        <span class="k">if</span> <span class="n">timesteps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-29-127" name="__codelineno-29-127"></a>            <span class="n">timesteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddpm_num_timesteps</span> <span class="k">if</span> <span class="n">ddim_use_original_steps</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddim_timesteps</span>
<a id="__codelineno-29-128" name="__codelineno-29-128"></a>        <span class="k">elif</span> <span class="n">timesteps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ddim_use_original_steps</span><span class="p">:</span>
<a id="__codelineno-29-129" name="__codelineno-29-129"></a>            <span class="n">subset_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">timesteps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddim_timesteps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddim_timesteps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-29-130" name="__codelineno-29-130"></a>            <span class="n">timesteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddim_timesteps</span><span class="p">[:</span><span class="n">subset_end</span><span class="p">]</span>
<a id="__codelineno-29-131" name="__codelineno-29-131"></a>
<a id="__codelineno-29-132" name="__codelineno-29-132"></a>        <span class="n">intermediates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'x_inter'</span><span class="p">:</span> <span class="p">[</span><span class="n">img</span><span class="p">],</span> <span class="s1">'pred_x0'</span><span class="p">:</span> <span class="p">[</span><span class="n">img</span><span class="p">]}</span>
<a id="__codelineno-29-133" name="__codelineno-29-133"></a>        <span class="n">time_range</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">timesteps</span><span class="p">))</span> <span class="k">if</span> <span class="n">ddim_use_original_steps</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">timesteps</span><span class="p">)</span>
<a id="__codelineno-29-134" name="__codelineno-29-134"></a>        <span class="n">total_steps</span> <span class="o">=</span> <span class="n">timesteps</span> <span class="k">if</span> <span class="n">ddim_use_original_steps</span> <span class="k">else</span> <span class="n">timesteps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-29-135" name="__codelineno-29-135"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Running DDIM Sampling with </span><span class="si">{</span><span class="n">total_steps</span><span class="si">}</span><span class="s2"> timesteps"</span><span class="p">)</span>
<a id="__codelineno-29-136" name="__codelineno-29-136"></a>
<a id="__codelineno-29-137" name="__codelineno-29-137"></a>        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">time_range</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">'DDIM Sampler'</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total_steps</span><span class="p">)</span>
<a id="__codelineno-29-138" name="__codelineno-29-138"></a>
<a id="__codelineno-29-139" name="__codelineno-29-139"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
<a id="__codelineno-29-140" name="__codelineno-29-140"></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">total_steps</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-29-141" name="__codelineno-29-141"></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b</span><span class="p">,),</span> <span class="n">step</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
<a id="__codelineno-29-142" name="__codelineno-29-142"></a>
<a id="__codelineno-29-143" name="__codelineno-29-143"></a>            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-29-144" name="__codelineno-29-144"></a>                <span class="k">assert</span> <span class="n">x0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-29-145" name="__codelineno-29-145"></a>                <span class="n">img_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">q_sample</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>  <span class="c1"># TODO: deterministic forward pass?</span>
<a id="__codelineno-29-146" name="__codelineno-29-146"></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">img_orig</span> <span class="o">*</span> <span class="n">mask</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">mask</span><span class="p">)</span> <span class="o">*</span> <span class="n">img</span>
<a id="__codelineno-29-147" name="__codelineno-29-147"></a>
<a id="__codelineno-29-148" name="__codelineno-29-148"></a>            <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_sample_ddim</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">use_original_steps</span><span class="o">=</span><span class="n">ddim_use_original_steps</span><span class="p">,</span>
<a id="__codelineno-29-149" name="__codelineno-29-149"></a>                                      <span class="n">quantize_denoised</span><span class="o">=</span><span class="n">quantize_denoised</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
<a id="__codelineno-29-150" name="__codelineno-29-150"></a>                                      <span class="n">noise_dropout</span><span class="o">=</span><span class="n">noise_dropout</span><span class="p">,</span> <span class="n">score_corrector</span><span class="o">=</span><span class="n">score_corrector</span><span class="p">,</span>
<a id="__codelineno-29-151" name="__codelineno-29-151"></a>                                      <span class="n">corrector_kwargs</span><span class="o">=</span><span class="n">corrector_kwargs</span><span class="p">,</span>
<a id="__codelineno-29-152" name="__codelineno-29-152"></a>                                      <span class="n">unconditional_guidance_scale</span><span class="o">=</span><span class="n">unconditional_guidance_scale</span><span class="p">,</span>
<a id="__codelineno-29-153" name="__codelineno-29-153"></a>                                      <span class="n">unconditional_conditioning</span><span class="o">=</span><span class="n">unconditional_conditioning</span><span class="p">)</span>
<a id="__codelineno-29-154" name="__codelineno-29-154"></a>            <span class="n">img</span><span class="p">,</span> <span class="n">pred_x0</span> <span class="o">=</span> <span class="n">outs</span>
<a id="__codelineno-29-155" name="__codelineno-29-155"></a>            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-29-156" name="__codelineno-29-156"></a>            <span class="k">if</span> <span class="n">img_callback</span><span class="p">:</span> <span class="n">img_callback</span><span class="p">(</span><span class="n">pred_x0</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<a id="__codelineno-29-157" name="__codelineno-29-157"></a>
<a id="__codelineno-29-158" name="__codelineno-29-158"></a>            <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="n">log_every_t</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">==</span> <span class="n">total_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-29-159" name="__codelineno-29-159"></a>                <span class="n">intermediates</span><span class="p">[</span><span class="s1">'x_inter'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<a id="__codelineno-29-160" name="__codelineno-29-160"></a>                <span class="n">intermediates</span><span class="p">[</span><span class="s1">'pred_x0'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred_x0</span><span class="p">)</span>
<a id="__codelineno-29-161" name="__codelineno-29-161"></a>
<a id="__codelineno-29-162" name="__codelineno-29-162"></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">intermediates</span>
<a id="__codelineno-29-163" name="__codelineno-29-163"></a>
<a id="__codelineno-29-164" name="__codelineno-29-164"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-29-165" name="__codelineno-29-165"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">p_sample_ddim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">repeat_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_original_steps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quantize_denoised</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-29-166" name="__codelineno-29-166"></a>                      <span class="n">temperature</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">noise_dropout</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">score_corrector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">corrector_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-29-167" name="__codelineno-29-167"></a>                      <span class="n">unconditional_guidance_scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">unconditional_conditioning</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-29-168" name="__codelineno-29-168"></a>        <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-29-169" name="__codelineno-29-169"></a>
<a id="__codelineno-29-170" name="__codelineno-29-170"></a>        <span class="k">if</span> <span class="n">unconditional_conditioning</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">unconditional_guidance_scale</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
<a id="__codelineno-29-171" name="__codelineno-29-171"></a>            <span class="n">e_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">apply_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-29-172" name="__codelineno-29-172"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-29-173" name="__codelineno-29-173"></a>            <span class="n">x_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-29-174" name="__codelineno-29-174"></a>            <span class="n">t_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-29-175" name="__codelineno-29-175"></a>            <span class="n">c_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">unconditional_conditioning</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
<a id="__codelineno-29-176" name="__codelineno-29-176"></a>            <span class="n">e_t_uncond</span><span class="p">,</span> <span class="n">e_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">apply_model</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">t_in</span><span class="p">,</span> <span class="n">c_in</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-29-177" name="__codelineno-29-177"></a>            <span class="n">e_t</span> <span class="o">=</span> <span class="n">e_t_uncond</span> <span class="o">+</span> <span class="n">unconditional_guidance_scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">e_t</span> <span class="o">-</span> <span class="n">e_t_uncond</span><span class="p">)</span>
<a id="__codelineno-29-178" name="__codelineno-29-178"></a>
<a id="__codelineno-29-179" name="__codelineno-29-179"></a>        <span class="k">if</span> <span class="n">score_corrector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-29-180" name="__codelineno-29-180"></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">==</span> <span class="s2">"eps"</span>
<a id="__codelineno-29-181" name="__codelineno-29-181"></a>            <span class="n">e_t</span> <span class="o">=</span> <span class="n">score_corrector</span><span class="o">.</span><span class="n">modify_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">e_t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">**</span><span class="n">corrector_kwargs</span><span class="p">)</span>
<a id="__codelineno-29-182" name="__codelineno-29-182"></a>
<a id="__codelineno-29-183" name="__codelineno-29-183"></a>        <span class="n">alphas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">alphas_cumprod</span> <span class="k">if</span> <span class="n">use_original_steps</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddim_alphas</span>
<a id="__codelineno-29-184" name="__codelineno-29-184"></a>        <span class="n">alphas_prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">alphas_cumprod_prev</span> <span class="k">if</span> <span class="n">use_original_steps</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddim_alphas_prev</span>
<a id="__codelineno-29-185" name="__codelineno-29-185"></a>        <span class="n">sqrt_one_minus_alphas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sqrt_one_minus_alphas_cumprod</span> <span class="k">if</span> <span class="n">use_original_steps</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddim_sqrt_one_minus_alphas</span>
<a id="__codelineno-29-186" name="__codelineno-29-186"></a>        <span class="n">sigmas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ddim_sigmas_for_original_num_steps</span> <span class="k">if</span> <span class="n">use_original_steps</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddim_sigmas</span>
<a id="__codelineno-29-187" name="__codelineno-29-187"></a>        <span class="c1"># select parameters corresponding to the currently considered timestep</span>
<a id="__codelineno-29-188" name="__codelineno-29-188"></a>        <span class="n">a_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">alphas</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-29-189" name="__codelineno-29-189"></a>        <span class="n">a_prev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">alphas_prev</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-29-190" name="__codelineno-29-190"></a>        <span class="n">sigma_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-29-191" name="__codelineno-29-191"></a>        <span class="n">sqrt_one_minus_at</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">sqrt_one_minus_alphas</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-29-192" name="__codelineno-29-192"></a>
<a id="__codelineno-29-193" name="__codelineno-29-193"></a>        <span class="c1"># current prediction for x_0</span>
<a id="__codelineno-29-194" name="__codelineno-29-194"></a>        <span class="n">pred_x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">sqrt_one_minus_at</span> <span class="o">*</span> <span class="n">e_t</span><span class="p">)</span> <span class="o">/</span> <span class="n">a_t</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
<a id="__codelineno-29-195" name="__codelineno-29-195"></a>        <span class="k">if</span> <span class="n">quantize_denoised</span><span class="p">:</span>
<a id="__codelineno-29-196" name="__codelineno-29-196"></a>            <span class="n">pred_x0</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">first_stage_model</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">pred_x0</span><span class="p">)</span>
<a id="__codelineno-29-197" name="__codelineno-29-197"></a>        <span class="c1"># direction pointing to x_t</span>
<a id="__codelineno-29-198" name="__codelineno-29-198"></a>        <span class="n">dir_xt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">a_prev</span> <span class="o">-</span> <span class="n">sigma_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <span class="n">e_t</span>
<a id="__codelineno-29-199" name="__codelineno-29-199"></a>        <span class="n">noise</span> <span class="o">=</span> <span class="n">sigma_t</span> <span class="o">*</span> <span class="n">noise_like</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">repeat_noise</span><span class="p">)</span> <span class="o">*</span> <span class="n">temperature</span>
<a id="__codelineno-29-200" name="__codelineno-29-200"></a>        <span class="k">if</span> <span class="n">noise_dropout</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
<a id="__codelineno-29-201" name="__codelineno-29-201"></a>            <span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">noise_dropout</span><span class="p">)</span>
<a id="__codelineno-29-202" name="__codelineno-29-202"></a>        <span class="n">x_prev</span> <span class="o">=</span> <span class="n">a_prev</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <span class="n">pred_x0</span> <span class="o">+</span> <span class="n">dir_xt</span> <span class="o">+</span> <span class="n">noise</span>
<a id="__codelineno-29-203" name="__codelineno-29-203"></a>        <span class="k">return</span> <span class="n">x_prev</span><span class="p">,</span> <span class="n">pred_x0</span>
</code></pre></div></td></tr></tbody></table></div>
<p>In DDIM (Denoising Diffusion Implicit Models), the reverse (denoising) step from <span class="arithmatex">\(x_t\)</span> to <span class="arithmatex">\(x_{t-1}\)</span> is given by:</p>
<ol>
<li><strong>Predicting <span class="arithmatex">\(x_0\)</span>:</strong></li>
</ol>
<p>$$
   \hat{x}<em>0 = \frac{x_t - \sqrt{1-\bar{\alpha}_t}\,\epsilon</em>\theta(x_t,t)}{\sqrt{\bar{\alpha}_t}},
   $$</p>
<p>where:
   - <span class="arithmatex">\(x_t\)</span> is the current noisy image.
   - <span class="arithmatex">\(\epsilon_\theta(x_t,t)\)</span> is the models predicted noise.
   - <span class="arithmatex">\(\bar{\alpha}_t\)</span> is the cumulative product of the <span class="arithmatex">\(\alpha\)</span> values up to time <span class="arithmatex">\(t\)</span>.</p>
<ol>
<li><strong>Computing the DDIM Update:</strong></li>
</ol>
<p>$$
   x_{t-1} = \sqrt{\bar{\alpha}<em t-1="t-1">{t-1}}\,\hat{x}_0 + \sqrt{1-\bar{\alpha}</em>(0,I),
   $$} - \sigma_t^2}\,\epsilon_\theta(x_t,t) + \sigma_t\,z,\quad z\sim\mathcal{N</p>
<p>where:
   - <span class="arithmatex">\(\sqrt{\bar{\alpha}_{t-1}}\)</span> scales the predicted <span class="arithmatex">\(x_0\)</span>.
   - <span class="arithmatex">\(\sqrt{1-\bar{\alpha}_{t-1} - \sigma_t^2}\)</span> scales the noise prediction.
   - <span class="arithmatex">\(\sigma_t\)</span> (controlled via the parameter <span class="arithmatex">\(\eta\)</span>) governs the stochasticity; if <span class="arithmatex">\(\sigma_t=0\)</span> (i.e. <span class="arithmatex">\(\eta=0\)</span>), the process is deterministic.
   - <span class="arithmatex">\(z\)</span> is standard Gaussian noise.</p>
<p>The code implements this DDIM denoising process primarily in the function <code>p_sample_ddim</code>. Lets break down the correspondence:</p>
<ol>
<li>
<p><strong>Prediction of <span class="arithmatex">\(x_0\)</span>:</strong></p>
</li>
<li>
<p><strong>Theoretical Formula:</strong>
     $$
     \hat{x}<em>0 = \frac{x_t - \sqrt{1-\bar{\alpha}_t}\,\epsilon</em>\theta(x_t,t)}{\sqrt{\bar{\alpha}_t}}
     $$</p>
</li>
<li>
<p><strong>Code:</strong></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="n">pred_x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">sqrt_one_minus_at</span> <span class="o">*</span> <span class="n">e_t</span><span class="p">)</span> <span class="o">/</span> <span class="n">a_t</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li>Here, <code>x</code> represents <span class="arithmatex">\(x_t\)</span>.</li>
<li><code>e_t</code> is the models noise prediction <span class="arithmatex">\(\epsilon_\theta(x,t)\)</span>.</li>
<li><code>a_t</code> holds the value of <span class="arithmatex">\(\bar{\alpha}_t\)</span> (so that <code>a_t.sqrt()</code> is <span class="arithmatex">\(\sqrt{\bar{\alpha}_t}\)</span>).</li>
<li><code>sqrt_one_minus_at</code> represents <span class="arithmatex">\(\sqrt{1-\bar{\alpha}_t}\)</span>.</li>
</ul>
</li>
<li>
<p><strong>Computing the Direction Term:</strong></p>
</li>
<li>
<p><strong>Theoretical Term:</strong>
     <span class="arithmatex">\(\sqrt{1-\bar{\alpha}_{t-1} - \sigma_t^2}\,\epsilon_\theta(x_t,t)\)</span></p>
</li>
<li>
<p><strong>Code:</strong></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="n">dir_xt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">a_prev</span> <span class="o">-</span> <span class="n">sigma_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <span class="n">e_t</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li><code>a_prev</code> corresponds to <span class="arithmatex">\(\bar{\alpha}_{t-1}\)</span> (so that <code>a_prev.sqrt()</code> is <span class="arithmatex">\(\sqrt{\bar{\alpha}_{t-1}}\)</span>).</li>
<li><code>sigma_t</code> is the standard deviation <span class="arithmatex">\(\sigma_t\)</span> at time <span class="arithmatex">\(t\)</span>.</li>
<li>This computes the directional component by scaling the predicted noise <span class="arithmatex">\(e_t\)</span>.</li>
</ul>
</li>
<li>
<p><strong>Adding the Noise Term and Forming <span class="arithmatex">\(x_{t-1}\)</span>:</strong></p>
</li>
<li>
<p><strong>Theoretical Formula:</strong>
     $$
     x_{t-1} = \sqrt{\bar{\alpha}<em t-1="t-1">{t-1}}\,\hat{x}_0 + \sqrt{1-\bar{\alpha}</em>\,\epsilon_\theta(x_t,t) + \sigma_t\,z
     $$} - \sigma_t^2</p>
</li>
<li>
<p><strong>Code:</strong></p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="n">noise</span> <span class="o">=</span> <span class="n">sigma_t</span> <span class="o">*</span> <span class="n">noise_like</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">repeat_noise</span><span class="p">)</span> <span class="o">*</span> <span class="n">temperature</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="n">x_prev</span> <span class="o">=</span> <span class="n">a_prev</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <span class="n">pred_x0</span> <span class="o">+</span> <span class="n">dir_xt</span> <span class="o">+</span> <span class="n">noise</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li><code>a_prev.sqrt() * pred_x0</code> implements the <span class="arithmatex">\(\sqrt{\bar{\alpha}_{t-1}}\,\hat{x}_0\)</span> term.</li>
<li><code>dir_xt</code> is the directional term.</li>
<li>The variable <code>noise</code> represents <span class="arithmatex">\(\sigma_t\,z\)</span>, where <code>noise_like(...)</code> samples from a standard Gaussian distribution.</li>
<li>The <code>temperature</code> parameter can further modulate the noise level.</li>
</ul>
</li>
<li>
<p><strong>Handling Conditioning and Guidance (Optional):</strong></p>
</li>
<li>
<p>The code also includes conditional sampling and guidance:</p>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span>
<span class="normal"><a href="#__codelineno-33-2">2</a></span>
<span class="normal"><a href="#__codelineno-33-3">3</a></span>
<span class="normal"><a href="#__codelineno-33-4">4</a></span>
<span class="normal"><a href="#__codelineno-33-5">5</a></span>
<span class="normal"><a href="#__codelineno-33-6">6</a></span>
<span class="normal"><a href="#__codelineno-33-7">7</a></span>
<span class="normal"><a href="#__codelineno-33-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="k">if</span> <span class="n">unconditional_conditioning</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">unconditional_guidance_scale</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a>    <span class="n">e_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">apply_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a>    <span class="n">x_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a>    <span class="n">t_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a>    <span class="n">c_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">unconditional_conditioning</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
<a id="__codelineno-33-7" name="__codelineno-33-7"></a>    <span class="n">e_t_uncond</span><span class="p">,</span> <span class="n">e_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">apply_model</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="n">t_in</span><span class="p">,</span> <span class="n">c_in</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-33-8" name="__codelineno-33-8"></a>    <span class="n">e_t</span> <span class="o">=</span> <span class="n">e_t_uncond</span> <span class="o">+</span> <span class="n">unconditional_guidance_scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">e_t</span> <span class="o">-</span> <span class="n">e_t_uncond</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li>This branch adjusts the noise prediction <span class="arithmatex">\(e_t\)</span> to steer the generation process in conditional settings. Although not part of the base DDIM equations, it is a common extension for improving sample quality.</li>
</ul>
</li>
<li>
<p><strong>DDIM Timesteps and Schedule:</strong></p>
</li>
<li>
<p>The function <code>make_schedule</code> precomputes the necessary parameters (such as <code>ddim_alphas</code>, <code>ddim_alphas_prev</code>, <code>ddim_sigmas</code>, etc.) based on the chosen DDIM discretization schedule.</p>
</li>
<li>These parameters represent the cumulative products <span class="arithmatex">\(\bar{\alpha}_t\)</span> and their variants, ensuring that the updates in <code>p_sample_ddim</code> use the correct coefficients at each timestep.</li>
</ol>
<p>In summary</p>
<ul>
<li><strong>Prediction of <span class="arithmatex">\(x_0\)</span>:</strong>
  The code computes
  $$
  \hat{x}<em>0 = \frac{x_t - \sqrt{1-\bar{\alpha}_t}\,\epsilon</em>\theta(x_t,t)}{\sqrt{\bar{\alpha}_t}}
  $$
  via</li>
</ul>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="n">pred_x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">sqrt_one_minus_at</span> <span class="o">*</span> <span class="n">e_t</span><span class="p">)</span> <span class="o">/</span> <span class="n">a_t</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li><strong>Directional Component and Noise Addition:</strong>
  The update for <span class="arithmatex">\(x_{t-1}\)</span> is given by
  $$
  x_{t-1} = \sqrt{\bar{\alpha}<em t-1="t-1">{t-1}}\,\hat{x}_0 + \sqrt{1-\bar{\alpha}</em>\,\epsilon_\theta(x_t,t) + \sigma_t\,z,
  $$
  which is implemented as:} - \sigma_t^2</li>
</ul>
<div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span>
<span class="normal"><a href="#__codelineno-35-2">2</a></span>
<span class="normal"><a href="#__codelineno-35-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="n">dir_xt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">a_prev</span> <span class="o">-</span> <span class="n">sigma_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <span class="n">e_t</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="n">noise</span> <span class="o">=</span> <span class="n">sigma_t</span> <span class="o">*</span> <span class="n">noise_like</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">repeat_noise</span><span class="p">)</span> <span class="o">*</span> <span class="n">temperature</span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="n">x_prev</span> <span class="o">=</span> <span class="n">a_prev</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="o">*</span> <span class="n">pred_x0</span> <span class="o">+</span> <span class="n">dir_xt</span> <span class="o">+</span> <span class="n">noise</span>
</code></pre></div></td></tr></tbody></table></div>
<ul>
<li>
<p><strong>Control of Stochasticity:</strong>
  The parameter <span class="arithmatex">\(\eta\)</span> (used when creating <code>ddim_sigmas</code>) controls <span class="arithmatex">\(\sigma_t\)</span>. When <span class="arithmatex">\(\eta=0\)</span>, <span class="arithmatex">\(\sigma_t=0\)</span> and the process is deterministic.</p>
</li>
<li>
<p><strong>Additional Conditioning:</strong>
  The code includes mechanisms for conditional generation and classifier-free guidance, which modify the noise prediction before performing the update.</p>
</li>
</ul>
<p>This detailed comparison shows how the DDIM denoising process in the code mirrors the theoretical formulas, translating the mathematical update steps into practical sampling operations.</p>









  






<script type="application/json" class="js-hypothesis-config">
{
  "openSidebar": false,
  "showHighlights": true,
  "theme": "clean"
}
</script>
<script async src="https://hypothes.is/embed.js"></script>

<!-- Hypothesis  -->
<style>
  /*  */
  .hypothesis-highlight {
    background-color: transparent !important; /*  */
    text-decoration: underline !important;
    text-decoration-color: #4285f4 !important;
    text-decoration-thickness: 2px !important;
    text-decoration-style: wavy !important;
    position: relative !important;
    cursor: pointer !important;
    border-bottom: none !important; /*  */
    box-shadow: none !important; /*  */
  }

  .hypothesis-highlight::after {
    content: "" !important;
    position: absolute !important;
    display: inline-block !important;
    font-size: 14px !important;
    top: -10px !important;
    right: -5px !important;
    opacity: 0.7 !important;
    transition: opacity 0.3s ease !important;
  }

  .hypothesis-highlight:hover {
    background-color: rgba(66, 133, 244, 0.08) !important; /*  */
  }

  .hypothesis-highlight:hover::after {
    opacity: 1 !important;
    transform: scale(1.2) !important;
  }

  /*  Hypothesis  */
  hypothesis-sidebar {
    font-family: var(--md-text-font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif) !important;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1) !important;
  }

  /*  */
  .hypothesis-annotation-card {
    border-radius: 8px !important;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05) !important;
    transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    overflow: hidden !important;
  }

  .hypothesis-annotation-card:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
  }

  /*  Hypothesis  */
  .hypothesis-button {
    border-radius: 4px !important;
    transition: background-color 0.2s ease !important;
  }

  /*  */
  .hypothesis-tag {
    border-radius: 12px !important;
    padding: 2px 8px !important;
    font-size: 12px !important;
    background-color: rgba(0, 0, 0, 0.05) !important;
    color: #606060 !important;
  }

  /*  */
  .hypothesis-toolbar {
    background: linear-gradient(to right, #f5f5f5, #ffffff) !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
  }

  /* header */
  .hypothesis-annotation-header {
    padding: 10px !important;
    background-color: #f9f9f9 !important;
  }

  /*  */
  .hypothesis-annotation-body {
    font-size: 14px !important;
    line-height: 1.6 !important;
    color: #333 !important;
  }

  /*  */
  .hypothesis-user {
    font-weight: 600 !important;
    color: #3f51b5 !important;
  }

  /*  */
  .hypothesis-timestamp {
    font-size: 12px !important;
    color: #757575 !important;
  }

  /*  */
  .hypothesis-input {
    border-radius: 4px !important;
    border: 1px solid #e0e0e0 !important;
    transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
  }

  .hypothesis-input:focus {
    border-color: #4dabf7 !important;
    box-shadow: 0 0 0 2px rgba(77, 171, 247, 0.2) !important;
    outline: none !important;
  }
</style>

<!--  -->
<div class="comments-container utterances-container">
  <div class="comments-header">
    <h2 id="__comments" class="comments-title">
      <span class="comments-icon"></span>
      Comments
      <span class="comments-subtitle">Share your thoughts!</span>
    </h2>
    <div class="comments-divider"></div>
  </div>

  <div class="comments-wrapper">
    <script src="https://utteranc.es/client.js" repo="MAD-SG/generative-ai-start-to-surrender" issue-term="pathname" label="comment" theme="preferred-color-scheme" crossorigin="anonymous" async>
    </script>
  </div>
</div>

<style>
  .comments-container {
    margin: 2.5rem auto;
    padding: 1.5rem;
    background: var(--md-code-bg-color, rgba(0, 0, 0, 0.05));
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .annotation-container {
    margin-bottom: 1rem;
    background: rgba(255, 255, 240, 0.5);
    border-left: 4px solid #ffeb3b;
  }

  .utterances-container {
    background: rgba(240, 248, 255, 0.5);
    border-left: 4px solid #2196f3;
  }

  .comments-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
  }

  .comments-header {
    margin-bottom: 1.5rem;
  }

  .comments-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0;
    margin-bottom: 0.75rem;
    color: var(--md-primary-fg-color, #2196f3);
    flex-wrap: wrap;
  }

  .annotation-container .comments-title {
    color: #f57c00;
  }

  .comments-icon {
    font-size: 1.4em;
  }

  .comments-subtitle {
    font-size: 0.7em;
    font-weight: 400;
    opacity: 0.8;
    margin-left: 1rem;
  }

  .comments-divider {
    height: 3px;
    background: linear-gradient(90deg,
      var(--md-primary-fg-color, #2196f3) 0%,
      rgba(255, 255, 255, 0) 100%);
    border-radius: 3px;
    margin-bottom: 1rem;
    width: 100%;
  }

  .annotation-container .comments-divider {
    background: linear-gradient(90deg,
      #f57c00 0%,
      rgba(255, 255, 255, 0) 100%);
  }

  .comments-wrapper {
    position: relative;
    min-height: 150px;
    width: 100%;
  }

  .hypothesis-instructions {
    padding: 1rem;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 6px;
    margin-bottom: 1rem;
  }

  .hypothesis-instructions p {
    margin-top: 0;
    font-weight: 500;
  }

  .hypothesis-instructions ol {
    margin-bottom: 0;
    padding-left: 1.5rem;
  }

  .hypothesis-instructions li {
    margin-bottom: 0.5rem;
  }

  .hypothesis-instructions li:last-child {
    margin-bottom: 0;
  }

  /* utterancesiframe */
  .utterances-container .comments-wrapper iframe {
    border-radius: 6px;
    width: 100% !important;
    max-width: 100% !important;
  }

  /*  */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translate3d(0, 20px, 0);
    }
    to {
      opacity: 1;
      transform: translate3d(0, 0, 0);
    }
  }

  .comments-wrapper {
    animation: fadeInUp 0.6s ease forwards;
  }

  /*  -  */
  @media (max-width: 768px) {
    .comments-container {
      padding: 1rem;
      margin: 1.5rem auto;
    }

    .comments-title {
      font-size: 1.3rem;
    }

    .comments-subtitle {
      display: block;
      width: 100%;
      margin-left: 0;
      margin-top: 0.3rem;
    }
  }
</style>
                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../ldm/" class="md-footer__link md-footer__link--prev" aria-label="Previous: LDM">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                LDM
              </div>
            </div>
          </a>
        
        
          
          <a href="../diffusion_model_varients/" class="md-footer__link md-footer__link--next" aria-label="Next: Diffusion Model Varients">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Diffusion Model Varients
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://mad-sg.github.io/generative-ai-start-to-surrender/" target="_blank" rel="noopener" title="mad-sg.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://hub.docker.com/r/squidfunk/mkdocs-material/" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/mkdocs-material/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://bsky.app/profile/squidfunk.bsky.social" target="_blank" rel="noopener" title="bsky.app" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M407.8 294.7c-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3M288 227.1c-26.1-50.7-97.1-145.2-163.1-191.8C61.6-9.4 37.5-1.7 21.6 5.5 3.3 13.8 0 41.9 0 58.4S9.1 194 15 213.9c19.5 65.7 89.1 87.9 153.2 80.7 3.3-.5 6.6-.9 10-1.4-3.3.5-6.6 1-10 1.4-93.9 14-177.3 48.2-67.9 169.9C220.6 589.1 265.1 437.8 288 361.1c22.9 76.7 49.2 222.5 185.6 103.4 102.4-103.4 28.1-156-65.8-169.9-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3 64.1 7.1 133.6-15.1 153.2-80.7C566.9 194 576 75 576 58.4s-3.3-44.7-21.6-52.9c-15.8-7.1-40-14.9-103.2 29.8C385.1 81.9 314.1 176.4 288 227.1"></path></svg>
    </a>
  
    
    
      
    
    
    
      
      
    
    <a href="https://fosstodon.org/@squidfunk" target="_blank" rel="noopener me" title="fosstodon.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M433 179.1c0-97.2-63.7-125.7-63.7-125.7-62.5-28.7-228.6-28.4-290.5 0 0 0-63.7 28.5-63.7 125.7 0 115.7-6.6 259.4 105.6 289.1 40.5 10.7 75.3 13 103.3 11.4 50.8-2.8 79.3-18.1 79.3-18.1l-1.7-36.9s-36.3 11.4-77.1 10.1c-40.4-1.4-83-4.4-89.6-54-.6-4.6-.9-9.3-.9-13.9 85.6 20.9 158.7 9.1 178.7 6.7 56.1-6.7 105-41.3 111.2-72.9 9.8-49.8 9-121.5 9-121.5zm-75.1 125.2h-46.6V190.1c0-49.7-64-51.6-64 6.9v62.5H201V197c0-58.5-64-56.6-64-6.9v114.2H90.3c0-122.1-5.2-147.9 18.4-175 25.9-28.9 79.8-30.8 103.8 6.1l11.6 19.5 11.6-19.5c24.1-37.1 78.1-34.8 103.8-6.1 23.7 27.3 18.4 53 18.4 175"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://x.com/squidfunk" target="_blank" rel="noopener" title="x.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M357.2 48h70.6L273.6 224.2 455 464H313L201.7 318.6 74.5 464H3.8l164.9-188.5L-5.2 48h145.6l100.5 132.9zm-24.8 373.8h39.1L119.1 88h-42z"></path></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "toc.integrate", "content.code.copy", "content.code.select", "content.code.annotate", "content.tabs.link", "content.footnote.tooltips", "content.tooltips", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.expand", "search.share", "search.suggest"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.26.1/minified.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html><!-- 
<div class="comments-container annotation-container">
  <div class="comments-header">
    <h2 id="__annotations" class="comments-title">
      <span class="comments-icon"></span>
      
      <span class="comments-subtitle">!</span>
    </h2>
    <div class="comments-divider"></div>
  </div>

  <div class="comments-wrapper">
    <div class="hypothesis-instructions">
      <p><strong></strong></p>
      <ol>
        <li> <img src="https://hypothes.is/assets/images/logo.png" alt="Hypothesis" style="height: 16px; vertical-align: middle;"> </li>
        <li></li>
        <li></li>
      </ol>
    </div>
  </div>
</div> --><!--   -->